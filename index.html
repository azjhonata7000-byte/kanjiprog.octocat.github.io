<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRS Kanji Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&amp;display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            max-width: 640px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .card {
            background-color: #2d3748;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .kanji-text {
            font-size: 8rem;
            font-weight: bold;
            line-height: 1;
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .sentence-text {
            font-size: 1.5rem;
            margin-top: 1rem;
        }
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .reveal-button {
            background-color: #4a5568;
        }
        .reveal-button:hover {
            background-color: #616e81;
        }
        .easy-button {
            background-color: #48bb78;
        }
        .easy-button:hover {
            background-color: #63d390;
        }
        .hard-button {
            background-color: #f56565;
        }
        .hard-button:hover {
            background-color: #e55353;
        }
        .audio-button {
            background-color: #60a5fa;
        }
        .audio-button:hover {
            background-color: #3b82f6;
        }
        ruby rt {
            font-size: 0.8rem;
            text-align: center;
        }
        .word-explanation-list {
            margin-top: 1rem;
            padding-left: 1.5rem;
        }
        #audio-loading-text {
            display: none;
            font-size: 0.9rem;
            color: #94a3b8;
            margin-top: 0.5rem;
        }
        #loading-overlay, #add-card-modal, #card-list-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 32, 44, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #2d3748;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 500px;
            overflow-y: auto;
        }
        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #4a5568;
        }
        .card-item:last-child {
            border-bottom: none;
        }
        .highlight-kanji {
            color: #60a5fa;
            font-weight: bold;
        }
        .srs-level-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .srs-level-0 { background-color: #f56565; color: white; }
        .srs-level-1 { background-color: #f6ad55; color: white; }
        .srs-level-2 { background-color: #48bb78; color: white; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-white text-lg">Carregando dados...</p>
    </div>

    <div id="add-card-modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Adicionar Novo Card</h2>
            <div class="flex flex-col space-y-4">
                <input type="text" id="kanjiInput" placeholder="Kanji" class="p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400">
                <input type="text" id="pronunciationInput" placeholder="Pronúncia (em Hiragana)" class="p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400">
                <input type="text" id="meaningInput" placeholder="Significado (em Português)" class="p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400">
                <input type="text" id="sentenceInput" placeholder="Frase de Exemplo (em Japonês)" class="p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400">
                <button id="saveCardBtn" class="button bg-blue-500 hover:bg-blue-600">Salvar Card</button>
                <button id="generateBtn" class="button bg-green-500 hover:bg-green-600">Gerar Frase com IA</button>
                <button id="closeModalBtn" class="button bg-red-500 hover:bg-red-600">Cancelar</button>
            </div>
            <p id="statusMessage" class="mt-2 text-sm text-gray-400"></p>
        </div>
    </div>

    <div id="card-list-modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Gerenciar Cards</h2>
            <div id="cardsList" class="flex flex-col space-y-2">
                <!-- Cards will be populated here -->
            </div>
            <button id="addNewCardBtn" class="button bg-indigo-500 hover:bg-indigo-600 mt-4">Adicionar Novo Card</button>
            <button id="closeListModalBtn" class="button bg-red-500 hover:bg-red-600 mt-2">Fechar</button>
        </div>
    </div>

    <div class="container" style="display: none;">
        <!-- User ID display -->
        <p id="userIdDisplay" class="text-xs text-gray-500 text-center mb-4"></p>
        
        <div class="flex flex-col items-center">
            <div id="card" class="card text-center relative w-full">
                <p id="kanji-text" class="kanji-text" style="opacity: 0;">日</p>
                <div id="answer-container" class="mt-4" style="display: none;">
                    <p id="sentence-text" class="sentence-text">
                        <ruby>
                            <rb class="highlight-kanji">日</rb>
                            <rt>ひ</rt>
                        </ruby>
                        が
                        <ruby>
                            <rb>昇</rb>
                            <rt>のぼ</rt>
                        </ruby>
                        る。
                    </p>
                    <p id="meaning-text" class="text-sm italic mt-2 text-gray-400">O sol está nascendo.</p>
                    <p id="pronunciation-text" class="mt-2 text-sm text-gray-400">Hiragana: ひがのぼる</p>

                    <!-- New section for word explanations -->
                    <div id="word-explanation-container" class="mt-4">
                        <h3 class="text-xl font-bold text-gray-200">Palavras-chave:</h3>
                        <p id="explanation-loading-text" class="mt-2 text-sm text-gray-400" style="display: none;">Gerando explicações...</p>
                        <ul id="word-explanation-list" class="list-disc list-inside text-left">
                            <!-- Explanations will be populated here -->
                        </ul>
                    </div>

                    <button id="listenBtn" class="audio-button mt-4">Ouvir</button>
                    <p id="audio-loading-text">Carregando áudio...</p>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full mt-4">
                <div class="h-2 bg-gray-700 rounded-full">
                    <div id="progress-bar" class="h-2 bg-green-500 rounded-full transition-all duration-300 ease-in-out" style="width: 0%;"></div>
                </div>
                <p id="progress-text" class="text-right text-xs text-gray-400 mt-1">0 / 0</p>
            </div>
            <div class="mt-8 flex flex-col space-y-4 items-center">
                <div class="flex space-x-4">
                    <button id="showAnswerBtn" class="button reveal-button">Mostrar Resposta</button>
                    <button id="easyBtn" class="button easy-button" style="display: none;">Fácil</button>
                    <button id="hardBtn" class="button hard-button" style="display: none;">Difícil</button>
                </div>
                <!-- New button to manage all cards -->
                <button id="manageCardsBtn" class="button bg-indigo-500 hover:bg-indigo-600">Gerenciar Cards</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        
        // Firebase configuration from user's prompt
        const firebaseConfig = {
            apiKey: "AIzaSyAl4OJcZJlkn809EPdv7VUchU0ObuhcwHs",
            authDomain: "kanjis-b38b4.firebaseapp.com",
            projectId: "kanjis-b38b4",
            storageBucket: "kanjis-b38b4.firebasestorage.app",
            messagingSenderId: "794836504781",
            appId: "1:794836504781:web:b83d4bfb5e3b44ebda5984",
            databaseURL: "https://kanjis-b38b4-default-rtdb.firebaseio.com"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // Global variables for game state
        let cards = [];
        let currentCardIndex = 0;
        let knownCount = 0;
        let totalCards = 0;
        let userId = null;
        let isEditing = false;
        let editingIndex = -1;
        
        // DOM elements
        const kanjiText = document.getElementById('kanji-text');
        const sentenceText = document.getElementById('sentence-text');
        const meaningText = document.getElementById('meaning-text');
        const pronunciationText = document.getElementById('pronunciation-text');
        const showAnswerBtn = document.getElementById('showAnswerBtn');
        const easyBtn = document.getElementById('easyBtn');
        const hardBtn = document.getElementById('hardBtn');
        const listenBtn = document.getElementById('listenBtn');
        const answerContainer = document.getElementById('answer-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const audioLoadingText = document.getElementById('audio-loading-text');
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContainer = document.querySelector('.container');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const manageCardsBtn = document.getElementById('manageCardsBtn');
        const addCardModal = document.getElementById('add-card-modal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cardListModal = document.getElementById('card-list-modal');
        const cardsList = document.getElementById('cardsList');
        const closeListModalBtn = document.getElementById('closeListModalBtn');
        const addNewCardBtn = document.getElementById('addNewCardBtn');
        const explanationLoadingText = document.getElementById('explanation-loading-text');
        const wordExplanationList = document.getElementById('word-explanation-list');


        // Modal inputs
        const kanjiInput = document.getElementById('kanjiInput');
        const pronunciationInput = document.getElementById('pronunciationInput');
        const meaningInput = document.getElementById('meaningInput');
        const sentenceInput = document.getElementById('sentenceInput');
        const saveCardBtn = document.getElementById('saveCardBtn');
        const generateBtn = document.getElementById('generateBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Initial set of cards
        const initialCards = [
            {
                kanji: '日',
                sentence: '日が昇る。',
                meaning: 'O sol está nascendo.',
                pronunciation: 'ひがのぼる',
                srsLevel: 0,
                lastReview: 0
            },
            {
                kanji: '一',
                sentence: 'もう一度読んでください。',
                meaning: 'Por favor, leia de novo.',
                pronunciation: 'もういちどよんでください',
                srsLevel: 0,
                lastReview: 0
            },
        ];

        // Functions for Firebase
        const saveCards = async () => {
            if (userId) {
                const userCardsRef = ref(db, `users/${userId}/cards`);
                await set(userCardsRef, cards);
            }
        };

        const loadCards = async () => {
            if (userId) {
                const userCardsRef = ref(db, `users/${userId}/cards`);
                const snapshot = await get(userCardsRef);
                if (snapshot.exists()) {
                    cards = snapshot.val() || initialCards;
                } else {
                    cards = initialCards;
                    await saveCards();
                }
            } else {
                cards = initialCards;
            }
            totalCards = cards.length;
            updateProgress();
            selectCardForReview();
            loadingOverlay.style.display = 'none';
            mainContainer.style.display = 'flex';
        };

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = `User ID: ${userId}`;
                loadCards();
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Erro ao fazer login anônimo:", error);
                    addCardModal.style.display = 'flex';
                    document.querySelector('#add-card-modal .modal-content h2').textContent = 'Erro ao Carregar';
                    document.querySelector('#add-card-modal .modal-content p').textContent = 'Ocorreu um erro ao carregar o aplicativo. Por favor, tente novamente mais tarde.';
                    kanjiInput.style.display = 'none';
                    saveCardBtn.style.display = 'none';
                    closeModalBtn.textContent = 'Fechar';
                });
            }
        });

        // Function to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Function to convert PCM to WAV
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            }

            function writeUint32(value) {
                view.setUint32(offset, value, true);
                offset += 4;
            }

            function writeUint16(value) {
                view.setUint16(offset, value, true);
                offset += 2;
            }

            writeString('RIFF');
            writeUint32(36 + pcm16.byteLength);
            writeString('WAVE');
            writeString('fmt ');
            writeUint32(16);
            writeUint16(1);
            writeUint16(1);
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2);
            writeUint16(2);
            writeUint16(16);
            writeString('data');
            writeUint32(pcm16.byteLength);
            
            const pcmBytes = new Uint8Array(pcm16.buffer);
            for (let i = 0; i < pcmBytes.length; i++, offset++) {
                view.setUint8(offset, pcmBytes[i]);
            }
            
            return new Blob([view], { type: 'audio/wav' });
        }

        function updateProgress() {
            const percentage = (knownCount / totalCards) * 100;
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${knownCount} / ${totalCards}`;
        }

        function selectCardForReview() {
            // Find a new card (level 0) first
            const newCards = cards.filter(card => card.srsLevel === 0);
            if (newCards.length > 0) {
                currentCardIndex = cards.findIndex(card => card === newCards[0]);
                displayCard();
                return;
            }

            // Find a card to practice (level 1)
            const practiceCards = cards.filter(card => card.srsLevel === 1);
            if (practiceCards.length > 0) {
                currentCardIndex = cards.findIndex(card => card === practiceCards[0]);
                displayCard();
                return;
            }

            // Find an easy card to review (level 2)
            const easyCards = cards.filter(card => card.srsLevel === 2);
            if (easyCards.length > 0) {
                currentCardIndex = cards.findIndex(card => card === easyCards[0]);
                displayCard();
                return;
            }

            // No cards left to review
            kanjiText.textContent = 'Fim do baralho!';
            kanjiText.style.opacity = '1';
            answerContainer.style.display = 'none';
            showAnswerBtn.style.display = 'none';
            easyBtn.style.display = 'none';
            hardBtn.style.display = 'none';
        }

        function displayCard() {
            if (cards.length === 0) {
                 kanjiText.textContent = 'Adicione um novo card para começar!';
                 kanjiText.style.opacity = '1';
                 showAnswerBtn.style.display = 'none';
                 return;
            }
            const card = cards[currentCardIndex];
            kanjiText.textContent = card.kanji || 'N/A';
            kanjiText.style.opacity = '1';
            answerContainer.style.display = 'none';
            showAnswerBtn.style.display = 'block';
            easyBtn.style.display = 'none';
            hardBtn.style.display = 'none';
            // Clear previous explanations
            wordExplanationList.innerHTML = '';
            explanationLoadingText.style.display = 'none';
        }

        function showAnswer() {
            const card = cards[currentCardIndex];
            sentenceText.innerHTML = createRubyText(card.sentence || 'N/A', card.pronunciation || 'N/A', card.kanji || '');
            meaningText.textContent = card.meaning || 'N/A';
            pronunciationText.textContent = 'Hiragana: ' + (card.pronunciation || 'N/A');
            answerContainer.style.display = 'block';
            showAnswerBtn.style.display = 'none';
            easyBtn.style.display = 'inline-block';
            hardBtn.style.display = 'inline-block';
            generateWordExplanations(card.sentence, card.kanji);
        }

        async function generateWordExplanations(sentence, kanji) {
            explanationLoadingText.style.display = 'block';
            wordExplanationList.innerHTML = '';

            const systemPrompt = `Você é um tutor de japonês. Analise a seguinte frase em japonês e forneça o significado e a leitura em hiragana/katakana das palavras-chave. Inclua o kanji principal ("${kanji}") e as outras palavras importantes. Forneça a resposta em formato JSON como um array de objetos. Cada objeto deve ter os campos "word", "pronunciation" e "meaning".`
            const userQuery = `Frase: ${sentence}`;

            const payload = {
                contents: [{
                    parts: [{ text: userQuery }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "word": { "type": "STRING" },
                                "pronunciation": { "type": "STRING" },
                                "meaning": { "type": "STRING" }
                            },
                            "propertyOrdering": ["word", "pronunciation", "meaning"]
                        }
                    }
                }
            };
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=AIzaSyCpNSwWWEbyWhklPL96AAweF2qhjeLrWlM`;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const contentText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!contentText) {
                    throw new Error("Resposta da API vazia ou inválida.");
                }

                const explanations = JSON.parse(contentText);

                explanations.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.word} (${item.pronunciation}): ${item.meaning}`;
                    wordExplanationList.appendChild(li);
                });

            } catch (error) {
                console.error("Erro ao gerar explicações:", error);
                const li = document.createElement('li');
                li.textContent = `Erro ao carregar explicações.`;
                wordExplanationList.appendChild(li);
            } finally {
                explanationLoadingText.style.display = 'none';
            }
        }

        async function handleFeedback(isEasy) {
            const card = cards[currentCardIndex];
            if (isEasy) {
                card.srsLevel = Math.min(card.srsLevel + 1, 2);
            } else {
                card.srsLevel = 0;
            }
            card.lastReview = Date.now();
            await saveCards();
            updateProgress();
            selectCardForReview();
        }

        function createRubyText(sentence, pronunciation, kanji) {
            // Check if there is a single kanji to apply ruby tag
            if (kanji && sentence.includes(kanji)) {
                // Use a simple replacement
                const parts = sentence.split(kanji);
                return `${parts[0]}<ruby><rb class="highlight-kanji">${kanji}</rb><rt>${pronunciation}</rt></ruby>${parts[1]}`;
            }
            // If no kanji to match, return the original sentence
            return sentence;
        }


        listenBtn.addEventListener('click', () => {
            const card = cards[currentCardIndex];
            if (card.sentence) {
                audioLoadingText.style.display = 'block';
                const payload = {
                    contents: [{
                        parts: [{ text: card.sentence }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(result => {
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;

                        if (audioData && mimeType && mimeType.startsWith("audio/")) {
                            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                            const pcmData = base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData);
                            const wavBlob = pcmToWav(pcm16, sampleRate);
                            const audioUrl = URL.createObjectURL(wavBlob);
                            const audio = new Audio(audioUrl);
                            audio.play();
                            audioLoadingText.style.display = 'none';
                            audio.addEventListener('ended', () => {
                                URL.revokeObjectURL(audioUrl);
                            });
                        } else {
                            console.error('API response did not contain valid audio data.');
                            audioLoadingText.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching TTS audio:', error);
                        audioLoadingText.style.display = 'none';
                    });
            } else {
                 statusMessage.textContent = 'Áudio e frase indisponíveis para este card.';
            }
        });

        // Event listeners
        showAnswerBtn.addEventListener('click', showAnswer);
        easyBtn.addEventListener('click', () => handleFeedback(true));
        hardBtn.addEventListener('click', () => handleFeedback(false));
        
        // Modal functionality
        function showAddModal(cardIndex = -1) {
            isEditing = cardIndex !== -1;
            editingIndex = cardIndex;
            addCardModal.style.display = 'flex';
            statusMessage.textContent = '';
            kanjiInput.value = '';
            pronunciationInput.value = '';
            meaningInput.value = '';
            sentenceInput.value = '';

            if (isEditing) {
                const card = cards[editingIndex];
                kanjiInput.value = card.kanji || '';
                pronunciationInput.value = card.pronunciation || '';
                meaningInput.value = card.meaning || '';
                sentenceInput.value = card.sentence || '';
                document.querySelector('#add-card-modal h2').textContent = 'Editar Card';
            } else {
                document.querySelector('#add-card-modal h2').textContent = 'Adicionar Novo Card';
            }
        }

        function hideModal() {
            addCardModal.style.display = 'none';
        }

        async function saveCard() {
            const kanji = kanjiInput.value.trim();
            const pronunciation = pronunciationInput.value.trim();
            const meaning = meaningInput.value.trim();
            const sentence = sentenceInput.value.trim();

            if (!kanji || !pronunciation || !meaning || !sentence) {
                statusMessage.textContent = "Por favor, preencha todos os campos.";
                return;
            }

            const newCard = {
                kanji: kanji,
                pronunciation: pronunciation,
                meaning: meaning,
                sentence: sentence,
                srsLevel: 0,
                lastReview: Date.now()
            };

            if (isEditing) {
                cards[editingIndex] = newCard;
            } else {
                cards.push(newCard);
                totalCards = cards.length;
            }
            
            updateProgress();
            selectCardForReview();
            await saveCards();
            hideModal();
            renderCardsList();
        }
        
        async function generateSentence() {
            const kanji = kanjiInput.value.trim();
            
            const kanjiRegex = /[\u4e00-\u9faf]/;

            if (!kanji || !kanjiRegex.test(kanji) || kanji.length !== 1) {
                statusMessage.textContent = "Por favor, insira um único kanji válido para gerar a frase.";
                return;
            }

            generateBtn.disabled = true;
            statusMessage.textContent = "Gerando frase com IA...";
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyCpNSwWWEbyWhklPL96AAweF2qhjeLrWlM`;

            const prompt = `Crie uma frase em japonês usando o kanji "${kanji}". A frase deve ter um contexto significativo e incluir um verbo. Use apenas o kanji fornecido, com o resto da frase em hiragana e katakana. Forneça a resposta em formato JSON com três campos: "sentence" (a frase em japonês), "pronunciation" (a pronúncia da frase inteira em hiragana ou katakana) e "meaning" (o significado da frase em português).`;

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const contentText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!contentText) {
                    throw new Error("Resposta da API vazia ou inválida.");
                }
                
                const jsonMatch = contentText.match(/```json\s*([\s\S]*?)\s*```/);
                const jsonString = jsonMatch ? jsonMatch[1] : contentText;

                const generatedData = JSON.parse(jsonString);

                pronunciationInput.value = generatedData.pronunciation || '';
                meaningInput.value = generatedData.meaning || '';
                sentenceInput.value = generatedData.sentence || '';

                statusMessage.textContent = `Frase gerada com sucesso! Você pode editar os campos ou salvar.`;

            } catch (error) {
                console.error("Erro ao gerar a frase:", error);
                statusMessage.textContent = `Erro: ${error.message}`;
            } finally {
                generateBtn.disabled = false;
            }
        }

        // Functions for the card list modal
        function showManageCardsModal() {
            cardListModal.style.display = 'flex';
            renderCardsList();
        }

        function hideListModal() {
            cardListModal.style.display = 'none';
        }

        function getSrsLevelText(level) {
            switch(level) {
                case 0: return 'Novo';
                case 1: return 'Praticar';
                case 2: return 'Conhecido';
                default: return 'Desconhecido';
            }
        }

        function getSrsLevelClass(level) {
            return `srs-level-${level}`;
        }

        function renderCardsList() {
            cardsList.innerHTML = ''; // Clear the list
            if (cards.length === 0) {
                cardsList.innerHTML = '<p class="text-center text-gray-400">Nenhum card adicionado ainda.</p>';
                return;
            }

            cards.forEach((card, index) => {
                const cardItem = document.createElement('div');
                cardItem.className = 'card-item';
                
                const cardInfo = document.createElement('span');
                cardInfo.innerHTML = `${card.kanji || 'N/A'} - ${card.meaning || 'N/A'} <span class="srs-level-badge ${getSrsLevelClass(card.srsLevel)}">${getSrsLevelText(card.srsLevel)}</span>`;
                
                const actionsDiv = document.createElement('div');
                
                const editButton = document.createElement('button');
                editButton.textContent = 'Editar';
                editButton.className = 'button bg-yellow-500 hover:bg-yellow-600 text-sm px-2 py-1 mr-2';
                editButton.addEventListener('click', () => {
                    hideListModal();
                    showAddModal(index);
                });

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Deletar';
                deleteButton.className = 'button bg-red-500 hover:bg-red-600 text-sm px-2 py-1';
                deleteButton.addEventListener('click', () => {
                    if (window.confirm("Tem certeza que deseja deletar este card?")) {
                        deleteCard(index);
                    }
                });

                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);
                cardItem.appendChild(cardInfo);
                cardItem.appendChild(actionsDiv);
                cardsList.appendChild(cardItem);
            });
        }

        async function deleteCard(index) {
            cards.splice(index, 1);
            totalCards = cards.length;
            selectCardForReview();
            await saveCards();
            renderCardsList();
        }


        // Event listeners for modal
        manageCardsBtn.addEventListener('click', showManageCardsModal);
        closeModalBtn.addEventListener('click', hideModal);
        saveCardBtn.addEventListener('click', saveCard);
        generateBtn.addEventListener('click', generateSentence);
        closeListModalBtn.addEventListener('click', hideListModal);
        addNewCardBtn.addEventListener('click', () => {
            hideListModal();
            showAddModal();
        });

    </script>
</body>
</html>
