<!DOCTYPE html>
<!-- © 2024 Firefly Designer. Todos os direitos reservados. -->
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Firefly Designer">
    <title>Nihongo Master - SRS Moderno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Lexend:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- CORREÇÃO: Corrigido o URL para carregar os ícones corretamente -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Adicionado Chart.js para a nova seção de estatísticas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* © 2024 Firefly Designer. Todos os direitos reservados. */
        :root {
            /* Paleta de Cores Vibrante e Moderna */
            --bg-primary: #F9FAFB;      /* Cinza muito claro, quase branco */
            --bg-secondary: #FFFFFF;
            --bg-accent: #F4F0FF;       /* Lilás pastel para fundos de destaque */
            --text-primary: #1F2937;    /* Preto suave */
            --text-secondary: #6B7280;  /* Cinza para textos secundários */
            --accent-primary: #7C3AED;  /* Roxo vibrante (Violet-600) */
            --accent-primary-dark: #6D28D9; /* Roxo mais escuro (Violet-700) */
            --accent-primary-light: #A78BFA; /* Roxo claro (Violet-400) */
            --success: #16A34A;         /* Verde (Green-600) */
            --success-light: #D1FAE5;   /* Verde pastel (Green-100) */
            --danger: #DC2626;          /* Vermelho (Red-600) */
            --danger-light: #FEE2E2;    /* Vermelho pastel (Red-100) */
            --border-color: #E5E7EB;    /* Borda cinza clara (Gray-200) */
            
            /* Tipografia */
            --font-jp: 'Noto Sans JP', sans-serif;
            --font-ui: 'Lexend', sans-serif;

            /* Cores para Ligas */
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
            --promotion-bg: rgba(22, 163, 74, 0.1);
            --demotion-bg: rgba(220, 38, 38, 0.1);
        }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior-y: contain;
        }
        
        /* --- ESTRUTURA E LAYOUT --- */
        .main-container, .game-container, .stats-container {
            width: 100%;
            max-width: 768px;
            margin: auto;
            min-height: calc(100vh - 120px); /* Ajustado para footer */
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 1rem;
        }
        
        .stats-container {
            max-width: 1024px;
        }

        /* --- HEADER E NAVEGAÇÃO --- */
        header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 500; height: 80px;
        }
        .nav-link {
            font-weight: 500; color: var(--text-secondary);
            transition: all 0.2s; padding: 0.5rem 1rem;
            border-radius: 0.5rem; border: 2px solid transparent;
        }
        .nav-link:hover { color: var(--accent-primary); background-color: var(--bg-accent); }
        .nav-link.active {
            color: var(--accent-primary); font-weight: 700;
            border-bottom: 2px solid var(--accent-primary);
            border-radius: 0; padding-bottom: calc(0.5rem - 2px);
            background-color: transparent;
        }

        /* --- MENU MÓVEL --- */
        .nav-link-mobile {
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .nav-link-mobile:hover {
            color: var(--accent-primary);
            background-color: var(--bg-accent);
        }
        .nav-link-mobile.active {
            color: var(--accent-primary);
            font-weight: 700;
            background-color: var(--bg-accent);
        }
        #mobile-menu nav {
            overflow-y: auto; /* Permite a rolagem do menu lateral */
            flex-grow: 1;
            padding-bottom: 2rem; /* Espaço extra no final */
        }
        .caret-icon.open {
            transform: rotate(180deg);
        }


        /* --- DROPDOWNS --- */
        .dropdown { position: relative; }
        .dropdown-content {
            display: none; position: absolute; top: calc(100% + 15px); left: 50%;
            transform: translateX(-50%); background-color: var(--bg-secondary);
            min-width: 220px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            z-index: 10; border-radius: 0.75rem; padding: 0.5rem;
            border: 1px solid var(--border-color);
        }
        .dropdown-content.visible { display: block; }
        .dropdown-content a, .dropdown-content button {
            color: var(--text-primary); padding: 0.75rem 1rem; text-decoration: none;
            display: flex; align-items: center; gap: 0.5rem; border-radius: 0.5rem; font-weight: 500;
            width: 100%; text-align: left;
        }
        .dropdown-content a:hover, .dropdown-content button:hover { background-color: var(--bg-accent); color: var(--accent-primary); }
        .dropdown-content .active {
             background-color: var(--bg-accent); color: var(--accent-primary); font-weight: 700;
        }
        #user-menu-dropdown { right: 0; left: auto; transform: none; min-width: 200px; }
        
        /* --- CARD DE REVISÃO --- */
        .review-card-container { perspective: 1000px; }
        .review-card {
            background: var(--bg-secondary); border-radius: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px -2px rgba(124, 58, 237, 0.05);
            transition: transform 0.6s, box-shadow 0.3s ease;
            transform-style: preserve-3d; position: relative;
            min-height: 450px; display: flex;
        }
        .review-card.is-flipped { transform: rotateY(180deg); }

        .card-face {
            width: 100%; height: 100%; padding: 1.5rem;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: absolute; top: 0; left: 0;
        }
        .card-face-back { 
            transform: rotateY(180deg); 
            justify-content: flex-start;
            overflow-y: auto;
        }

        .question-text {
            /* ALTERAÇÃO: Aumentado o tamanho da fonte para melhor visualização em celulares */
            font-size: clamp(4rem, 18vw, 8rem);
            font-weight: 700; line-height: 1.1; text-align: center;
        }
        .question-text.jp { font-family: var(--font-jp); }
        .question-text.en { font-family: var(--font-ui); }


        .question-hint {
            font-size: 1.25rem; color: var(--text-secondary);
            margin-top: 0.5rem; text-align: center;
        }
        
        .gemini-info-section h3 {
             font-size: 0.875rem; font-weight: 700; color: var(--accent-primary);
             text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1rem;
             padding-bottom: 0.25rem; border-bottom: 2px solid var(--bg-accent);
        }
        .gemini-info-section p, .gemini-info-section li {
            font-size: 0.95rem; color: var(--text-secondary); line-height: 1.6;
        }
        .gemini-info-section ul { list-style-position: inside; padding-left: 0.5rem; }
        .gemini-info-section .sentence { margin-bottom: 0.75rem; }
        .gemini-info-section .sentence .jp { font-family: var(--font-jp); font-size: 1.2rem; color: var(--text-primary); }
        .gemini-info-section .sentence .en { font-family: var(--font-ui); font-size: 1.1rem; color: var(--text-primary); font-weight: 500;}

        .gemini-info-section .sentence .reading { font-size: 0.85rem; color: var(--text-secondary); font-style: italic;}

        /* --- BOTÕES E INTERAÇÕES --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700;
            font-size: 0.875rem; transition: all 0.2s ease-in-out;
            border: 1px solid transparent; cursor: pointer;
        }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-primary { 
            background-color: var(--accent-primary); color: white;
        }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-dark); }
        .btn-secondary { 
            background-color: var(--bg-secondary); color: var(--accent-primary);
            border: 1px solid var(--border-color);
         }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-accent); }
        .btn-success { background-color: var(--success-light); color: var(--success); border-color: #A7F3D0; }
        .btn-success:hover { background-color: #A7F3D0; }
        .btn-danger { background-color: var(--danger-light); color: var(--danger); border-color: #FECACA; }
        .btn-danger:hover { background-color: #FECACA; }
        
        .sound-btn {
            position: absolute; top: 1.5rem; right: 1.5rem;
            background: none; border: none; cursor: pointer; color: var(--text-secondary);
            padding: 0.5rem; border-radius: 50%; z-index: 10;
        }
        .sound-btn:hover { color: var(--accent-primary); background-color: var(--bg-accent); }
        .sound-btn i { font-size: 1.5rem; vertical-align: middle; }
        .sound-btn-sentence {
            background: none; border: none; cursor: pointer; color: var(--text-secondary);
            padding: 0.25rem; border-radius: 50%; flex-shrink: 0;
        }
        .sound-btn-sentence:hover { color: var(--accent-primary); background-color: var(--bg-accent); }

        /* --- TELAS DE JOGO (ALINHAMENTO MELHORADO) --- */
        .game-board { display: grid; gap: 1rem; width: 100%; }
        .game-option {
            padding: 1.5rem; /* Mais espaço interno */
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-align: center;
            font-size: clamp(1rem, 5vw, 1.25rem); /* Fonte responsiva */
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            word-break: break-word; /* Garante que o texto não saia do card */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        /* ALTERAÇÃO: Aumentado o tamanho da fonte para melhor visualização em celulares */
        .game-option.jp { font-family: var(--font-jp); font-size: 2rem; }
        .game-option:hover { 
            border-color: var(--accent-primary-light); 
            transform: scale(1.03); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .game-option.selected { background-color: var(--accent-primary-light); border-color: var(--accent-primary); color: var(--accent-primary-dark); }
        .game-option.correct { background-color: var(--success-light); color: var(--success); border-color: var(--success); cursor: not-allowed; transform: scale(1.05); animation: pulse 0.5s; }
        .game-option.incorrect { background-color: var(--danger-light); color: var(--danger); border-color: var(--danger); animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); }
        }
        @keyframes pulse {
            0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); }
        }
        
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 1rem;
        }
        @media (min-width: 420px) {
            .memory-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .memory-card {
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            aspect-ratio: 1/1;
            cursor: pointer;
            transition: transform 0.5s, box-shadow 0.3s;
            transform-style: preserve-3d;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }
        .memory-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.6rem;
            overflow: hidden;
            font-size: clamp(1rem, 5vw, 1.5rem);
        }
        .memory-card-front {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-primary-light));
        }
        .memory-card-back {
            background-color: var(--bg-accent);
            color: var(--text-primary);
            transform: rotateY(180deg);
        }
        /* ALTERAÇÃO: Aumentado o tamanho da fonte para melhor visualização em celulares */
        .memory-card .jp { font-family: var(--font-jp); font-size: clamp(2rem, 10vw, 3.5rem); }
        .memory-card.flipped {
            transform: rotateY(180deg);
        }
        .memory-card.matched {
            transform: rotateY(180deg);
            box-shadow: 0 0 15px var(--success);
            border-color: var(--success);
            cursor: not-allowed;
        }
        .memory-card.matched .memory-card-back {
            background-color: var(--success-light);
            color: var(--success);
        }
        .memory-card-gogo {
            width: 80%;
            height: 80%;
            opacity: 0.7;
        }

        /* --- TELA DE PONTOS ANIMADA --- */
        .completion-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            width: 100%;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .completion-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--success);
            animation: slideInDown 0.6s ease-out;
        }
        @keyframes slideInDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .completion-subtitle {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            animation: slideInDown 0.6s 0.2s ease-out backwards;
        }
        .score-display {
            margin-top: 2rem;
            animation: popIn 0.7s 0.4s ease-out backwards;
        }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .score-display .label {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .score-display .score-value {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            line-height: 1;
            margin-top: 0.25rem;
        }
        .score-details {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
        .completion-container .btn {
            margin-top: 2.5rem;
            animation: popIn 0.7s 0.6s ease-out backwards;
        }

        /* --- PLACAR (LIGAS) --- */
        #leaderboard-modal .modal-content {
            padding: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #DDD6FE 0%, var(--bg-primary) 30%);
            display: flex;
            flex-direction: column;
            /* Corrigido para iPhone */
            height: 90vh;
            max-height: 700px;
        }
        #gogo-chan-mascot {
            width: 120px;
            height: auto;
            margin: 0 auto;
            display: block;
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float { 
            0%, 100% { transform: translateY(0) rotate(-3deg); } 
            50% { transform: translateY(-15px) rotate(3deg); } 
        }
        @keyframes wings-flap {
            0%, 100% { transform: scaleY(1) rotate(10deg); }
            50% { transform: scaleY(0.95) rotate(8deg); }
        }
        #league-header {
            text-align: center;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            position: relative;
            flex-shrink: 0;
        }
        #close-leaderboard-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: var(--text-secondary);
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            line-height: 1;
            transition: background-color 0.2s;
        }
        #close-leaderboard-modal:hover { background: rgba(255,255,255,0.8); }
        #league-header h2 {
            font-size: clamp(1.75rem, 7vw, 2rem); /* Fonte responsiva */
            font-weight: 800;
            word-break: keep-all; /* Evita quebra de linha estranha */
        }
        #patent-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        #patent-name {
            font-size: 1.25rem;
            font-weight: 700;
        }
        #league-timer {
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        #leaderboard-list {
            padding: 0 1rem 1rem 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-grow: 1;
        }
        #leaderboard-list::-webkit-scrollbar { width: 6px; }
        #leaderboard-list::-webkit-scrollbar-track { background: transparent; }
        #leaderboard-list::-webkit-scrollbar-thumb { background: var(--accent-primary-light); border-radius: 3px; }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.75rem;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .leaderboard-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        }

        .leaderboard-item .rank {
            font-weight: 800;
            width: 2.5rem;
            text-align: center;
            flex-shrink: 0;
            color: var(--text-secondary);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .leaderboard-item .medal { font-size: 1.5rem; }
        .leaderboard-item .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--bg-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--accent-primary);
            margin-left: 0.5rem;
            margin-right: 1rem;
            overflow: hidden;
            flex-shrink: 0;
        }
        .leaderboard-item .user-info {
            flex-grow: 1;
            overflow: hidden;
            min-width: 0; /* Ajuda no alinhamento em flexbox */
        }
        .leaderboard-item .user-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .leaderboard-item .user-score {
            font-weight: 700;
            color: var(--accent-primary);
            margin-left: 1rem;
        }
        .leaderboard-item.current-user {
            background-color: var(--bg-accent);
            border: 2px solid var(--accent-primary);
        }
        .leaderboard-item.current-user .user-name {
            font-weight: 700;
        }
        
        .league-zone {
            border-radius: 1rem;
            padding: 0.5rem;
            margin: 0.5rem 0;
        }
        .league-zone-promotion {
            background: var(--promotion-bg);
            border: 1px solid rgba(22, 163, 74, 0.3);
        }
         .league-zone-demotion {
            background: var(--demotion-bg);
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        .league-zone .zone-title {
            text-align: center;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.5rem;
        }
        .league-zone-promotion .zone-title { color: #14532D; }
        .league-zone-demotion .zone-title { color: #991B1B; }
        .league-zone .leaderboard-item {
             background-color: #fff;
        }

        /* --- PAGINAÇÃO --- */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .page-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            background-color: var(--bg-accent);
            color: var(--text-secondary);
            font-weight: 500;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-btn:hover:not(:disabled) {
            background-color: var(--accent-primary-light);
            color: var(--accent-primary);
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-btn.active {
            background-color: var(--accent-primary);
            color: white;
            font-weight: 700;
        }

        /* --- MODAIS E OVERLAYS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
            padding: 1rem;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--bg-secondary); border-radius: 1.5rem;
            padding: 2rem; width: 100%; max-width: 500px; max-height: 90vh;
            display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-scrollable-content {
             overflow-y: auto;
             padding-right: 0.5rem; 
             margin-right: -0.5rem;
        }

        /* --- INPUTS E FORMULÁRIOS --- */
        .input, .textarea, .select {
            padding: 0.75rem; border-radius: 0.75rem;
            background-color: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-primary); width: 100%;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .input:focus, .textarea:focus, .select:focus {
            outline: none; border-color: var(--accent-primary);
            background-color: var(--bg-secondary);
        }

        /* --- TELA DE CARREGAMENTO --- */
        #loading-overlay { z-index: 1001; }
        .loader-icon {
            font-family: var(--font-jp); font-size: 4rem; color: var(--accent-primary);
            animation: bounce 1.5s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); } 60% { transform: translateY(-15px); }
        }

        /* --- PERFIL E ESTATÍSTICAS (NOVO) --- */
        #profile-modal .modal-content, #stats-modal .modal-content {
            padding: 0;
            overflow: hidden;
            background: var(--bg-primary);
        }
        .profile-header {
            background-color: var(--accent-primary);
            color: white;
            padding: 2.5rem 1.5rem 1.5rem;
            text-align: center;
            position: relative;
        }
        .profile-avatar {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-color: white;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 800;
            margin: 0 auto 1rem;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .profile-name {
            font-size: 1.75rem;
            font-weight: 700;
        }
        .profile-joindate {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        #close-profile-modal {
            position: absolute; top: 1rem; right: 1rem;
            background: rgba(0,0,0,0.2); border: none; color: white;
            border-radius: 50%; width: 32px; height: 32px;
            font-size: 1.5rem; line-height: 1;
        }
        .profile-stats, .stats-section-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1.5rem;
        }
        .stat-card {
            background-color: var(--bg-secondary);
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-primary);
        }
        .stat-card .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-top: 0.25rem;
            text-transform: uppercase;
        }
        .profile-league-card {
            margin: 0 1.5rem 1.5rem;
            background-color: var(--bg-secondary);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            padding: 1rem;
            gap: 1rem;
            border: 1px solid var(--border-color);
        }

        .stats-container .stat-card {
            padding: 1.5rem;
        }
        .stats-container .stat-card.full-width {
            grid-column: 1 / -1; /* Ocupa a largura total */
        }
        .stats-container h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }


    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    
    <!-- MENU LATERAL PARA DISPOSITIVOS MÓVEIS -->
    <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[998] transition-opacity duration-300" style="display: none; opacity: 0;"></div>
    <aside id="mobile-menu" class="fixed top-0 left-0 h-full w-72 bg-white shadow-xl z-[999] p-6 transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex justify-between items-center mb-10 flex-shrink-0">
            <div class="font-black text-2xl" style="color: var(--accent-primary);">語</div>
            <button id="close-mobile-menu-btn" class="p-1 rounded-full hover:bg-gray-100">
                <i class="ph ph-x text-2xl"></i>
            </button>
        </div>
        <nav class="flex flex-col space-y-2">
            <!-- Seletor de Idioma de Aprendizado (Mobile) -->
            <div>
                 <button id="nav-lang-mobile-toggle" class="w-full text-left nav-link-mobile flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i class="ph ph-translate w-6"></i>
                        <span id="lang-learn-text-mobile" data-translate="learn_language_select">Aprender: Japonês</span>
                    </div>
                    <i id="lang-learn-caret-mobile" class="ph ph-caret-down transition-transform caret-icon"></i>
                </button>
                 <div id="nav-lang-mobile-dropdown" class="pl-8 mt-1 space-y-1" style="display: none;">
                    <button data-lang="jp" class="lang-learn-btn-mobile block text-sm py-2 text-gray-600 hover:text-accent-primary rounded-md px-3 w-full text-left active">Japonês</button>
                    <button data-lang="en" class="lang-learn-btn-mobile block text-sm py-2 text-gray-600 hover:text-accent-primary rounded-md px-3 w-full text-left">Inglês</button>
                </div>
            </div>

            <!-- Modos de Estudo (Mobile) -->
            <div>
                 <button id="nav-study-mobile-toggle" class="w-full text-left nav-link-mobile flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i class="ph ph-book-open w-6"></i>
                        <span id="study-mode-text-mobile">Estudar: Kanji</span>
                    </div>
                    <i id="study-caret-mobile" class="ph ph-caret-down transition-transform caret-icon"></i>
                </button>
                 <div id="nav-study-mobile-dropdown" class="pl-8 mt-1 space-y-1" style="display: none;">
                    {/* Conteúdo dinâmico aqui */}
                </div>
            </div>

            <!-- Jogos (Mobile) -->
            <div>
                <button id="nav-games-mobile-toggle" class="w-full text-left nav-link-mobile flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i class="ph ph-game-controller w-6"></i>
                        <span data-translate="games">Jogos</span>
                    </div>
                    <i id="games-caret-mobile" class="ph ph-caret-down transition-transform caret-icon"></i>
                </button>
                <div id="nav-games-mobile-dropdown" class="pl-8 mt-1 space-y-1" style="display: none;">
                    {/* Conteúdo dinâmico aqui */}
                </div>
            </div>
            <a href="#" class="nav-link-mobile" id="nav-manage-mobile">
                <i class="ph ph-cards w-6"></i>
                <span data-translate="manage">Gerenciar</span>
            </a>
            <a href="#" class="nav-link-mobile" id="nav-stats-mobile">
                <i class="ph ph-chart-bar w-6"></i>
                <span data-translate="statistics">Estatísticas</span>
            </a>
            <a href="#" class="nav-link-mobile" id="nav-leaderboard-mobile">
                <i class="ph ph-trophy w-6"></i>
                <span data-translate="leagues">Ligas</span>
            </a>
        </nav>
    </aside>

    <!-- CABEÇALHO -->
    <header class="w-full flex justify-center items-center p-4">
        <div class="w-full max-w-5xl flex justify-between items-center">
            <div class="font-black text-3xl" style="color: var(--accent-primary);">
                <a href="#" id="home-logo">語</a>
            </div>
            <nav class="hidden md:flex items-center space-x-2">
                 <!-- Seletor de Idioma de Aprendizado -->
                 <div class="dropdown">
                    <a href="#" class="nav-link flex items-center gap-2" id="nav-lang-learn">
                        <span id="lang-learn-text" data-translate="learn_language_select">Aprender: Japonês</span>
                        <i class="ph ph-caret-down"></i>
                    </a>
                    <div id="lang-learn-dropdown" class="dropdown-content">
                        <button data-lang="jp" class="lang-learn-btn active">Japonês</button>
                        <button data-lang="en" class="lang-learn-btn">Inglês</button>
                    </div>
                </div>

                 <!-- Modos de Estudo -->
                 <div class="dropdown">
                    <a href="#" class="nav-link active flex items-center gap-2" id="nav-study">
                        <span id="study-mode-text">Estudar: Kanji</span>
                        <i class="ph ph-caret-down"></i>
                    </a>
                    <div id="study-mode-dropdown" class="dropdown-content">
                        {/* Conteúdo dinâmico aqui */}
                    </div>
                </div>

                <div class="dropdown">
                    <a href="#" class="nav-link" id="nav-games" data-translate="games">Jogos</a>
                    <div id="nav-games-dropdown" class="dropdown-content">
                         {/* Conteúdo dinâmico aqui */}
                    </div>
                </div>
                <a href="#" class="nav-link" id="nav-manage" data-translate="manage">Gerenciar</a>
                <a href="#" class="nav-link" id="nav-stats" data-translate="statistics">Estatísticas</a>
                <a href="#" class="nav-link" id="nav-leaderboard" data-translate="leagues">Ligas</a>
            </nav>
            <div class="flex items-center space-x-2">
                 <!-- Seletor de Idioma da UI -->
                <div class="dropdown">
                    <button id="lang-ui-btn" class="p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100">
                        <i class="ph ph-globe text-2xl"></i>
                    </button>
                    <div id="lang-ui-dropdown" class="dropdown-content" style="right: 0; left: auto; transform: none; min-width: 150px;">
                        <button data-lang="pt" class="lang-ui-btn active"><span>🇧🇷</span> Português</button>
                        <button data-lang="en" class="lang-ui-btn"><span>🇺🇸</span> English</button>
                    </div>
                </div>
                
                <div id="userInfoContainer" class="relative">
                    <div id="auth-links" style="display: none;">
                         <button id="login-nav-btn" class="btn btn-secondary text-sm" data-translate="login">Entrar</button>
                    </div>
                    <div id="user-menu" class="relative" style="display: none;">
                        <button id="user-menu-btn" class="flex items-center space-x-2 text-sm font-medium text-gray-600 hover:text-accent-primary">
                            <span id="user-name-display" class="truncate max-w-[150px]"></span>
                            <i class="ph ph-caret-down"></i>
                        </button>
                        <div id="user-menu-dropdown" class="dropdown-content">
                            <a href="#" id="my-profile-btn" data-translate="my_profile">Meu Perfil</a>
                            <a href="#" id="manage-account-btn" data-translate="manage_account">Gerenciar Conta</a>
                            <a href="#" id="logoutBtn" data-translate="logout">Sair</a>
                        </div>
                    </div>
                </div>
                 <!-- Botão Hamburger -->
                <div class="md:hidden">
                    <button id="hamburger-btn" class="p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-purple-500">
                        <i class="ph ph-list text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- TELA DE CARREGAMENTO -->
    <div id="loading-overlay" class="modal-overlay visible">
        <div class="text-center">
            <div class="loader-icon">語</div>
            <p id="loading-text" class="mt-4 text-lg font-bold" style="color: var(--text-primary);" data-translate="loading_learning">Carregando seu aprendizado...</p>
        </div>
    </div>
    
    <!-- MODAL DE AUTENTICAÇÃO -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content text-center">
             <h2 class="text-3xl font-bold mb-6" id="auth-modal-title" data-translate="login">Entrar</h2>
            <div id="auth-form-fields" class="flex flex-col space-y-4">
                <input type="text" id="usernameInput" data-translate-placeholder="username" placeholder="Nome de Usuário" class="input" style="display: none;">
                <input type="email" id="emailInput" data-translate-placeholder="email" placeholder="Email" class="input">
                <input type="password" id="passwordInput" data-translate-placeholder="password" placeholder="Senha" class="input">
                <input type="password" id="confirmPasswordInput" data-translate-placeholder="confirm_password" placeholder="Confirmar Senha" class="input" style="display: none;">
                <input type="text" id="keywordInput" data-translate-placeholder="security_keyword" placeholder="Palavra-chave de Segurança" class="input" style="display: none;" data-translate-title="keyword_tooltip" title="Use esta palavra para confirmar alterações importantes na sua conta.">
            </div>
             <div class="mt-4">
                <button id="authBtn" class="btn btn-primary w-full" data-translate="login">Entrar</button>
                <p id="toggleAuthMode" class="text-sm cursor-pointer hover:underline text-gray-500 mt-4" data-translate="no_account_yet">Ainda não tem uma conta? Crie uma.</p>
                <p id="forgotPassword" class="text-sm cursor-pointer hover:underline text-gray-500 mt-2" data-translate="forgot_password">Esqueceu sua senha?</p>
             </div>
            <p id="auth-status-message" class="mt-4 text-sm min-h-[20px]"></p>
        </div>
    </div>
    
    <!-- CONTEÚDO PRINCIPAL (ESTUDO) -->
    <main class="main-container" style="display: none;">
        <div class="flex flex-col items-center">
            <div id="review-card-container" class="review-card-container w-full mb-6">
                <div id="review-card" class="review-card">
                    <div id="card-front" class="card-face card-face-front"></div>
                    <div id="card-back" class="card-face card-face-back"></div>
                </div>
            </div>

            <div class="w-full mt-2">
                <div class="h-2 rounded-full" style="background-color: var(--bg-accent);">
                    <div id="progress-bar" class="h-2 bg-green-500 rounded-full transition-all duration-300 ease-in-out" style="width: 0%; background-color: var(--accent-primary);"></div>
                </div>
                <p id="progress-text" class="text-right text-sm text-gray-500 mt-1 font-bold">0 / 0</p>
            </div>
            
            <div id="action-buttons" class="mt-6 flex flex-col space-y-4 items-center w-full max-w-md">
                <div id="feedback-buttons-container" class="grid grid-cols-2 gap-4 w-full"></div>
                <button id="studyMoreBtn" class="btn btn-secondary w-full" data-translate="study_more">Estudar Mais</button>
            </div>
        </div>
        <p id="userIdDisplay" class="text-xs text-gray-400 text-center mt-8"></p>
    </main>
    
    <!-- CONTEÚDO DO JOGO -->
    <div id="game-container" class="game-container" style="display: none;">
        <!-- O conteúdo do jogo será renderizado aqui pelo JS -->
    </div>

    <!-- CONTEÚDO DAS ESTATÍSTICAS -->
    <div id="stats-container" class="stats-container" style="display: none;">
        <!-- O conteúdo das estatísticas será renderizado aqui pelo JS -->
    </div>


    <!-- MODAL DE GERENCIAMENTO DE CARDS -->
    <div id="manage-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h2 id="manage-modal-title" class="text-3xl font-bold" data-translate="manage_cards">Gerenciar Cards</h2>
                <button id="close-manage-modal" class="text-2xl font-bold p-2 leading-none">&times;</button>
            </div>
            <button id="add-new-card-btn" class="btn btn-primary w-full mb-6 flex-shrink-0" data-translate="add_new_card">Adicionar Novo Card</button>
            <div id="card-list-container" class="space-y-3 modal-scrollable-content flex-grow min-h-0">
                <!-- Lista de cards será inserida aqui -->
            </div>
            <div id="manage-pagination-container" class="pagination-container"></div>
        </div>
    </div>
    
    <!-- MODAL DO PLACAR (LIGAS) -->
    <div id="leaderboard-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="mascot-container" class="pt-4">
                <svg id="gogo-chan-mascot" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <style>
                        #gogo-chan-mascot .wing-l { animation: wings-flap 2s ease-in-out infinite; transform-origin: 90% 90%; }
                        #gogo-chan-mascot .wing-r { animation: wings-flap 2s ease-in-out infinite; transform-origin: 10% 90%; animation-delay: 0.1s; }
                        #gogo-chan-mascot .blush { opacity: 0; animation: blush-fade 4s ease-in-out infinite; }
                        @keyframes blush-fade { 0%, 100% { opacity: 0; } 40% { opacity: 0.7; } 60% { opacity: 0.7; } }
                    </style>
                    <defs>
                        <filter id="glow-effect" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <g transform="translate(50, 50)">
                        <path class="wing-l" d="M-8, -10 C -30, -25 -25, 10 -8, 5 Z" fill="rgba(235, 226, 255, 0.9)"/>
                        <path class="wing-r" d="M8, -10 C 30, -25 25, 10 8, 5 Z" fill="rgba(235, 226, 255, 0.9)"/>
                        <ellipse cx="0" cy="18" rx="18" ry="22" fill="#FDE047" filter="url(#glow-effect)"/>
                        <path d="M0,-15 Q20,-10 20,10 Q20,25 0,33 Q-20,25 -20,10 Q-20,-10 0,-15 Z" fill="#6D28D9"/>
                        <circle cx="0" cy="-18" r="16" fill="#4C1D95"/>
                        <circle cx="-6" cy="-20" r="4.5" fill="white"/>
                        <circle cx="6" cy="-20" r="4.5" fill="white"/>
                        <circle cx="-5" cy="-19" r="2" fill="black"/>
                        <circle cx="7" cy="-19" r="2" fill="black"/>
                        <circle cx="-4.5" cy="-20.5" r="0.8" fill="white"/>
                        <circle cx="7.5" cy="-20.5" r="0.8" fill="white"/>
                        <ellipse class="blush" cx="-12" cy="-15" rx="4" ry="2" fill="#FFA7C3"/>
                        <ellipse class="blush" cx="12" cy="-15" rx="4" ry="2" fill="#FFA7C3"/>
                    </g>
                </svg>
            </div>
            <div id="league-header">
                <button id="close-leaderboard-modal">&times;</button>
                <h2 data-translate="weekly_league">Liga Semanal</h2>
                <div id="patent-info">
                    <div id="patent-icon-container"></div>
                    <span id="patent-name">--</span>
                </div>
                <p id="league-timer" class="text-sm text-gray-500" data-translate-base="ends_in">Termina em: --</p>
            </div>
            <div id="leaderboard-list">
                <!-- Lista da liga será inserida aqui -->
            </div>
            <div id="leaderboard-pagination-container" class="pagination-container"></div>
        </div>
    </div>

    <!-- MODAL DE PERFIL DE USUÁRIO (NOVO) -->
    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="profile-content">
                <!-- O conteúdo do perfil será renderizado aqui -->
            </div>
        </div>
    </div>


    <!-- MODAL DE GERENCIAR CONTA -->
    <div id="user-manage-modal" class="modal-overlay">
        <div class="modal-content">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold" data-translate="manage_account">Gerenciar Conta</h2>
                <button type="button" id="cancel-user-manage-btn" class="text-2xl font-bold p-2 leading-none">&times;</button>
            </div>
            
            <div class="modal-scrollable-content pr-2">
                <form id="update-username-form" class="flex flex-col space-y-4">
                    <h3 class="text-lg font-semibold" data-translate="change_username">Alterar Nome de Usuário</h3>
                    <div>
                        <label for="new-username-input" class="font-bold text-sm" data-translate="username">Nome de Usuário</label>
                        <input type="text" id="new-username-input" class="input mt-1" required>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="btn btn-primary" data-translate="save_name">Salvar Nome</button>
                    </div>
                    <p id="update-username-status" class="text-sm mt-2 min-h-[20px]"></p>
                </form>

                 <form id="update-keyword-form" class="flex flex-col space-y-4 border-t border-gray-200 pt-4 mt-4">
                    <h3 class="text-lg font-semibold" data-translate="change_keyword">Alterar Palavra-chave de Segurança</h3>
                    <div>
                        <label for="new-keyword-input" class="font-bold text-sm" data-translate="new_keyword">Nova Palavra-chave</label>
                        <input type="text" id="new-keyword-input" class="input mt-1" required>
                    </div>
                    <div>
                        <label for="current-password-for-keyword" class="font-bold text-sm" data-translate="current_password_to_confirm">Senha Atual (para confirmar)</label>
                        <input type="password" id="current-password-for-keyword" class="input mt-1" required>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="btn btn-primary" data-translate="save_keyword">Salvar Palavra-chave</button>
                    </div>
                    <p id="update-keyword-status" class="text-sm mt-2 min-h-[20px]"></p>
                </form>

                <form id="update-password-form" class="flex flex-col space-y-4 border-t border-gray-200 pt-4 mt-4">
                    <h3 class="text-lg font-semibold" data-translate="change_password">Alterar Senha</h3>
                    <div>
                        <label for="new-password-input" class="font-bold text-sm" data-translate="new_password">Nova Senha</label>
                        <input type="password" id="new-password-input" class="input mt-1" required>
                    </div>
                     <div>
                        <label for="confirm-new-password-input" class="font-bold text-sm" data-translate="confirm_new_password">Confirmar Nova Senha</label>
                        <input type="password" id="confirm-new-password-input" class="input mt-1" required>
                    </div>
                    <div class="flex justify-end mt-4">
                        <button type="submit" class="btn btn-primary" data-translate="update_password">Atualizar Senha</button>
                    </div>
                    <p id="update-password-status" class="text-sm mt-2 min-h-[20px]"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL DE ADICIONAR/EDITAR CARD -->
    <div id="add-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold mb-6" id="add-edit-modal-title" data-translate="add_card">Adicionar Card</h2>
            <form id="add-edit-form" class="flex flex-col space-y-4">
                <input type="hidden" id="card-id-input">
                 <div class="flex items-end space-x-2">
                    <div class="flex-grow">
                        <label for="kanji-input" id="main-char-label" class="font-bold text-sm" data-translate="kanji">Kanji</label>
                        <input type="text" id="kanji-input" class="input mt-1" required>
                    </div>
                    <button type="button" id="generate-ai-btn" class="btn btn-primary flex-shrink-0">
                        <span id="ai-btn-text" data-translate="generate_with_ai">Gerar com IA</span>
                         <svg id="ai-btn-spinner" class="animate-spin h-5 w-5 text-white" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
                <div id="display-form-field">
                    <label for="display-kanji-input" class="font-bold text-sm" data-translate="display_form_label">Forma de Exibição (Opcional, ex: 大きい)</label>
                    <input type="text" id="display-kanji-input" class="input mt-1">
                </div>
                <div>
                    <label for="pronunciation-input" id="pronunciation-label" class="font-bold text-sm" data-translate="reading_romaji">Leitura (Romaji)</label>
                    <input type="text" id="pronunciation-input" class="input mt-1" required>
                </div>
                <div>
                    <label for="meaning-input" class="font-bold text-sm" data-translate="meaning">Significado</label>
                    <input type="text" id="meaning-input" class="input mt-1" required>
                </div>
                <input type="hidden" id="gemini-data-input">
                <div class="flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary" data-translate="cancel">Cancelar</button>
                    <button type="submit" id="save-card-btn" class="btn btn-primary">
                        <span id="save-btn-text" data-translate="save">Salvar</span>
                        <svg id="save-btn-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- MODAL DE PLACAR PÓS-JOGO -->
    <div id="game-completion-modal" class="modal-overlay">
        <div id="game-completion-content" class="modal-content">
            <!-- Conteúdo do placar do jogo será injetado aqui pelo JS -->
        </div>
    </div>

    <footer class="w-full text-center p-4 mt-auto">
        <p class="text-xs" style="color: var(--text-secondary);">&copy; 2024 Firefly Designer. Todos os direitos reservados.</p>
    </footer>

    <script type="module">
        // © 2024 Firefly Designer. Todos os direitos reservados.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updatePassword, sendPasswordResetEmail, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, remove, get, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- AVISO DE SEGURANÇA ---
        const firebaseConfig = {
            apiKey: "AIzaSyAl4OJcZJlkn809EPdv7VUchU0ObuhcwHs",
            authDomain: "kanjis-b38b4.firebaseapp.com",
            projectId: "kanjis-b38b4",
            storageBucket: "kanjis-b38b4.firebasestorage.app",
            messagingSenderId: "794836504781",
            appId: "1:794836504781:web:b83d4bfb5e3b44ebda5984",
            databaseURL: "https://kanjis-b38b4-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- TRADUÇÃO DA UI ---
        const translations = {
            pt: {
                // Geral
                login: "Entrar",
                logout: "Sair",
                games: "Jogos",
                manage: "Gerenciar",
                statistics: "Estatísticas",
                leagues: "Ligas",
                my_profile: "Meu Perfil",
                manage_account: "Gerenciar Conta",
                save: "Salvar",
                cancel: "Cancelar",
                loading_learning: "Carregando seu aprendizado...",
                // Auth Modal
                username: "Nome de Usuário",
                email: "Email",
                password: "Senha",
                confirm_password: "Confirmar Senha",
                security_keyword: "Palavra-chave de Segurança",
                keyword_tooltip: "Use esta palavra para confirmar alterações importantes na sua conta.",
                no_account_yet: "Ainda não tem uma conta? Crie uma.",
                forgot_password: "Esqueceu sua senha?",
                create_account: "Criar Conta",
                already_have_account: "Já tem uma conta? Entrar.",
                recover_password: "Recuperar Senha",
                verify_and_send_email: "Verificar e Enviar E-mail",
                back_to_login: "Voltar para o Login",
                processing: "Processando...",
                failure: "Falha",
                success_email_sent: "Verificação bem-sucedida! E-mail de recuperação enviado.",
                // Estudo
                study_more: "Estudar Mais",
                show_answer: "Mostrar Resposta",
                hard: "Difícil",
                easy: "Fácil",
                show_front: "Mostrar Frente",
                congratulations: "Parabéns!",
                review_complete: "Você completou sua revisão de hoje.",
                all_up_to_date: "Tudo em dia!",
                no_review_left: "Nenhuma revisão restante.",
                session_score: "Pontuação da Sessão",
                correct_answers_short: "acertos",
                incorrect_answers_short: "erros",
                // Gerenciar
                manage_cards: "Gerenciar Cards",
                add_new_card: "Adicionar Novo Card",
                add_card: "Adicionar Card",
                edit_card: "Editar Card",
                edit: "Editar",
                delete: "Deletar",
                no_cards_yet: "Você ainda não tem cards.",
                confirm_delete: "Tem certeza que deseja apagar este card?",
                // Add/Edit Card Modal
                kanji: "Kanji",
                character: "Caractere",
                word: "Palavra",
                display_form_label: "Forma de Exibição (Opcional, ex: 大きい)",
                display_form_label_en: "Forma de Exibição (Opcional)",
                reading_romaji: "Leitura (Romaji)",
                pronunciation: "Pronúncia",
                meaning: "Significado",
                generate_with_ai: "Gerar com IA",
                // Ligas
                weekly_league: "Liga Semanal",
                ends_in: "Termina em",
                promotion_zone: "Zona de Promoção",
                demotion_zone: "Zona de Rebaixamento",
                not_in_league: "Você ainda não está em uma liga.",
                // Perfil
                member_since: "Membro desde",
                total_xp: "Total XP",
                correct_answers: "Respostas Corretas",
                weekly_points: "Pontos da semana",
                profile_not_found: "Perfil não encontrado.",
                error_loading_profile: "Ocorreu um erro ao carregar o perfil.",
                anonymous_user: "Usuário Anônimo",
                // Gerenciar Conta
                change_username: "Alterar Nome de Usuário",
                save_name: "Salvar Nome",
                username_not_empty: "O nome de usuário não pode ser vazio.",
                saving: "Salvando...",
                name_updated: "Nome atualizado com sucesso!",
                error_saving: "Erro ao salvar. Tente novamente.",
                change_keyword: "Alterar Palavra-chave de Segurança",
                new_keyword: "Nova Palavra-chave",
                current_password_to_confirm: "Senha Atual (para confirmar)",
                save_keyword: "Salvar Palavra-chave",
                fields_required: "Todos os campos são obrigatórios.",
                verifying_and_saving: "Verificando e salvando...",
                keyword_updated: "Palavra-chave atualizada com sucesso!",
                wrong_password: "Senha atual incorreta.",
                change_password: "Alterar Senha",
                new_password: "Nova Senha",
                confirm_new_password: "Confirmar Nova Senha",
                update_password: "Atualizar Senha",
                passwords_dont_match: "As senhas não coincidem.",
                password_min_length: "A senha deve ter no mínimo 6 caracteres.",
                updating: "Atualizando...",
                password_updated: "Senha atualizada com sucesso!",
                error_updating_password: "Erro ao atualizar. Requer login recente.",
                // Jogos
                congrats_challenge: "Parabéns!",
                challenge_complete: "Você completou o desafio.",
                points_earned: "Pontos Ganhos",
                bonus_points: "bônus",
                play_again: "Jogar Novamente",
                return_to_menu: "Voltar ao Menu",
                insufficient_cards: "Cards Insuficientes",
                need_at_least: "Você precisa de pelo menos",
                cards_to_play: "cards para jogar este modo.",
                // Estatísticas
                statistics_title: "Estatísticas",
                statistics_subtitle: "Seu progresso de aprendizado ao longo do tempo.",
                calculating_stats: "Calculando estatísticas...",
                cards_added: "Cards Adicionados",
                cards_completed: "Cards Concluídos",
                study_results: "Resultados de Estudo",
                accuracy: "Precisão",
                study_forecast: "Previsão de Estudo",
                cards_to_review_tomorrow: "Cards para revisar amanhã",
                engagement: "Engajamento (Em Breve)",
                // Misc
                learn_language_select: "Aprender",
                study_mode_select: "Estudar",
                example_sentences: "Frases de Exemplo",
                curiosities: "Curiosidades",
                grammar_tip: "Dica Gramatical",
            },
            en: {
                // General
                login: "Login",
                logout: "Logout",
                games: "Games",
                manage: "Manage",
                statistics: "Statistics",
                leagues: "Leagues",
                my_profile: "My Profile",
                manage_account: "Manage Account",
                save: "Save",
                cancel: "Cancel",
                loading_learning: "Loading your learning...",
                // Auth Modal
                username: "Username",
                email: "Email",
                password: "Password",
                confirm_password: "Confirm Password",
                security_keyword: "Security Keyword",
                keyword_tooltip: "Use this keyword to confirm important changes to your account.",
                no_account_yet: "Don't have an account yet? Sign up.",
                forgot_password: "Forgot your password?",
                create_account: "Create Account",
                already_have_account: "Already have an account? Login.",
                recover_password: "Recover Password",
                verify_and_send_email: "Verify & Send Email",
                back_to_login: "Back to Login",
                processing: "Processing...",
                failure: "Failure",
                success_email_sent: "Verification successful! Recovery email sent.",
                // Study
                study_more: "Study More",
                show_answer: "Show Answer",
                hard: "Hard",
                easy: "Easy",
                show_front: "Show Front",
                congratulations: "Congratulations!",
                review_complete: "You've completed your review for today.",
                all_up_to_date: "All caught up!",
                no_review_left: "No reviews left.",
                session_score: "Session Score",
                correct_answers_short: "correct",
                incorrect_answers_short: "incorrect",
                // Manage
                manage_cards: "Manage Cards",
                add_new_card: "Add New Card",
                add_card: "Add Card",
                edit_card: "Edit Card",
                edit: "Edit",
                delete: "Delete",
                no_cards_yet: "You don't have any cards yet.",
                confirm_delete: "Are you sure you want to delete this card?",
                // Add/Edit Card Modal
                kanji: "Kanji",
                character: "Character",
                word: "Word",
                display_form_label: "Display Form (Optional, e.g., 大きい)",
                display_form_label_en: "Display Form (Optional)",
                reading_romaji: "Reading (Romaji)",
                pronunciation: "Pronunciation",
                meaning: "Meaning",
                generate_with_ai: "Generate with AI",
                // Leagues
                weekly_league: "Weekly League",
                ends_in: "Ends in",
                promotion_zone: "Promotion Zone",
                demotion_zone: "Demotion Zone",
                not_in_league: "You are not in a league yet.",
                // Profile
                member_since: "Member since",
                total_xp: "Total XP",
                correct_answers: "Correct Answers",
                weekly_points: "Weekly points",
                profile_not_found: "Profile not found.",
                error_loading_profile: "An error occurred while loading the profile.",
                anonymous_user: "Anonymous User",
                // Manage Account
                change_username: "Change Username",
                save_name: "Save Name",
                username_not_empty: "Username cannot be empty.",
                saving: "Saving...",
                name_updated: "Name updated successfully!",
                error_saving: "Error saving. Please try again.",
                change_keyword: "Change Security Keyword",
                new_keyword: "New Keyword",
                current_password_to_confirm: "Current Password (to confirm)",
                save_keyword: "Save Keyword",
                fields_required: "All fields are required.",
                verifying_and_saving: "Verifying and saving...",
                keyword_updated: "Keyword updated successfully!",
                wrong_password: "Incorrect current password.",
                change_password: "Change Password",
                new_password: "New Password",
                confirm_new_password: "Confirm New Password",
                update_password: "Update Password",
                passwords_dont_match: "Passwords do not match.",
                password_min_length: "Password must be at least 6 characters.",
                updating: "Updating...",
                password_updated: "Password updated successfully!",
                error_updating_password: "Error updating. Requires recent login.",
                 // Games
                congrats_challenge: "Congratulations!",
                challenge_complete: "You've completed the challenge.",
                points_earned: "Points Earned",
                bonus_points: "bonus",
                play_again: "Play Again",
                return_to_menu: "Return to Menu",
                insufficient_cards: "Insufficient Cards",
                need_at_least: "You need at least",
                cards_to_play: "cards to play this mode.",
                // Statistics
                statistics_title: "Statistics",
                statistics_subtitle: "Your learning progress over time.",
                calculating_stats: "Calculating statistics...",
                cards_added: "Cards Added",
                cards_completed: "Cards Completed",
                study_results: "Study Results",
                accuracy: "Accuracy",
                study_forecast: "Study Forecast",
                cards_to_review_tomorrow: "Cards to review tomorrow",
                engagement: "Engagement (Coming Soon)",
                // Misc
                learn_language_select: "Learn",
                study_mode_select: "Study",
                example_sentences: "Example Sentences",
                curiosities: "Curiosities",
                grammar_tip: "Grammar Tip",
            }
        };

        let currentUILanguage = 'pt';

        function translateUI(lang) {
            currentUILanguage = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.dataset.translatePlaceholder;
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
             document.querySelectorAll('[data-translate-title]').forEach(el => {
                const key = el.dataset.translateTitle;
                if (translations[lang] && translations[lang][key]) {
                    el.title = translations[lang][key];
                }
            });
             document.querySelectorAll('[data-translate-base]').forEach(el => {
                const key = el.dataset.translateBase;
                const baseText = translations[lang][key] || el.dataset.baseText;
                if (!el.dataset.baseText) el.dataset.baseText = el.textContent.split(':')[0] + ':';
                const value = el.textContent.split(':')[1];
                if (value) el.textContent = `${baseText} ${value.trim()}`;
            });
        }


        // --- DEFINIÇÕES DO JOGO (PATENTES) ---
        const patents = [
            { name: 'Bronze I', color: '#A97142', shadow: '#6E4220' }, { name: 'Bronze II', color: '#A97142', shadow: '#6E4220' }, { name: 'Bronze III', color: '#A97142', shadow: '#6E4220' },
            { name: 'Prata I', color: '#BCC6D0', shadow: '#808C99' }, { name: 'Prata II', color: '#BCC6D0', shadow: '#808C99' }, { name: 'Prata III', color: '#BCC6D0', shadow: '#808C99' },
            { name: 'Ouro I', color: '#FFD700', shadow: '#B3A125' }, { name: 'Ouro II', color: '#FFD700', shadow: '#B3A125' }, { name: 'Ouro III', color: '#FFD700', shadow: '#B3A125' },
            { name: 'Platina I', color: '#E5E4E2', shadow: '#A8A6A4' }, { name: 'Platina II', color: '#E5E4E2', shadow: '#A8A6A4' }, { name: 'Diamante', color: '#B9F2FF', shadow: '#53B3C7' }
        ];

        // --- MÓDULO DE ÁUDIO (CORRIGIDO PARA MOBILE E USANDO TTS NATIVO) ---
        let audioCtx;

        function initAudioContext() {
            if (audioCtx && audioCtx.state === 'running') return;
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            } catch (e) {
                console.error("Web Audio API não é suportada neste navegador");
            }
        }

        // Inicia o contexto de áudio na primeira interação do usuário para compatibilidade móvel
        ['click', 'touchstart'].forEach(eventName => {
            document.body.addEventListener(eventName, () => {
                initAudioContext();
                // A 'speechSynthesis' também precisa ser "desbloqueada" em alguns navegadores
                if (window.speechSynthesis && window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.getVoices();
                }
            }, { once: true });
        });

        function playTone(freq, duration, type = 'sine') {
            initAudioContext();
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duration);
        }

        function playCorrectSound() { playTone(600, 0.1, 'triangle'); setTimeout(() => playTone(900, 0.1, 'triangle'), 100); }
        function playIncorrectSound() { playTone(150, 0.2, 'sawtooth'); }
        function playVictorySound() {
            const notes = [261.63, 329.63, 392.00, 523.25];
            notes.forEach((note, i) => {
                setTimeout(() => playTone(note, 0.15, 'triangle'), i * 100);
            });
        }

        /**
         * Usa a API nativa de síntese de voz do navegador para pronunciar o texto.
         * @param {string} text O texto a ser falado.
         * @param {string} lang O código do idioma (ex: 'jp', 'en').
         */
        function speak(text, lang) {
            if (!text || !window.speechSynthesis) {
                console.warn("Síntese de voz não suportada ou texto vazio.");
                return;
            }

            // Garante que a fala anterior seja interrompida
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);

            // Mapeia nosso código de idioma para o padrão BCP 47 que a API usa
            const langMap = {
                'jp': 'ja-JP',
                'en': 'en-US'
            };
            utterance.lang = langMap[lang] || lang; 
            
            // Aumenta um pouco a velocidade para uma pronúncia mais natural em japonês
            if (utterance.lang === 'ja-JP') {
                utterance.rate = 1.0;
            }

            // A API de vozes pode ser assíncrona. Se as vozes não estiverem carregadas,
            // esperamos pelo evento onvoiceschanged.
            let voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                // Tenta encontrar uma voz específica para o idioma para maior compatibilidade
                utterance.voice = voices.find(voice => voice.lang === utterance.lang) || voices.find(voice => voice.lang.startsWith(lang));
                window.speechSynthesis.speak(utterance);
            } else {
                // Fallback: se nenhuma voz for carregada, fala com a padrão e espera que o evento 'onvoiceschanged' resolva na próxima vez
                window.speechSynthesis.onvoiceschanged = () => {
                    voices = window.speechSynthesis.getVoices();
                    utterance.voice = voices.find(voice => voice.lang === utterance.lang) || voices.find(voice => voice.lang.startsWith(lang));
                    window.speechSynthesis.speak(utterance);
                };
                // Em alguns casos, mesmo sem vozes, a fala pode funcionar com a voz padrão do sistema
                window.speechSynthesis.speak(utterance);
            }
        }


        // Estado da aplicação
        let allCards = {};
        let userProfile = { totalScore: 0, weeklyScore: 0, patentLevel: 0, leagueId: null, email: '', username: '', keyword: '', createdAt: '' };
        let dueCards = [];
        let currentCard = null;
        let userId = null;
        let unsubscribeCards;
        let unsubscribeProfile;
        let isCardFlipped = false;
        let isStudyMoreSession = false; 
        let sessionInitialCount = 0; 
        let srsSessionStats = { correct: 0, incorrect: 0 };
        let currentLearningLanguage = 'jp'; // 'jp' ou 'en'
        let currentLearningMode = 'kanji'; // 'kanji', 'hiragana', 'katakana', 'english'
        let leagueTimerInterval;
        let leagueCurrentPage = 1;
        let manageCurrentPage = 1;
        let currentAuthMode = 'login'; // 'login', 'register', 'recover'
        const ITEMS_PER_PAGE = 10;
        let studyResultsChart = null; 

        // Elementos do DOM
        const dom = {
            mainContainer: document.querySelector('.main-container'),
            gameContainer: document.getElementById('game-container'),
            statsContainer: document.getElementById('stats-container'), 
            loadingOverlay: document.getElementById('loading-overlay'),
            authModal: document.getElementById('auth-modal'),
            reviewCard: document.getElementById('review-card'),
            cardFront: document.getElementById('card-front'),
            cardBack: document.getElementById('card-back'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            feedbackButtons: document.getElementById('feedback-buttons-container'),
            studyMoreBtn: document.getElementById('studyMoreBtn'),
            navStudy: document.getElementById('nav-study'),
            studyModeText: document.getElementById('study-mode-text'),
            studyModeDropdown: document.getElementById('study-mode-dropdown'),
            navGames: document.getElementById('nav-games'),
            navManage: document.getElementById('nav-manage'),
            navStats: document.getElementById('nav-stats'), 
            navLeaderboard: document.getElementById('nav-leaderboard'),
            homeLogo: document.getElementById('home-logo'),
            navGamesDropdown: document.getElementById('nav-games-dropdown'),
            manageModal: document.getElementById('manage-modal'),
            manageModalTitle: document.getElementById('manage-modal-title'),
            closeManageModalBtn: document.getElementById('close-manage-modal'),
            addNewCardBtn: document.getElementById('add-new-card-btn'),
            cardListContainer: document.getElementById('card-list-container'),
            managePaginationContainer: document.getElementById('manage-pagination-container'),
            leaderboardModal: document.getElementById('leaderboard-modal'),
            closeLeaderboardModalBtn: document.getElementById('close-leaderboard-modal'),
            leaderboardList: document.getElementById('leaderboard-list'),
            leaderboardPaginationContainer: document.getElementById('leaderboard-pagination-container'),
            leagueHeader: document.getElementById('league-header'),
            patentIconContainer: document.getElementById('patent-icon-container'),
            patentName: document.getElementById('patent-name'),
            leagueTimer: document.getElementById('league-timer'),
            addEditModal: document.getElementById('add-edit-modal'),
            addEditForm: document.getElementById('add-edit-form'),
            addEditModalTitle: document.getElementById('add-edit-modal-title'),
            mainCharLabel: document.getElementById('main-char-label'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            cardIdInput: document.getElementById('card-id-input'),
            kanjiInput: document.getElementById('kanji-input'),
            displayFormField: document.getElementById('display-form-field'),
            displayKanjiInput: document.getElementById('display-kanji-input'),
            pronunciationLabel: document.getElementById('pronunciation-label'),
            pronunciationInput: document.getElementById('pronunciation-input'),
            meaningInput: document.getElementById('meaning-input'),
            saveCardBtn: document.getElementById('save-card-btn'),
            authLinks: document.getElementById('auth-links'),
            loginNavBtn: document.getElementById('login-nav-btn'),
            userMenu: document.getElementById('user-menu'),
            userMenuBtn: document.getElementById('user-menu-btn'),
            userNameDisplay: document.getElementById('user-name-display'),
            userMenuDropdown: document.getElementById('user-menu-dropdown'),
            logoutBtn: document.getElementById('logoutBtn'),
            myProfileBtn: document.getElementById('my-profile-btn'),
            manageAccountBtn: document.getElementById('manage-account-btn'),
            userManageModal: document.getElementById('user-manage-modal'),
            cancelUserManageBtn: document.getElementById('cancel-user-manage-btn'),
            updatePasswordForm: document.getElementById('update-password-form'),
            updatePasswordStatus: document.getElementById('update-password-status'),
            updateUsernameForm: document.getElementById('update-username-form'),
            newUsernameInput: document.getElementById('new-username-input'),
            updateUsernameStatus: document.getElementById('update-username-status'),
            generateAiBtn: document.getElementById('generate-ai-btn'),
            aiBtnText: document.getElementById('ai-btn-text'),
            aiBtnSpinner: document.getElementById('ai-btn-spinner'),
            geminiDataInput: document.getElementById('gemini-data-input'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            mobileMenu: document.getElementById('mobile-menu'),
            menuOverlay: document.getElementById('menu-overlay'),
            closeMobileMenuBtn: document.getElementById('close-mobile-menu-btn'),
            navStudyMobileToggle: document.getElementById('nav-study-mobile-toggle'),
            studyModeTextMobile: document.getElementById('study-mode-text-mobile'),
            navStudyMobileDropdown: document.getElementById('nav-study-mobile-dropdown'),
            studyCaretMobile: document.getElementById('study-caret-mobile'),
            navGamesMobileToggle: document.getElementById('nav-games-mobile-toggle'),
            navGamesMobileDropdown: document.getElementById('nav-games-mobile-dropdown'),
            gamesCaretMobile: document.getElementById('games-caret-mobile'),
            navManageMobile: document.getElementById('nav-manage-mobile'),
            navStatsMobile: document.getElementById('nav-stats-mobile'), 
            navLeaderboardMobile: document.getElementById('nav-leaderboard-mobile'),
            profileModal: document.getElementById('profile-modal'),
            profileContent: document.getElementById('profile-content'),
            authForm: { usernameInput: document.getElementById('usernameInput'), emailInput: document.getElementById('emailInput'), passwordInput: document.getElementById('passwordInput'), confirmPasswordInput: document.getElementById('confirmPasswordInput'), keywordInput: document.getElementById('keywordInput'), authBtn: document.getElementById('authBtn'), toggleAuthMode: document.getElementById('toggleAuthMode'), authModalTitle: document.getElementById('auth-modal-title'), authStatusMessage: document.getElementById('auth-status-message'), forgotPasswordLink: document.getElementById('forgotPassword') },
            updateKeywordForm: document.getElementById('update-keyword-form'),
            newKeywordInput: document.getElementById('new-keyword-input'),
            currentPasswordForKeyword: document.getElementById('current-password-for-keyword'),
            updateKeywordStatus: document.getElementById('update-keyword-status'),
            gameCompletionModal: document.getElementById('game-completion-modal'),
            gameCompletionContent: document.getElementById('game-completion-content'),
            langUiBtn: document.getElementById('lang-ui-btn'),
            langUiDropdown: document.getElementById('lang-ui-dropdown'),
            navLangLearn: document.getElementById('nav-lang-learn'),
            langLearnText: document.getElementById('lang-learn-text'),
            langLearnDropdown: document.getElementById('lang-learn-dropdown'),
            navLangMobileToggle: document.getElementById('nav-lang-mobile-toggle'),
            langLearnTextMobile: document.getElementById('lang-learn-text-mobile'),
            navLangMobileDropdown: document.getElementById('nav-lang-mobile-dropdown'),
            langLearnCaretMobile: document.getElementById('lang-learn-caret-mobile'),
        };


        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                setupRealtimeListeners();
            } else {
                userId = null;
                if(unsubscribeCards) unsubscribeCards();
                if(unsubscribeProfile) unsubscribeProfile();
                allCards = {};
                userProfile = { totalScore: 0, weeklyScore: 0, patentLevel: 0, leagueId: null, email: '', username: '', keyword: '', createdAt: '' };
                toggleUI(false);
            }
        });

        function toggleUI(isAuthenticated) {
            dom.loadingOverlay.classList.add('visible');
            if(isAuthenticated) {
                showView('srs');
                dom.authModal.classList.remove('visible');
                dom.authLinks.style.display = 'none';
                dom.userMenu.style.display = 'block';
                const displayName = userProfile.username || userProfile.email;
                dom.userNameDisplay.textContent = displayName;
                dom.userNameDisplay.title = displayName;
            } else {
                dom.mainContainer.style.display = 'none';
                dom.gameContainer.style.display = 'none';
                dom.statsContainer.style.display = 'none';
                dom.authLinks.style.display = 'block';
                dom.userMenu.style.display = 'none';
                setAuthMode('login'); // Reset auth modal to login
                dom.authModal.classList.add('visible');
            }
            setTimeout(() => {
                dom.loadingOverlay.classList.remove('visible');
            }, 1000);
        }
        
        // --- SINCRONIZAÇÃO COM FIREBASE ---
        function setupRealtimeListeners() {
            setupRealtimeCardListener();
            setupRealtimeProfileListener();
        }

        function getDbPath(type = 'cards', targetUserId = null) {
             const uid = targetUserId || userId;
             if (!uid) return null;

             const modePaths = { kanji: 'kanjiCards', hiragana: 'hiraganaCards', katakana: 'katakanaCards', english: 'englishCards' };
             if (type === 'cards') return `artifacts/${appId}/users/${uid}/${modePaths[currentLearningMode]}`;
             if (type === 'profile') return `artifacts/${appId}/userProfiles/${uid}`;
             if (type === 'leagues') return `artifacts/${appId}/leagues`;
             return `artifacts/${appId}`;
        }

        function getCurrentDeck() { return allCards[currentLearningMode] || []; }
        
        function setupRealtimeCardListener() {
            if (unsubscribeCards) unsubscribeCards();
            const path = getDbPath('cards');
            if (!path) return;
            const cardsRef = ref(db, path);
            unsubscribeCards = onValue(cardsRef, (snapshot) => {
                const data = snapshot.val();
                allCards[currentLearningMode] = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                filterCardsDueToday();
                if (dom.manageModal.classList.contains('visible')) renderManageView();
            }, (error) => console.error("Erro ao ouvir cards:", error));
        }
        
        function setupRealtimeProfileListener() {
            if (unsubscribeProfile) unsubscribeProfile();
            const path = getDbPath('profile');
            if (!path) return;
            const profileRef = ref(db, path);
            unsubscribeProfile = onValue(profileRef, async (snapshot) => {
                if (snapshot.exists()) {
                    userProfile = { ...snapshot.val(), uid: userId };
                    await checkAndAssignLeague();
                    toggleUI(true); // Atualiza a UI com os dados do perfil
                } 
            });
        }

        // --- SISTEMA DE PONTUAÇÃO ---
        async function updateScore(points, correct = 0, incorrect = 0) {
            if (!userId) return;

            const newWeeklyScore = (userProfile.weeklyScore || 0) + points;
            const newTotalScore = (userProfile.totalScore || 0) + points;
            const newCorrectAnswers = (userProfile.correctAnswers || 0) + correct;
            const newIncorrectAnswers = (userProfile.incorrectAnswers || 0) + incorrect;

            const profileRef = ref(db, getDbPath('profile'));
            await update(profileRef, {
                totalScore: newTotalScore,
                weeklyScore: newWeeklyScore,
                correctAnswers: newCorrectAnswers,
                incorrectAnswers: newIncorrectAnswers
            });

            if (userProfile.leagueId && userProfile.leagueWeek) {
                const leagueMemberRef = ref(db, `${getDbPath('leagues')}/${userProfile.leagueWeek}/${userProfile.leagueId}/members/${userId}`);
                await set(leagueMemberRef, {
                    uid: userId,
                    username: userProfile.username,
                    weeklyScore: newWeeklyScore
                });
            }
        }

        // --- SISTEMA DE LIGAS ---
        function getWeekId(date = new Date()) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return `${date.getFullYear()}-${Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7)}`;
        }

        async function checkAndAssignLeague() {
            const currentWeekId = getWeekId();
            if (userProfile.leagueId && userProfile.leagueWeek === currentWeekId) {
                return; 
            }
            
            const profileUpdates = {};

            if (userProfile.leagueWeek && userProfile.leagueWeek !== currentWeekId) {
                 const oldLeagueRef = ref(db, `${getDbPath('leagues')}/${userProfile.leagueWeek}/${userProfile.leagueId}`);
                 const oldLeagueSnap = await get(oldLeagueRef);
                 if(oldLeagueSnap.exists()){
                     const members = oldLeagueSnap.val().members;
                     if (members) {
                        const sortedMembers = Object.values(members).sort((a,b) => b.weeklyScore - a.weeklyScore);
                        const userRank = sortedMembers.findIndex(m => m.uid === userId);
                        if (userRank !== -1) {
                            if (userRank < 5) profileUpdates.patentLevel = Math.min(patents.length - 1, userProfile.patentLevel + 1);
                            else if (userRank >= 25) profileUpdates.patentLevel = Math.max(0, userProfile.patentLevel - 1);
                        }
                     }
                 }
            }

            profileUpdates.weeklyScore = 0;
            
            const leaguesRef = ref(db, `${getDbPath('leagues')}/${currentWeekId}`);
            const snapshot = await get(leaguesRef);
            const leagues = snapshot.val() || {};
            let assigned = false;
            
            for (const leagueId in leagues) {
                const league = leagues[leagueId];
                if (league.patentLevel === (profileUpdates.patentLevel ?? userProfile.patentLevel) && league.members && Object.keys(league.members).length < 30) {
                    profileUpdates.leagueId = leagueId;
                    assigned = true;
                    break;
                }
            }

            if (!assigned) {
                const newLeagueRef = push(leaguesRef);
                profileUpdates.leagueId = newLeagueRef.key;
                await set(newLeagueRef, { patentLevel: (profileUpdates.patentLevel ?? userProfile.patentLevel), members: {}, createdAt: Date.now() });
            }
            
            profileUpdates.leagueWeek = currentWeekId;
            const userInLeagueRef = ref(db, `${getDbPath('leagues')}/${currentWeekId}/${profileUpdates.leagueId}/members/${userId}`);
            await set(userInLeagueRef, { uid: userId, username: userProfile.username, weeklyScore: 0 });
            await update(ref(db, getDbPath('profile')), profileUpdates);
        }

        // --- NAVEGAÇÃO E UI GERAL ---
        dom.loginNavBtn.addEventListener('click', () => dom.authModal.classList.add('visible'));
        dom.userMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); dom.userMenuDropdown.classList.toggle('visible'); });
        
        // Dropdown listeners
        window.addEventListener('click', (e) => {
            const closeDropdowns = (dropdownsToExclude = []) => {
                const allDropdowns = [dom.userMenuDropdown, dom.navGamesDropdown, dom.studyModeDropdown, dom.langUiDropdown, dom.langLearnDropdown];
                allDropdowns.forEach(dd => {
                    if (dd && !dropdownsToExclude.includes(dd)) dd.classList.remove('visible');
                });
            };

            if (dom.userMenu && !dom.userMenu.contains(e.target)) dom.userMenuDropdown.classList.remove('visible');
            if (dom.navGames.parentElement && !dom.navGames.parentElement.contains(e.target)) dom.navGamesDropdown.classList.remove('visible');
            if (dom.navStudy.parentElement && !dom.navStudy.parentElement.contains(e.target)) dom.studyModeDropdown.classList.remove('visible');
            if (dom.langUiBtn.parentElement && !dom.langUiBtn.parentElement.contains(e.target)) dom.langUiDropdown.classList.remove('visible');
            if (dom.navLangLearn.parentElement && !dom.navLangLearn.parentElement.contains(e.target)) dom.langLearnDropdown.classList.remove('visible');
        });

        dom.langUiBtn.addEventListener('click', (e) => {e.stopPropagation(); dom.langUiDropdown.classList.toggle('visible'); });
        dom.navLangLearn.addEventListener('click', (e) => {e.stopPropagation(); e.preventDefault(); dom.langLearnDropdown.classList.toggle('visible');});


        function showView(viewName) {
            dom.mainContainer.style.display = 'none';
            dom.gameContainer.style.display = 'none';
            dom.statsContainer.style.display = 'none';
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

            if (viewName === 'srs') {
                dom.mainContainer.style.display = 'flex';
                dom.navStudy.classList.add('active');
            } else if (viewName.startsWith('game-')) {
                dom.gameContainer.style.display = 'flex';
                dom.navGames.classList.add('active');
            } else if (viewName === 'manage') {
                dom.mainContainer.style.display = 'flex';
                dom.navManage.classList.add('active');
                dom.manageModal.classList.add('visible');
                renderManageView();
            } else if (viewName === 'stats') { 
                dom.statsContainer.style.display = 'flex';
                dom.navStats.classList.add('active');
                renderStatsView(); 
            } else if (viewName === 'leaderboard') {
                dom.mainContainer.style.display = 'flex';
                dom.navLeaderboard.classList.add('active');
                openLeaderboard();
            }
        }
        dom.homeLogo.addEventListener('click', (e) => { e.preventDefault(); showView('srs'); filterCardsDueToday(); });
        dom.navGames.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); dom.navGamesDropdown.classList.toggle('visible'); });
        dom.navStudy.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); if(e.target.closest('.dropdown')) { dom.studyModeDropdown.classList.toggle('visible'); } else { showView('srs'); filterCardsDueToday(); } });

        function updateStudyModeUI() {
            const studyDropdown = dom.studyModeDropdown;
            const studyDropdownMobile = dom.navStudyMobileDropdown;
            const gamesDropdown = dom.navGamesDropdown;
            const gamesDropdownMobile = dom.navGamesMobileDropdown;

            studyDropdown.innerHTML = '';
            studyDropdownMobile.innerHTML = '';
            gamesDropdown.innerHTML = '';
            gamesDropdownMobile.innerHTML = '';

            const langPrefix = translations[currentUILanguage]['study_mode_select'] || 'Estudar';
            
            if (currentLearningLanguage === 'jp') {
                const modes = [
                    { key: 'kanji', name: 'Kanji' },
                    { key: 'hiragana', name: 'Hiragana' },
                    { key: 'katakana', name: 'Katakana' },
                ];
                modes.forEach(mode => {
                    studyDropdown.innerHTML += `<button data-mode="${mode.key}" class="mode-select-btn">${mode.name}</button>`;
                    studyDropdownMobile.innerHTML += `<button data-mode="${mode.key}" class="mode-select-btn-mobile block text-sm py-2 text-gray-600 hover:text-accent-primary rounded-md px-3 w-full text-left">${mode.name}</button>`;
                });
                
                const games = [
                    { id: 'match', name: 'Combine'},
                    { id: 'quiz', name: 'Quiz'},
                    { id: 'type', name: 'Digite a Leitura'},
                    { id: 'memory', name: 'Jogo da Memória'},
                ]
                games.forEach(game => {
                    gamesDropdown.innerHTML += `<a href="#" class="game-start-btn" data-game="${game.id}">${game.name}</a>`;
                    gamesDropdownMobile.innerHTML += `<a href="#" class="game-start-btn-mobile block text-sm py-2 text-gray-600 hover:text-accent-primary rounded-md px-3" data-game="${game.id}">${game.name}</a>`;
                });

                setLearningMode(currentLearningMode === 'english' ? 'kanji' : currentLearningMode);
            } else if (currentLearningLanguage === 'en') {
                studyDropdown.innerHTML = `<button data-mode="english" class="mode-select-btn">Inglês</button>`;
                studyDropdownMobile.innerHTML = `<button data-mode="english" class="mode-select-btn-mobile block text-sm py-2 text-gray-600 hover:text-accent-primary rounded-md px-3 w-full text-left">Inglês</button>`;
                gamesDropdown.innerHTML = `<p class="p-4 text-sm text-gray-500">Jogos para inglês em breve!</p>`;
                gamesDropdownMobile.innerHTML = `<p class="p-4 text-sm text-gray-500">Jogos para inglês em breve!</p>`;
                setLearningMode('english');
            }

            // Re-add event listeners for the new buttons
            document.querySelectorAll('.mode-select-btn, .mode-select-btn-mobile').forEach(btn => {
                btn.addEventListener('click', () => {
                    setLearningMode(btn.dataset.mode);
                    if (btn.classList.contains('mode-select-btn-mobile')) closeMobileMenu();
                });
            });
            document.querySelectorAll('.game-start-btn, .game-start-btn-mobile').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const gameId = btn.dataset.game;
                    const gameFunctions = { 'match': startMatchingGame, 'quiz': startQuizGame, 'type': startTypingGame, 'memory': startMemoryGame };
                    if(gameFunctions[gameId]) gameFunctions[gameId]();
                    if (btn.classList.contains('game-start-btn-mobile')) closeMobileMenu();
                });
            });
        }


        function setLearningLanguage(lang) {
            currentLearningLanguage = lang;
            const langName = lang === 'jp' ? 'Japonês' : 'Inglês';
            const text = `${translations[currentUILanguage]['learn_language_select'] || 'Aprender'}: ${langName}`;
            dom.langLearnText.textContent = text;
            dom.langLearnTextMobile.textContent = text;
            document.querySelectorAll('.lang-learn-btn, .lang-learn-btn-mobile').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            updateStudyModeUI();
        }


        function setLearningMode(mode) {
            currentLearningMode = mode;
            let modeName = '';
            if (mode === 'english') {
                modeName = 'Inglês';
            } else {
                modeName = mode.charAt(0).toUpperCase() + mode.slice(1);
            }
            const text = `${translations[currentUILanguage]['study_mode_select'] || 'Estudar'}: ${modeName}`;
            dom.studyModeText.textContent = text;
            dom.studyModeTextMobile.textContent = text;

            document.querySelectorAll('.mode-select-btn, .mode-select-btn-mobile').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            dom.studyModeDropdown.classList.remove('visible');
            showView('srs');
            setupRealtimeCardListener();
        }
        
        document.querySelectorAll('.lang-learn-btn, .lang-learn-btn-mobile').forEach(btn => {
            btn.addEventListener('click', () => {
                setLearningLanguage(btn.dataset.lang);
                if (btn.classList.contains('lang-learn-btn-mobile')) closeMobileMenu();
            });
        });
        document.querySelectorAll('.lang-ui-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                translateUI(btn.dataset.lang);
                document.querySelectorAll('.lang-ui-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                dom.langUiDropdown.classList.remove('visible');
            });
        });

        function openMobileMenu() { dom.mobileMenu.classList.remove('-translate-x-full'); dom.menuOverlay.style.display = 'block'; setTimeout(() => dom.menuOverlay.style.opacity = '1', 10); }
        function closeMobileMenu() { dom.mobileMenu.classList.add('-translate-x-full'); dom.menuOverlay.style.opacity = '0'; setTimeout(() => dom.menuOverlay.style.display = 'none', 300); }
        dom.hamburgerBtn.addEventListener('click', openMobileMenu);
        dom.closeMobileMenuBtn.addEventListener('click', closeMobileMenu);
        dom.menuOverlay.addEventListener('click', closeMobileMenu);
        function toggleMobileDropdown(dropdownEl, caretEl) { const isHidden = dropdownEl.style.display === 'none' || dropdownEl.style.display === ''; dropdownEl.style.display = isHidden ? 'block' : 'none'; caretEl.classList.toggle('open', isHidden); }
        dom.navLangMobileToggle.addEventListener('click', () => toggleMobileDropdown(dom.navLangMobileDropdown, dom.langLearnCaretMobile));
        dom.navStudyMobileToggle.addEventListener('click', () => toggleMobileDropdown(dom.navStudyMobileDropdown, dom.studyCaretMobile));
        dom.navGamesMobileToggle.addEventListener('click', () => toggleMobileDropdown(dom.navGamesMobileDropdown, dom.gamesCaretMobile));
        dom.navManageMobile.addEventListener('click', (e) => { e.preventDefault(); showView('manage'); closeMobileMenu(); });
        dom.navStatsMobile.addEventListener('click', (e) => { e.preventDefault(); showView('stats'); closeMobileMenu(); });
        dom.navLeaderboardMobile.addEventListener('click', (e) => { e.preventDefault(); showView('leaderboard'); closeMobileMenu(); });
        
        dom.navStats.addEventListener('click', (e) => { e.preventDefault(); showView('stats'); });
        
        // --- LÓGICA DO SRS ---
        function filterCardsDueToday() { isStudyMoreSession = false; srsSessionStats = { correct: 0, incorrect: 0 }; const now = new Date(); now.setHours(0, 0, 0, 0); const deck = getCurrentDeck(); dueCards = deck.filter(card => { const interval = card.srsInterval === undefined ? 0 : card.srsInterval; if (interval === 0) return true; const lastReviewDate = new Date(card.lastReview); lastReviewDate.setHours(0,0,0,0); lastReviewDate.setDate(lastReviewDate.getDate() + interval); return now >= lastReviewDate; }); dueCards.sort(() => Math.random() - 0.5); sessionInitialCount = dueCards.length; updateProgress(); nextCard(); } 
        
        function nextCard() { isCardFlipped = false; dom.reviewCard.classList.remove('is-flipped'); if (dueCards.length === 0) { currentCard = null; displayCompletion(); return; } currentCard = dueCards[0]; displayCard(); } 
        
        // CORREÇÃO: Função modificada para exibir frases em inglês na frente do card
        function displayCard() { 
            let frontText, textToSpeak;
            const langClass = currentLearningLanguage === 'jp' ? 'jp' : 'en';
            const classFontSize = currentLearningLanguage ===  'jp' ? 'clamp(5rem, 10vw, 15em)' : 'clamp(1.5rem, 2.5vw, 4rem)';

            if (currentLearningLanguage === 'en' && currentCard.geminiInfo && currentCard.geminiInfo.sentences && currentCard.geminiInfo.sentences.length > 0) {
                // Para inglês, mostra a primeira frase de exemplo na frente
                frontText = currentCard.geminiInfo.sentences[0].english;
                textToSpeak = frontText;
            } else {
                // Comportamento padrão para japonês ou se não houver frase em inglês
                frontText = currentCard.displayKanji || currentCard.kanji;
                textToSpeak = frontText;
            }
            
            // Escapa caracteres especiais para o HTML onclick
            const escapedTextToSpeak = textToSpeak.replace(/['`]/g, "\\$&").replace(/\n/g, ' ');

            // Usa ícone em vez de imagem e ajusta o estilo para frases
            dom.cardFront.innerHTML = `<button class="sound-btn" onclick="window.speak('${escapedTextToSpeak}', '${currentLearningLanguage}')"><i class="ph ph-speaker-high text-2xl"></i></button><p class="question-text ${langClass}" style="font-size: ${classFontSize}; padding: 0 2rem;">${frontText}</p>`; 
            dom.cardBack.innerHTML = renderAnswerContent(currentCard); 
            renderActionButtons('show_answer'); 
        } 
        
        function renderAnswerContent(card) { 
            const mainChar = card.displayKanji || card.kanji;
            const langClass = currentLearningLanguage === 'jp' ? 'jp' : 'en';
            // Para o botão de som principal no verso, o áudio deve corresponder à palavra principal
            const textToSpeakOnBack = (currentLearningLanguage === 'en') ? card.kanji : mainChar;
            const escapedTextToSpeakOnBack = textToSpeakOnBack.replace(/['`]/g, "\\$&");

            let geminiContent = ''; 
            if (card.geminiInfo) { 
                const info = card.geminiInfo; 
                geminiContent += `<div class="w-full text-left mt-4 gemini-info-section">`; 
                if (info.sentences && info.sentences.length > 0) { 
                    geminiContent += `<h3 data-translate="example_sentences">${translations[currentUILanguage].example_sentences}</h3><ul>`; 
                    info.sentences.forEach(s => { 
                        const sentenceKey = currentLearningLanguage === 'jp' ? 'japanese' : 'english';
                        const translationKey = currentLearningLanguage === 'jp' ? 'portuguese' : 'translation';
                        const readingKey = 'reading';

                        const originalSentence = s[sentenceKey];
                        const escapedSentence = originalSentence.replace(/['`]/g, "\\$&").replace(/\n/g, ' ');
                        const reading = s[readingKey] ? `<p class="reading">${s[readingKey]}</p>` : '';
                        
                        geminiContent += `<li class="sentence"><div class="flex items-center gap-2"><div class="flex-grow"><p class="${langClass}">${originalSentence}</p>${reading}<p>${s[translationKey]}</p></div><button class="sound-btn-sentence" onclick="window.speak(\`${escapedSentence}\`, \'${currentLearningLanguage}\')"><i class="ph ph-speaker-high text-xl"></i></button></div></li>`; 
                    }); 
                    geminiContent += `</ul>`; 
                } 
                if (info.curiosities) { geminiContent += `<h3 data-translate="curiosities">${translations[currentUILanguage].curiosities}</h3><p>${info.curiosities}</p>`; } 
                if (info.grammar) { geminiContent += `<h3 data-translate="grammar_tip">${translations[currentUILanguage].grammar_tip}</h3><p>${info.grammar}</p>`; } 
                geminiContent += `</div>`; 
            } 
            
            // No verso, para o inglês, mostramos a palavra principal que foi usada para gerar as frases.
            const mainDisplayOnBack = (currentLearningLanguage === 'en') ? card.kanji : mainChar;

            return `<button class="sound-btn" onclick="window.speak('${escapedTextToSpeakOnBack}', '${currentLearningLanguage}')"><i class="ph ph-speaker-high text-2xl"></i></button><div class="flex-grow w-full flex flex-col items-center justify-start text-center"><p style="font-size: clamp(3.5rem, 12vw, 5rem);" class="${langClass}">${mainDisplayOnBack}</p><p class="text-2xl mt-4 font-bold">${card.meaning}</p><p class="text-lg text-gray-600 mt-2">${card.pronunciation}</p>${geminiContent}</div>`; 
        }

        function renderActionButtons(state) {
            if (state === 'show_answer') {
                dom.feedbackButtons.innerHTML = `<button id="check-btn" class="btn btn-primary col-span-2" data-translate="show_answer">${translations[currentUILanguage].show_answer}</button>`;
                document.getElementById('check-btn').addEventListener('click', () => {
                    isCardFlipped = true;
                    dom.reviewCard.classList.add('is-flipped');
                    renderActionButtons('show_feedback');
                });
            } else if (state === 'show_feedback') {
                dom.feedbackButtons.innerHTML = `
                    <button class="btn btn-danger" id="hard-btn-back" data-translate="hard">${translations[currentUILanguage].hard}</button>
                    <button class="btn btn-success" id="easy-btn-back" data-translate="easy">${translations[currentUILanguage].easy}</button>
                    <button id="flip-back-btn" class="btn btn-secondary col-span-2 mt-2" data-translate="show_front">${translations[currentUILanguage].show_front}</button>
                `;
                document.getElementById('hard-btn-back').addEventListener('click', () => handleFeedback(false));
                document.getElementById('easy-btn-back').addEventListener('click', () => handleFeedback(true));
                document.getElementById('flip-back-btn').addEventListener('click', () => {
                    isCardFlipped = false;
                    dom.reviewCard.classList.remove('is-flipped');
                    renderActionButtons('show_answer');
                });
            }
        }
        
        function displayCompletion() {
            dom.cardFront.innerHTML = '';
            dom.cardBack.innerHTML = '';

            const wasSession = sessionInitialCount > 0;
            const title = wasSession ? translations[currentUILanguage].congratulations : translations[currentUILanguage].all_up_to_date;
            const subtitle = wasSession ? translations[currentUILanguage].review_complete : `${translations[currentUILanguage].no_review_left} ${currentLearningMode}.`;
            const totalPoints = srsSessionStats.correct * 10;

            const completionHTML = `
                <div class="completion-container">
                    <h2 class="completion-title">${title}</h2>
                    <p class="completion-subtitle">${subtitle}</p>
                    ${wasSession ? `
                    <div class="score-display">
                        <div class="label">${translations[currentUILanguage].session_score}</div>
                        <div class="score-value" id="animated-score">0</div>
                        <div class="score-details">(${srsSessionStats.correct} ${translations[currentUILanguage].correct_answers_short}, ${srsSessionStats.incorrect} ${translations[currentUILanguage].incorrect_answers_short})</div>
                    </div>` : ''}
                </div>
            `;
            dom.cardFront.innerHTML = completionHTML;

            dom.feedbackButtons.innerHTML = ``;
            
            if (wasSession) {
                playVictorySound();
                const scoreElement = document.getElementById('animated-score');
                if (scoreElement) {
                    let currentScore = 0;
                    const increment = Math.max(1, Math.ceil(totalPoints / 60)); 
                    function animateScore() {
                        currentScore += increment;
                        if (currentScore >= totalPoints) {
                            scoreElement.textContent = totalPoints;
                        } else {
                            scoreElement.textContent = currentScore;
                            requestAnimationFrame(animateScore);
                        }
                    }
                    setTimeout(() => requestAnimationFrame(animateScore), 600);
                }
            }
        }
        function startStudyMoreSession() { const deck = getCurrentDeck(); if (!deck || deck.length === 0) return; const shuffled = [...deck].sort(() => 0.5 - Math.random()); dueCards = shuffled.slice(0, 10); sessionInitialCount = dueCards.length; isStudyMoreSession = true; srsSessionStats = { correct: 0, incorrect: 0 }; updateProgress(); nextCard(); } dom.studyMoreBtn.addEventListener('click', startStudyMoreSession); function updateProgress() { const reviewed = sessionInitialCount - dueCards.length; const total = sessionInitialCount; const percentage = total > 0 ? (reviewed / total) * 100 : 0; dom.progressBar.style.width = `${percentage}%`; dom.progressText.textContent = `${reviewed} / ${total}`; }
        async function handleFeedback(isCorrect) {
            if (!currentCard) return;
            isCorrect ? playCorrectSound() : playIncorrectSound();
            if (isCorrect) srsSessionStats.correct++; else srsSessionStats.incorrect++;
            updateScore(isCorrect ? 10 : 0, isCorrect ? 1 : 0, isCorrect ? 0 : 1);
            
            const cardToUpdate = { ...currentCard };
            dueCards.shift();
            
            if (!isStudyMoreSession) {
                let currentInterval = cardToUpdate.srsInterval || 0;
                let newInterval;
                if (isCorrect) {
                    if (currentInterval === 0) newInterval = 1;
                    else if (currentInterval === 1) newInterval = 2;
                    else newInterval = Math.min(50, currentInterval + 2);
                } else {
                    newInterval = 0;
                    dueCards.push(cardToUpdate); 
                }
                
                const cardRef = ref(db, `${getDbPath('cards')}/${cardToUpdate.id}`);
                const updatedData = { ...cardToUpdate, srsInterval: newInterval, lastReview: new Date().toISOString() };
                delete updatedData.id;
                await set(cardRef, updatedData);
            } else if (!isCorrect) {
                dueCards.push(cardToUpdate);
            }
            updateProgress();
            nextCard();
        }
        window.speak = speak;
        
        // --- JOGOS ---
        function renderGameUI(title, description, content) { dom.gameContainer.innerHTML = `<div class="text-center mb-8"><h2 class="text-3xl font-bold">${title}</h2><p class="text-gray-500 mt-2">${description}</p></div><div id="game-content">${content}</div>`; } 
        
        function renderGameCompletion(playAgainFunction, correct, incorrect, points) {
            const totalPoints = points + 50;
            updateScore(totalPoints, correct, incorrect);
            playVictorySound();
            dom.gameContainer.innerHTML = '';

            const modalContentHTML = `
                <div class="completion-container">
                    <h2 class="completion-title" data-translate="congrats_challenge">${translations[currentUILanguage].congrats_challenge}</h2>
                    <p class="completion-subtitle" data-translate="challenge_complete">${translations[currentUILanguage].challenge_complete}</p>
                    <div class="score-display">
                        <div class="label" data-translate="points_earned">${translations[currentUILanguage].points_earned}</div>
                        <div class="score-value" id="animated-score-modal">0</div>
                        <div class="score-details">(${correct} ${translations[currentUILanguage].correct_answers_short}, ${incorrect} ${translations[currentUILanguage].incorrect_answers_short} + 50 ${translations[currentUILanguage].bonus_points})</div>
                    </div>
                     <div class="flex flex-col sm:flex-row gap-4 mt-12 w-full max-w-sm">
                        <button id="play-again-btn-modal" class="btn btn-primary w-full" data-translate="play_again">${translations[currentUILanguage].play_again}</button>
                        <button id="return-to-menu-btn-modal" class="btn btn-secondary w-full" data-translate="return_to_menu">${translations[currentUILanguage].return_to_menu}</button>
                    </div>
                </div>
            `;
            dom.gameCompletionContent.innerHTML = modalContentHTML;
            dom.gameCompletionModal.classList.add('visible');

            document.getElementById('play-again-btn-modal').addEventListener('click', () => {
                dom.gameCompletionModal.classList.remove('visible');
                playAgainFunction();
            });
            document.getElementById('return-to-menu-btn-modal').addEventListener('click', () => {
                dom.gameCompletionModal.classList.remove('visible');
                showView('srs');
                filterCardsDueToday();
            });

            const scoreElement = document.getElementById('animated-score-modal');
            let currentScore = 0;
            const increment = Math.max(1, Math.ceil(totalPoints / 60)); 

            function animateScore() {
                currentScore += increment;
                if (currentScore >= totalPoints) {
                    scoreElement.textContent = totalPoints;
                } else {
                    scoreElement.textContent = currentScore;
                    requestAnimationFrame(animateScore);
                }
            }
            setTimeout(() => requestAnimationFrame(animateScore), 300);
        }

        function getGameCards(count = 5) { const deck = getCurrentDeck(); if (deck.length < count) { dom.gameContainer.innerHTML = `<div class="text-center"><h2 class="text-2xl font-bold">${translations[currentUILanguage].insufficient_cards}</h2><p>${translations[currentUILanguage].need_at_least} ${count} ${currentLearningMode} ${translations[currentUILanguage].cards_to_play}</p></div>`; return null; } return [...deck].sort(() => 0.5 - Math.random()).slice(0, count); }
        function startMatchingGame() { showView('game-match'); const gameCards = getGameCards(5); if (!gameCards) return; let sessionCorrect = 0, sessionIncorrect = 0; const kanjis = gameCards.map(c => ({ id: c.id, text: c.kanji })).sort(() => 0.5 - Math.random()); const meanings = gameCards.map(c => ({ id: c.id, text: c.meaning })).sort(() => 0.5 - Math.random()); const content = `<div class="game-board" style="grid-template-columns: 1fr 1fr;"><div id="kanji-column" class="flex flex-col gap-4">${kanjis.map(k => `<div class="game-option jp" data-id="${k.id}">${k.text}</div>`).join('')}</div><div id="meaning-column" class="flex flex-col gap-4">${meanings.map(m => `<div class="game-option" data-id="${m.id}">${m.text}</div>`).join('')}</div></div>`; renderGameUI('Combine', 'Clique em um caractere e no seu significado correspondente.', content); let selectedKanji = null, selectedMeaning = null, correctPairs = 0; const kanjiItems = document.querySelectorAll('#kanji-column .game-option'); const meaningItems = document.querySelectorAll('#meaning-column .game-option'); function handleSelection(items, selectedItem, currentSelection) { if (currentSelection === selectedItem) { selectedItem.classList.remove('selected'); return null; } items.forEach(i => i.classList.remove('selected')); selectedItem.classList.add('selected'); return selectedItem; } function checkMatch() { if (!selectedKanji || !selectedMeaning) return; if (selectedKanji.dataset.id === selectedMeaning.dataset.id) { playCorrectSound(); speak(selectedKanji.textContent, 'jp'); selectedKanji.classList.add('correct'); selectedMeaning.classList.add('correct'); selectedKanji = null; selectedMeaning = null; correctPairs++; sessionCorrect++; if (correctPairs === gameCards.length) { setTimeout(() => renderGameCompletion(startMatchingGame, sessionCorrect, sessionIncorrect, sessionCorrect * 5), 500); } } else { playIncorrectSound(); sessionIncorrect++; selectedKanji.classList.add('incorrect'); selectedMeaning.classList.add('incorrect'); setTimeout(() => { selectedKanji?.classList.remove('incorrect', 'selected'); selectedMeaning?.classList.remove('incorrect', 'selected'); selectedKanji = null; selectedMeaning = null; }, 500); } } kanjiItems.forEach(item => item.addEventListener('click', () => { if (item.classList.contains('correct')) return; selectedKanji = handleSelection(kanjiItems, item, selectedKanji); checkMatch(); })); meaningItems.forEach(item => item.addEventListener('click', () => { if (item.classList.contains('correct')) return; selectedMeaning = handleSelection(meaningItems, item, selectedMeaning); checkMatch(); })); }
        function startQuizGame() { showView('game-quiz'); const gameCards = getGameCards(10); if (!gameCards || gameCards.length < 4) { return; } let currentQuestionIndex = 0; let sessionCorrect = 0, sessionIncorrect = 0; function displayQuestion() { const card = gameCards[currentQuestionIndex]; const incorrectAnswers = getCurrentDeck().filter(c => c.id !== card.id).sort(() => 0.5 - Math.random()).slice(0, 3).map(c => c.meaning); const options = [card.meaning, ...incorrectAnswers].sort(() => 0.5 - Math.random()); const content = `<div class="text-center text-7xl font-bold font-['Noto_Sans_JP'] mb-8">${card.kanji}</div><div class="game-board" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">${options.map(opt => `<div class="game-option" data-correct="${opt === card.meaning}">${opt}</div>`).join('')}</div>`; renderGameUI('Quiz', `Qual o significado deste caractere? (${currentQuestionIndex + 1}/${gameCards.length})`, content); document.querySelectorAll('.game-option').forEach(option => { option.addEventListener('click', () => { document.querySelectorAll('.game-option').forEach(btn => btn.style.pointerEvents = 'none'); const isCorrect = option.dataset.correct === 'true'; option.classList.add(isCorrect ? 'correct' : 'incorrect'); if(isCorrect) { sessionCorrect++; playCorrectSound(); speak(card.kanji, 'jp'); } else { sessionIncorrect++; playIncorrectSound(); } if (!isCorrect) { document.querySelector('.game-option[data-correct="true"]').classList.add('correct'); } setTimeout(() => { currentQuestionIndex++; if (currentQuestionIndex < gameCards.length) { displayQuestion(); } else { renderGameCompletion(startQuizGame, sessionCorrect, sessionIncorrect, sessionCorrect * 5); } }, 1500); }); }); } displayQuestion(); }
        function startTypingGame() { showView('game-type'); const gameCards = getGameCards(10); if (!gameCards) { return; } let currentQuestionIndex = 0; let sessionCorrect = 0, sessionIncorrect = 0; function displayQuestion() { const card = gameCards[currentQuestionIndex]; const content = `<div class="text-center"><div class="text-7xl font-bold font-['Noto_Sans_JP']">${card.kanji}</div><div class="text-2xl text-gray-500 mt-2">${card.meaning}</div><input type="text" id="typing-input" class="input mt-8 text-2xl text-center" placeholder="Digite a leitura (romaji)" autocomplete="off" autocorrect="off" spellcheck="false"><p id="typing-feedback" class="mt-4 h-6 font-bold"></p></div>`; renderGameUI('Digite a Leitura', `Escreva a pronúncia e pressione Enter (${currentQuestionIndex + 1}/${gameCards.length})`, content); const input = document.getElementById('typing-input'); input.focus(); input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const feedback = document.getElementById('typing-feedback'); const isCorrect = input.value.toLowerCase().trim() === card.pronunciation.toLowerCase().trim(); if (isCorrect) { sessionCorrect++; input.classList.add('correct'); feedback.textContent = 'Correto!'; feedback.style.color = 'var(--success)'; playCorrectSound(); speak(card.kanji, 'jp'); } else { sessionIncorrect++; input.classList.add('incorrect'); feedback.innerHTML = `Incorreto. A resposta era: <strong>${card.pronunciation}</strong>`; feedback.style.color = 'var(--danger)'; playIncorrectSound(); } input.disabled = true; setTimeout(() => { currentQuestionIndex++; if (currentQuestionIndex < gameCards.length) { displayQuestion(); } else { renderGameCompletion(startTypingGame, sessionCorrect, sessionIncorrect, sessionCorrect * 5); } }, 1500); } }); } displayQuestion(); }
        
        function startMemoryGame() {
            showView('game-memory');
            const gameCards = getGameCards(8);
            if (!gameCards) { return; }
            let sessionCorrect = 0, sessionIncorrect = 0;
            let items = [];
            gameCards.forEach(card => {
                items.push({ type: 'kanji', text: card.kanji, id: card.id });
                items.push({ type: 'meaning', text: card.meaning, id: card.id });
            });
            items.sort(() => 0.5 - Math.random());
            
            const gogoChanSVG = `<svg class="memory-card-gogo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><g transform="translate(50, 50)"><path d="M0,-15 Q20,-10 20,10 Q20,25 0,33 Q-20,25 -20,10 Q-20,-10 0,-15 Z" fill="#fff"/><circle cx="0" cy="-18" r="16" fill="#fff"/><circle cx="-6" cy="-20" r="2" fill="#6D28D9"/><circle cx="6" cy="-20" r="2" fill="#6D28D9"/></g></svg>`;

            const content = `<div class="memory-grid">${items.map((item, index) => `
                <div class="memory-card" data-id="${item.id}" data-index="${index}" data-text="${item.text}" data-type="${item.type}">
                    <div class="memory-card-face memory-card-front">${gogoChanSVG}</div>
                    <div class="memory-card-face memory-card-back ${item.type === 'kanji' ? 'jp' : ''}">${item.text}</div>
                </div>`).join('')}
            </div>`;
            
            renderGameUI('Jogo da Memória', 'Encontre os pares de caractere e significado.', content);
            
            let flippedCards = [];
            let matchedPairs = 0;
            let canFlip = true;

            document.querySelectorAll('.memory-card').forEach(card => card.addEventListener('click', () => {
                if (!canFlip || flippedCards.length >= 2 || card.classList.contains('flipped') || card.classList.contains('matched')) return;
                card.classList.add('flipped');
                flippedCards.push(card);
                if (flippedCards.length === 2) {
                    canFlip = false;
                    const [card1, card2] = flippedCards;
                    if (card1.dataset.id === card2.dataset.id) {
                        sessionCorrect++;
                        playCorrectSound();
                        const kanjiText = card1.dataset.type === 'kanji' ? card1.dataset.text : card2.dataset.text;
                        speak(kanjiText, 'jp');
                        setTimeout(() => {
                             card1.classList.add('matched');
                             card2.classList.add('matched');
                             matchedPairs++;
                             flippedCards = [];
                             canFlip = true;
                             if (matchedPairs === gameCards.length) {
                                setTimeout(() => renderGameCompletion(startMemoryGame, sessionCorrect, sessionIncorrect, sessionCorrect * 10), 500);
                             }
                        }, 500);
                    } else {
                        sessionIncorrect++;
                        playIncorrectSound();
                        setTimeout(() => {
                            card1.classList.remove('flipped');
                            card2.classList.remove('flipped');
                            flippedCards = [];
                            canFlip = true;
                        }, 1200);
                    }
                }
            }));
        }
        
        // --- GERENCIAMENTO E PAGINAÇÃO ---
        dom.navManage.addEventListener('click', (e) => { e.preventDefault(); showView('manage'); }); dom.closeManageModalBtn.addEventListener('click', () => dom.manageModal.classList.remove('visible')); dom.addNewCardBtn.addEventListener('click', () => openAddEditModal()); dom.cancelEditBtn.addEventListener('click', () => dom.addEditModal.classList.remove('visible')); 
        
        dom.manageAccountBtn.addEventListener('click', (e) => { 
            e.preventDefault(); 
            dom.newUsernameInput.value = userProfile.username || '';
            dom.updatePasswordForm.reset();
            dom.updateKeywordForm.reset();
            dom.updateUsernameStatus.textContent = '';
            dom.updatePasswordStatus.textContent = '';
            dom.updateKeywordStatus.textContent = '';
            dom.userManageModal.classList.add('visible'); 
            dom.userMenuDropdown.classList.remove('visible'); 
        }); 
        dom.cancelUserManageBtn.addEventListener('click', () => dom.userManageModal.classList.remove('visible')); 
        
        function renderPagination(container, currentPage, totalItems, itemsPerPage, onPageClick) {
            container.innerHTML = '';
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = '‹';
            prevButton.className = 'page-btn';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => onPageClick(currentPage - 1));
            container.appendChild(prevButton);

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = 'page-btn';
                if (i === currentPage) pageButton.classList.add('active');
                pageButton.addEventListener('click', () => onPageClick(i));
                container.appendChild(pageButton);
            }

            const nextButton = document.createElement('button');
            nextButton.textContent = '›';
            nextButton.className = 'page-btn';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => onPageClick(currentPage + 1));
            container.appendChild(nextButton);
        }

        function renderManageView() {
            let modeName = '';
            if (currentLearningMode === 'english') modeName = 'Inglês';
            else modeName = currentLearningMode.charAt(0).toUpperCase() + currentLearningMode.slice(1);
            dom.manageModalTitle.textContent = `${translations[currentUILanguage].manage} ${modeName}`;
            const deck = getCurrentDeck();
            dom.cardListContainer.innerHTML = '';
            
            if (deck.length === 0) {
                dom.cardListContainer.innerHTML = `<p class="text-center text-gray-500">${translations[currentUILanguage].no_cards_yet} ${modeName}.</p>`;
                renderPagination(dom.managePaginationContainer, 0, 0, ITEMS_PER_PAGE, () => {});
                return;
            }

            const sortedCards = [...deck].sort((a, b) => a.kanji.localeCompare(b.kanji, currentLearningLanguage === 'jp' ? 'ja' : 'en'));
            const paginatedCards = sortedCards.slice((manageCurrentPage - 1) * ITEMS_PER_PAGE, manageCurrentPage * ITEMS_PER_PAGE);

            paginatedCards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'flex items-center justify-between p-3 rounded-lg bg-white border border-gray-200';
                
                const mainDisplay = card.displayKanji || card.kanji;
                const subDisplay = card.displayKanji && card.displayKanji !== card.kanji ? ` <span class="text-base text-gray-500">(${card.kanji})</span>` : '';
                const langClass = currentLearningLanguage === 'jp' ? 'jp' : '';

                cardElement.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-xl font-bold ${langClass}">${mainDisplay}${subDisplay}</p>
                        <p class="text-sm text-gray-600">${card.meaning}</p>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <button class="edit-btn btn btn-secondary !py-1 !px-3 !text-xs">${translations[currentUILanguage].edit}</button>
                        <button class="delete-btn btn btn-danger !py-1 !px-3 !text-xs">${translations[currentUILanguage].delete}</button>
                    </div>
                `;
                cardElement.querySelector('.edit-btn').addEventListener('click', () => openAddEditModal(card));
                cardElement.querySelector('.delete-btn').addEventListener('click', () => deleteCard(card.id));
                dom.cardListContainer.appendChild(cardElement);
            });
            
            renderPagination(dom.managePaginationContainer, manageCurrentPage, sortedCards.length, ITEMS_PER_PAGE, (page) => {
                manageCurrentPage = page;
                renderManageView();
            });
        }

        function openAddEditModal(card = null) { 
            dom.addEditForm.reset(); 
            let modeName, charType;
            if(currentLearningLanguage === 'en'){
                modeName = 'Inglês';
                charType = translations[currentUILanguage].word;
                dom.displayFormField.style.display = 'none';
                dom.pronunciationLabel.textContent = translations[currentUILanguage].pronunciation;
            } else {
                modeName = currentLearningMode.charAt(0).toUpperCase() + currentLearningMode.slice(1);
                charType = currentLearningMode === 'kanji' ? translations[currentUILanguage].kanji : translations[currentUILanguage].character;
                dom.displayFormField.style.display = 'block';
                 dom.pronunciationLabel.textContent = translations[currentUILanguage].reading_romaji;
            }
             
            dom.mainCharLabel.textContent = charType; 
            if (card) { 
                dom.addEditModalTitle.textContent = `${translations[currentUILanguage].edit_card} ${modeName}`;
                dom.cardIdInput.value = card.id; 
                dom.kanjiInput.value = card.kanji; 
                dom.displayKanjiInput.value = card.displayKanji || '';
                dom.pronunciationInput.value = card.pronunciation; 
                dom.meaningInput.value = card.meaning; 
                dom.geminiDataInput.value = card.geminiInfo ? JSON.stringify(card.geminiInfo) : ''; 
            } else { 
                dom.addEditModalTitle.textContent = `${translations[currentUILanguage].add_card} ${modeName}`;
                dom.cardIdInput.value = ''; 
                dom.geminiDataInput.value = ''; 
            } 
            dom.addEditModal.classList.add('visible'); 
        } 
        
        async function deleteCard(cardId) { if (confirm(translations[currentUILanguage].confirm_delete)) { try { await remove(ref(db, `${getDbPath('cards')}/${cardId}`)); manageCurrentPage = 1; } catch(error) { console.error("Erro ao apagar card:", error); } } }
        
        // --- PLACAR / LIGAS ---
        dom.navLeaderboard.addEventListener('click', (e) => { e.preventDefault(); showView('leaderboard'); }); 
        dom.closeLeaderboardModalBtn.addEventListener('click', () => dom.leaderboardModal.classList.remove('visible'));
        
        function updateLeagueTimer() { const now = new Date(); const endOfWeek = new Date(now); endOfWeek.setDate(now.getDate() + (7 - now.getDay()) % 7); endOfWeek.setHours(23, 59, 59, 999); const diff = endOfWeek - now; const d = Math.floor(diff / (1000 * 60 * 60 * 24)); const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)); dom.leagueTimer.textContent = `${translations[currentUILanguage].ends_in}: ${d}d ${h}h ${m}m`; }
        
        function getPatentIcon(level) { const patent = patents[level]; return `<svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M24 6L8 14V34L24 42L40 34V14L24 6Z" fill="${patent.shadow}"/><path d="M24 8.25L9.5 15.1875V32.8125L24 39.75L38.5 32.8125V15.1875L24 8.25Z" fill="${patent.color}"/><path d="M24 20L15 15.5L24 11L33 15.5L24 20Z" fill="${patent.shadow}" opacity="0.5"/></svg>`; }

        async function openLeaderboard() {
            if (!userProfile.leagueId) { dom.leaderboardList.innerHTML = `<p class="text-center p-4">${translations[currentUILanguage].not_in_league}</p>`; return; }
            const patent = patents[userProfile.patentLevel];
            dom.patentName.textContent = patent.name;
            dom.patentName.style.color = patent.shadow;
            dom.patentIconContainer.innerHTML = getPatentIcon(userProfile.patentLevel);
            updateLeagueTimer();
            if (leagueTimerInterval) clearInterval(leagueTimerInterval);
            leagueTimerInterval = setInterval(updateLeagueTimer, 60000);
            
            const leagueRef = ref(db, `${getDbPath('leagues')}/${userProfile.leagueWeek}/${userProfile.leagueId}/members`);
            onValue(leagueRef, (snapshot) => {
                if (snapshot.exists()) {
                    const members = Object.values(snapshot.val());
                    const sortedMembers = members.sort((a,b) => (b.weeklyScore || 0) - (a.weeklyScore || 0));
                    renderLeague(sortedMembers);
                }
            });
            dom.leaderboardModal.classList.add('visible');
        }

        function renderLeague(data) {
            dom.leaderboardList.innerHTML = '';
            
            const paginatedData = data.slice((leagueCurrentPage - 1) * ITEMS_PER_PAGE, leagueCurrentPage * ITEMS_PER_PAGE);

            const createZone = (className, titleKey) => { const zone = document.createElement('div'); zone.className = `league-zone ${className}`; if (titleKey) { const titleEl = document.createElement('div'); titleEl.className = 'zone-title'; titleEl.textContent = translations[currentUILanguage][titleKey]; zone.appendChild(titleEl); } return zone; };

            const promotionZone = createZone('league-zone-promotion', 'promotion_zone');
            const normalZone = createZone('', null);
            const demotionZone = createZone('league-zone-demotion', 'demotion_zone');

            const promotionLimit = 5;
            const demotionLimit = data.length - 5;

            paginatedData.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                if (user.uid === userId) item.classList.add('current-user');
                item.dataset.userId = user.uid;

                const rank = ((leagueCurrentPage - 1) * ITEMS_PER_PAGE) + index + 1;
                let rankContent;
                if (rank === 1) rankContent = '<span class="medal">🥇</span>';
                else if (rank === 2) rankContent = '<span class="medal">🥈</span>';
                else if (rank === 3) rankContent = '<span class="medal">🥉</span>';
                else rankContent = `<span>${rank}</span>`;

                const userInitial = (user.username || user.email || 'U').charAt(0).toUpperCase();
                const userName = user.username || (user.email ? user.email.split('@')[0] : 'Usuário');

                item.innerHTML = `<div class="rank">${rankContent}</div><div class="user-avatar">${userInitial}</div><div class="user-info"><div class="user-name">${userName}</div></div><div class="user-score">${user.weeklyScore || 0} pts</div>`;
                item.addEventListener('click', () => openProfileModal(user.uid));
                
                if (rank <= promotionLimit) { promotionZone.appendChild(item); } 
                else if (rank > demotionLimit && data.length > 10) { demotionZone.appendChild(item); } 
                else { normalZone.appendChild(item); }
            });

            if (promotionZone.childElementCount > 1) dom.leaderboardList.appendChild(promotionZone);
            if (normalZone.childElementCount > 0) dom.leaderboardList.appendChild(normalZone);
            if (demotionZone.childElementCount > 1) dom.leaderboardList.appendChild(demotionZone);

            renderPagination(dom.leaderboardPaginationContainer, leagueCurrentPage, data.length, ITEMS_PER_PAGE, (page) => {
                leagueCurrentPage = page;
                renderLeague(data);
            });
        }
        
        // --- PERFIL DE USUÁRIO ---
        dom.myProfileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openProfileModal(userId);
            dom.userMenuDropdown.classList.remove('visible');
        });

        async function openProfileModal(profileUserId) {
            dom.profileContent.innerHTML = `<div class="loader-icon">語</div>`;
            dom.profileModal.classList.add('visible');
            
            const profilePath = getDbPath('profile', profileUserId);
            if(!profilePath) {
                dom.profileContent.innerHTML = `<p>${translations[currentUILanguage].error_loading_profile}</p>`;
                return;
            }

            try {
                const snapshot = await get(ref(db, profilePath));
                if (snapshot.exists()) {
                    renderProfile(snapshot.val());
                } else {
                    dom.profileContent.innerHTML = `<p>${translations[currentUILanguage].profile_not_found}</p>`;
                }
            } catch(error) {
                console.error("Erro ao buscar perfil:", error);
                dom.profileContent.innerHTML = `<p>${translations[currentUILanguage].error_loading_profile}</p>`;
            }
        }
        
        function renderProfile(profileData) {
            const patent = patents[profileData.patentLevel || 0];
            const joinDate = profileData.createdAt ? new Date(profileData.createdAt).toLocaleDateString(currentUILanguage) : 'Data não disponível';
            const userInitial = (profileData.username || 'U').charAt(0).toUpperCase();

            dom.profileContent.innerHTML = `
                <div class="profile-header">
                    <button id="close-profile-modal">&times;</button>
                    <div class="profile-avatar">${userInitial}</div>
                    <h2 class="profile-name">${profileData.username || translations[currentUILanguage].anonymous_user}</h2>
                    <p class="profile-joindate">${translations[currentUILanguage].member_since} ${joinDate}</p>
                </div>
                <div class="profile-stats">
                    <div class="stat-card">
                        <div class="value">${profileData.totalScore || 0}</div>
                        <div class="label">${translations[currentUILanguage].total_xp}</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${profileData.correctAnswers || 0}</div>
                        <div class="label">${translations[currentUILanguage].correct_answers}</div>
                    </div>
                </div>
                <div class="profile-league-card">
                    <div id="profile-patent-icon">${getPatentIcon(profileData.patentLevel || 0)}</div>
                    <div>
                        <p class="font-bold">${patent.name}</p>
                        <p class="text-sm text-gray-600">${translations[currentUILanguage].weekly_points}: ${profileData.weeklyScore || 0}</p>
                    </div>
                </div>
            `;
            document.getElementById('close-profile-modal').addEventListener('click', () => dom.profileModal.classList.remove('visible'));
        }

        // --- SEÇÃO DE ESTATÍSTICAS ---
        async function fetchAllUserData() {
            const modes = ['kanji', 'hiragana', 'katakana', 'english'];
            const allCards = [];
            for (const mode of modes) {
                const modePath = `artifacts/${appId}/users/${userId}/${mode}Cards`;
                try {
                    const snapshot = await get(ref(db, modePath));
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        allCards.push(...Object.values(data).map(c => ({...c, createdAt: c.createdAt || null})));
                    }
                } catch(e) { console.error(`Erro ao buscar cards de ${mode}:`, e); }
            }
            return allCards;
        }

        async function renderStatsView() {
            dom.statsContainer.innerHTML = `
                <div class="text-center">
                    <h1 class="text-4xl font-bold" data-translate="statistics_title">${translations[currentUILanguage].statistics_title}</h1>
                    <p class="text-gray-500 mt-2" data-translate="statistics_subtitle">${translations[currentUILanguage].statistics_subtitle}</p>
                </div>
                <div id="stats-grid" class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="md:col-span-2 lg:col-span-3 text-center p-8">
                        <div class="loader-icon" style="animation: none;">📊</div>
                        <p data-translate="calculating_stats">${translations[currentUILanguage].calculating_stats}</p>
                    </div>
                </div>`;

            const allUserCards = await fetchAllUserData();
            const grid = document.getElementById('stats-grid');
            grid.innerHTML = ''; 

            const totalCards = allUserCards.length;
            const learnedCards = allUserCards.filter(c => c.srsInterval && c.srsInterval > 21).length;
            grid.innerHTML += `
                <div class="stat-card"> <div class="value">${totalCards}</div> <div class="label">${translations[currentUILanguage].cards_added}</div> </div>
                <div class="stat-card"> <div class="value">${learnedCards}</div> <div class="label">${translations[currentUILanguage].cards_completed}</div> </div>
                <div class="stat-card"> <div class="value">${(userProfile.totalScore || 0)}</div> <div class="label">${translations[currentUILanguage].total_xp}</div> </div>`;
            
            const correct = userProfile.correctAnswers || 0;
            const incorrect = userProfile.incorrectAnswers || 0;
            const accuracy = (correct + incorrect > 0) ? ((correct / (correct + incorrect)) * 100).toFixed(1) : "0.0";
            
            grid.innerHTML += `
                <div class="stat-card md:col-span-2">
                    <h3 class="text-left font-bold mb-4">${translations[currentUILanguage].study_results}</h3>
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <div class="w-full sm:w-1/2 max-w-[200px] mx-auto"><canvas id="studyResultsChart"></canvas></div>
                        <div class="w-full sm:w-1/2 text-left space-y-2">
                            <p style="color: var(--success);"><strong>${translations[currentUILanguage].correct_answers}:</strong> ${correct}</p>
                            <p style="color: var(--danger);"><strong>${translations.pt.incorrect_answers_short.charAt(0).toUpperCase() + translations.pt.incorrect_answers_short.slice(1)}:</strong> ${incorrect}</p>
                            <p class="mt-4 pt-2 border-t"><strong>${translations[currentUILanguage].accuracy}:</strong> ${accuracy}%</p>
                        </div>
                    </div>
                </div>`;

            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0,0,0,0);
            let cardsTomorrow = 0;
            allUserCards.forEach(card => {
                const interval = card.srsInterval === undefined ? 0 : card.srsInterval;
                if (interval > 0 && card.lastReview) {
                    const lastReviewDate = new Date(card.lastReview);
                    lastReviewDate.setDate(lastReviewDate.getDate() + interval);
                    lastReviewDate.setHours(0,0,0,0);
                    if (lastReviewDate.getTime() <= tomorrow.getTime()) {
                        cardsTomorrow++;
                    }
                }
            });
            grid.innerHTML += `
                 <div class="stat-card">
                    <h3 class="text-left font-bold mb-4">${translations[currentUILanguage].study_forecast}</h3>
                    <div class="space-y-4 text-left">
                        <div> <p class="value">${cardsTomorrow}</p> <p class="label">${translations[currentUILanguage].cards_to_review_tomorrow}</p> </div>
                    </div>
                </div>`;
            
            const ctx = document.getElementById('studyResultsChart').getContext('2d');
            if(studyResultsChart) studyResultsChart.destroy();
            studyResultsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [translations[currentUILanguage].correct_answers, translations.pt.incorrect_answers_short],
                    datasets: [{
                        data: [correct, incorrect],
                        backgroundColor: ['var(--success-light)', 'var(--danger-light)'],
                        borderColor: ['var(--success)', 'var(--danger)'],
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, cutout: '70%', plugins: { legend: { display: false } } }
            });
        }


        // --- GEMINI API E FORMULÁRIO DE CARD ---
        dom.generateAiBtn.addEventListener('click', async () => { 
            const character = dom.kanjiInput.value; 
            if (!character.trim()) { alert("Por favor, insira um caractere ou palavra."); return; } 
            dom.generateAiBtn.disabled = true; 
            dom.aiBtnText.style.display = 'none'; 
            dom.aiBtnSpinner.style.display = 'block'; 
            try { 
                const geminiData = await fetchGeminiDataForFields(character, currentLearningLanguage, currentLearningMode); 
                if (geminiData) { 
                    dom.pronunciationInput.value = geminiData.pronunciation || ''; 
                    dom.meaningInput.value = geminiData.meaning || ''; 
                    dom.displayKanjiInput.value = geminiData.commonUsage || '';
                    dom.geminiDataInput.value = JSON.stringify(geminiData); 
                } else { 
                    alert("Não foi possível gerar informações com a IA. Tente novamente."); 
                } 
            } catch (error) { 
                console.error("Erro na geração com IA:", error); 
                alert("Ocorreu um erro ao contatar a IA."); 
            } finally { 
                dom.generateAiBtn.disabled = false; 
                dom.aiBtnText.style.display = 'inline'; 
                dom.aiBtnSpinner.style.display = 'none'; 
            } 
        }); 
        
        async function fetchGeminiDataForFields(character, lang, mode) {
            const apiKey = "AIzaSyCpNSwWWEbyWhklPL96AAweF2qhjeLrWlM"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; 
            
            let userQuery = ''; 
            let systemPrompt = `Você é um professor de idiomas para falantes de português. Forneça informações concisas e úteis. Responda em JSON.`; 
            let responseSchema;

            if (lang === 'jp') { 
                userQuery = `Analise o caractere de ${mode} "${character}". Quero informações para um flashcard. Forneça o seguinte em JSON: "pronunciation" (leitura romaji), "meaning" (significado principal), "commonUsage" (a palavra japonesa mais comum que usa este caractere, SEM romaji. Se for usado sozinho, retorne apenas o caractere), "sentences" (duas frases de exemplo com "japanese", "reading" e "portuguese"), "curiosities" (curiosidade sobre origem/uso ou dica de memorização), e "grammar" (dica gramatical ou de uso).`;
                responseSchema = { type: "OBJECT", properties: { "pronunciation": { "type": "STRING" }, "meaning": { "type": "STRING" }, "commonUsage": { "type": "STRING" }, "sentences": { type: "ARRAY", items: { type: "OBJECT", properties: { "japanese": { "type": "STRING" }, "reading": { "type": "STRING" }, "portuguese": { "type": "STRING" } }, required: ["japanese", "reading", "portuguese"]}}, "curiosities": { "type": "STRING" }, "grammar": { "type": "STRING" } }, required: ["pronunciation", "meaning", "commonUsage", "sentences", "curiosities", "grammar"] };
            } else { // English
                userQuery = `Analise a palavra em inglês "${character}". Quero informações para um flashcard para um falante de português. Forneça o seguinte em JSON: "pronunciation" (pronúncia figurada ou fonética simplificada), "meaning" (significado principal em português), "commonUsage" (a própria palavra em inglês), "sentences" (duas frases de exemplo simples com "english" e sua "translation" para o português), "curiosities" (uma curiosidade sobre a origem, uso ou uma dica de memorização), e "grammar" (uma dica gramatical rápida sobre o uso da palavra, ex: se é verbo, substantivo, etc.).`;
                responseSchema = { type: "OBJECT", properties: { "pronunciation": { "type": "STRING" }, "meaning": { "type": "STRING" }, "commonUsage": { "type": "STRING" }, "sentences": { type: "ARRAY", items: { type: "OBJECT", properties: { "english": { "type": "STRING" }, "translation": { "type": "STRING" } }, required: ["english", "translation"]}}, "curiosities": { "type": "STRING" }, "grammar": { "type": "STRING" } }, required: ["pronunciation", "meaning", "commonUsage", "sentences", "curiosities", "grammar"] };
            }
            
            const payload = { 
                contents: [{ parts: [{ text: userQuery }] }], 
                systemInstruction: { parts: [{ text: systemPrompt }] }, 
                generationConfig: { responseMimeType: "application/json", responseSchema: responseSchema } 
            }; 
            try { 
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
                if (!response.ok) throw new Error(`API error: ${response.status}`); 
                const result = await response.json(); 
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text; 
                return JSON.parse(jsonText); 
            } catch (error) { 
                console.error("Erro ao chamar a API Gemini:", error); 
                return null; 
            } 
        }
        
        // --- AUTENTICAÇÃO E CONTA ---
        dom.addEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cardData = {
                kanji: dom.kanjiInput.value,
                displayKanji: dom.displayKanjiInput.value,
                pronunciation: dom.pronunciationInput.value,
                meaning: dom.meaningInput.value,
                srsInterval: 0,
                lastReview: new Date().toISOString(),
                geminiInfo: dom.geminiDataInput.value ? JSON.parse(dom.geminiDataInput.value) : null
            };
            const cardId = dom.cardIdInput.value;
            
            try {
                if (cardId) {
                    await set(ref(db, `${getDbPath('cards')}/${cardId}`), cardData);
                } else {
                    cardData.createdAt = new Date().toISOString();
                    await push(ref(db, getDbPath('cards')), cardData);
                }
                dom.addEditModal.classList.remove('visible');
            } catch(error) { console.error("Erro ao salvar card:", error); }
        });
        dom.logoutBtn.addEventListener('click', () => signOut(auth)); 

        const { authForm } = dom;

        function setAuthMode(mode) {
            currentAuthMode = mode;
            authForm.authStatusMessage.textContent = '';
            const isLogin = mode === 'login';
            const isRegister = mode === 'register';
            const isRecover = mode === 'recover';

            authForm.authModalTitle.textContent = isLogin ? translations[currentUILanguage].login : isRegister ? translations[currentUILanguage].create_account : translations[currentUILanguage].recover_password;
            authForm.authBtn.textContent = isLogin ? translations[currentUILanguage].login : isRegister ? translations[currentUILanguage].create_account : translations[currentUILanguage].verify_and_send_email;
            
            authForm.toggleAuthMode.textContent = isLogin ? translations[currentUILanguage].no_account_yet : translations[currentUILanguage].already_have_account;
            
            authForm.usernameInput.style.display = isRegister ? 'block' : 'none';
            authForm.passwordInput.style.display = isRecover ? 'none' : 'block';
            authForm.confirmPasswordInput.style.display = isRegister ? 'block' : 'none';
            authForm.keywordInput.style.display = isRegister || isRecover ? 'block' : 'none';

            if(isRegister) { authForm.keywordInput.placeholder = "Crie uma Palavra-chave de Segurança"; } 
            else if (isRecover) { authForm.keywordInput.placeholder = "Sua Palavra-chave de Segurança"; }

            authForm.toggleAuthMode.style.display = isRecover ? 'none' : 'block';
            authForm.forgotPasswordLink.textContent = isRecover ? translations[currentUILanguage].back_to_login : translations[currentUILanguage].forgot_password;
        }

        authForm.toggleAuthMode.addEventListener('click', () => { setAuthMode(currentAuthMode === 'login' ? 'register' : 'login'); });
        authForm.forgotPasswordLink.addEventListener('click', () => { setAuthMode(currentAuthMode === 'recover' ? 'login' : 'recover'); });
        
        authForm.authBtn.addEventListener('click', async () => { 
            authForm.authStatusMessage.textContent = `${translations[currentUILanguage].processing}`;
            authForm.authStatusMessage.style.color = 'var(--text-secondary)';
            const email = authForm.emailInput.value; 

            try {
                switch (currentAuthMode) {
                    case 'login': await signInWithEmailAndPassword(auth, email, authForm.passwordInput.value); break;
                    case 'register':
                        const regPassword = authForm.passwordInput.value;
                        const username = authForm.usernameInput.value.trim();
                        const keyword = authForm.keywordInput.value.trim();
                        if (!username || !keyword) throw new Error('Nome de usuário e palavra-chave são obrigatórios.');
                        if (regPassword !== authForm.confirmPasswordInput.value) throw new Error('As senhas não coincidem.');
                        const { user } = await createUserWithEmailAndPassword(auth, email, regPassword);
                        const newProfile = { totalScore: 0, weeklyScore: 0, patentLevel: 0, leagueId: null, email: email, username: username, keyword: keyword, createdAt: new Date().toISOString() };
                        await set(ref(db, `artifacts/${appId}/userProfiles/${user.uid}`), newProfile);
                        break;
                    case 'recover':
                        const recoverKeyword = authForm.keywordInput.value.trim();
                        if (!email || !recoverKeyword) throw new Error('E-mail e Palavra-chave são obrigatórios.');
                        const snapshot = await get(ref(db, `artifacts/${appId}/userProfiles`));
                        if (!snapshot.exists()) throw new Error('Nenhum usuário encontrado no sistema.');
                        const profiles = snapshot.val();
                        let userFound = false, keywordMatch = false;
                        for (const uid in profiles) {
                            if (profiles[uid].email && profiles[uid].email.toLowerCase() === email.toLowerCase()) {
                                userFound = true;
                                if (profiles[uid].keyword && profiles[uid].keyword.toLowerCase() === recoverKeyword.toLowerCase()) keywordMatch = true;
                                break;
                            }
                        }
                        if (!userFound) throw new Error('E-mail não encontrado.');
                        if (!keywordMatch) throw new Error('Palavra-chave de segurança incorreta.');
                        await sendPasswordResetEmail(auth, email);
                        authForm.authStatusMessage.textContent = `${translations[currentUILanguage].success_email_sent}`;
                        authForm.authStatusMessage.style.color = 'var(--success)';
                        return;
                }
            } catch (error) { 
                authForm.authStatusMessage.textContent = `${translations[currentUILanguage].failure}: ` + error.message; 
                authForm.authStatusMessage.style.color = 'var(--danger)';
            } 
        }); 

        dom.updateUsernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = dom.newUsernameInput.value.trim();
            const statusEl = dom.updateUsernameStatus;
            if (!newUsername) { statusEl.textContent = translations[currentUILanguage].username_not_empty; statusEl.style.color = 'var(--danger)'; return; }
            statusEl.textContent = `${translations[currentUILanguage].saving}`; statusEl.style.color = 'var(--text-secondary)';
            try {
                const updates = { username: newUsername };
                await update(ref(db, getDbPath('profile')), updates);
                if (userProfile.leagueId && userProfile.leagueWeek) {
                    await update(ref(db, `${getDbPath('leagues')}/${userProfile.leagueWeek}/${userProfile.leagueId}/members/${userId}`), updates);
                }
                statusEl.textContent = translations[currentUILanguage].name_updated; statusEl.style.color = 'var(--success)';
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            } catch (error) { console.error("Erro ao atualizar nome de usuário:", error); statusEl.textContent = translations[currentUILanguage].error_saving; statusEl.style.color = 'var(--danger)'; }
        });

        dom.updateKeywordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newKeyword = dom.newKeywordInput.value.trim();
            const currentPassword = dom.currentPasswordForKeyword.value;
            const statusEl = dom.updateKeywordStatus;
            if (!newKeyword || !currentPassword) { statusEl.textContent = translations[currentUILanguage].fields_required; statusEl.style.color = 'var(--danger)'; return; }
            statusEl.textContent = `${translations[currentUILanguage].verifying_and_saving}`; statusEl.style.color = 'var(--text-secondary)';
            try {
                const user = auth.currentUser;
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential);
                await update(ref(db, getDbPath('profile')), { keyword: newKeyword });
                statusEl.textContent = translations[currentUILanguage].keyword_updated; statusEl.style.color = 'var(--success)';
                dom.updateKeywordForm.reset();
                setTimeout(() => { statusEl.textContent = ''; }, 3000);
            } catch (error) {
                console.error("Erro ao atualizar palavra-chave:", error);
                let message = translations[currentUILanguage].error_saving;
                if (error.code === 'auth/wrong-password') message = translations[currentUILanguage].wrong_password;
                statusEl.textContent = message; statusEl.style.color = 'var(--danger)';
            }
        });

        dom.updatePasswordForm.addEventListener('submit', async (e) => { e.preventDefault(); const newPassword = document.getElementById('new-password-input').value; const confirmPassword = document.getElementById('confirm-new-password-input').value; const statusEl = dom.updatePasswordStatus; if (newPassword !== confirmPassword) { statusEl.textContent = translations[currentUILanguage].passwords_dont_match; statusEl.style.color = 'var(--danger)'; return; } if(newPassword.length < 6) { statusEl.textContent = translations[currentUILanguage].password_min_length; statusEl.style.color = 'var(--danger)'; return; } statusEl.textContent = `${translations[currentUILanguage].updating}`; statusEl.style.color = 'var(--text-secondary)'; try { const user = auth.currentUser; await updatePassword(user, newPassword); statusEl.textContent = translations[currentUILanguage].password_updated; statusEl.style.color = 'var(--success)'; setTimeout(() => { dom.userManageModal.classList.remove('visible'); statusEl.textContent = ''; dom.updatePasswordForm.reset(); }, 2000); } catch (error) { console.error("Erro ao atualizar senha:", error); statusEl.textContent = translations[currentUILanguage].error_updating_password; statusEl.style.color = 'var(--danger)'; } });
   
        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            translateUI('pt'); // Define o idioma inicial da UI
            setLearningLanguage('jp'); // Define o idioma inicial de aprendizado
        });

    </script>
</body>
</html>
