<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nihongo Master - SRS Moderno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Lexend:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
    <style>
        :root {
            /* Paleta de Cores Renovada */
            --bg-primary: #F8F7FF;      /* Um lilás muito sutil, quase branco */
            --bg-secondary: #FFFFFF;
            --bg-accent: #EFEBFD;       /* Lilás bem claro para fundos de destaque */
            --text-primary: #1E1B39;    /* Um roxo bem escuro, quase preto */
            --text-secondary: #6B688E;  /* Roxo acinzentado para textos secundários */
            --accent-primary: #7F56D9;  /* Roxo vibrante principal */
            --accent-primary-dark: #6941C6;
            --accent-primary-light: #BDB0F2;
            --success: #027A48;         /* Verde escuro e acessível */
            --success-light: #ECFDF3;   /* Verde pastel para fundos */
            --danger: #B42318;          /* Vermelho escuro e acessível */
            --danger-light: #FEF3F2;    /* Vermelho pastel para fundos */
            --border-color: #E9D7FE;    /* Borda lilás clara */
            
            /* Tipografia Renovada */
            --font-jp: 'Noto Sans JP', sans-serif;
            --font-ui: 'Lexend', sans-serif;
        }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overscroll-behavior-y: contain;
        }
        
        /* --- ESTRUTURA E LAYOUT --- */
        .main-container, .game-container {
            width: 100%;
            max-width: 768px;
            margin: auto;
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 1rem;
        }

        /* --- HEADER E NAVEGAÇÃO --- */
        header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 500; height: 80px;
        }
        .nav-link {
            font-weight: 500; color: var(--text-secondary);
            transition: all 0.2s; padding: 0.5rem 1rem;
            border-radius: 0.5rem; border: 2px solid transparent;
        }
        .nav-link:hover { color: var(--accent-primary); background-color: var(--bg-accent); }
        .nav-link.active {
            color: var(--accent-primary); font-weight: 700;
            border-bottom: 2px solid var(--accent-primary);
            border-radius: 0; padding-bottom: calc(0.5rem - 2px);
            background-color: transparent;
        }

        /* --- DROPDOWNS --- */
        .dropdown { position: relative; }
        .dropdown-content {
            display: none; position: absolute; top: calc(100% + 15px); left: 50%;
            transform: translateX(-50%); background-color: var(--bg-secondary);
            min-width: 220px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            z-index: 10; border-radius: 0.75rem; padding: 0.5rem;
            border: 1px solid var(--border-color);
        }
        .dropdown-content.visible { display: block; } /* Controlado por JS */
        .dropdown-content a {
            color: var(--text-primary); padding: 0.75rem 1rem; text-decoration: none;
            display: block; border-radius: 0.5rem; font-weight: 500;
        }
        .dropdown-content a:hover { background-color: var(--bg-accent); color: var(--accent-primary); }
        #user-menu-dropdown { right: 0; left: auto; transform: none; min-width: 200px; }
        
        /* --- CARD DE REVISÃO --- */
        .review-card-container { perspective: 1000px; }
        .review-card {
            background: var(--bg-secondary); border-radius: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px -2px rgba(127, 86, 217, 0.05);
            transition: transform 0.6s, box-shadow 0.3s ease;
            transform-style: preserve-3d; position: relative;
            min-height: 450px; display: flex;
        }
        .review-card.is-flipped { transform: rotateY(180deg); }

        .card-face {
            width: 100%; height: 100%; padding: 1.5rem;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: absolute; top: 0; left: 0;
        }
        .card-face-back { 
            transform: rotateY(180deg); 
            justify-content: flex-start;
            overflow-y: auto;
        }

        .question-text {
            font-family: var(--font-jp); font-size: clamp(3rem, 15vw, 6rem);
            font-weight: 700; line-height: 1.1; text-align: center;
        }
        .question-hint {
            font-size: 1.25rem; color: var(--text-secondary);
            margin-top: 0.5rem; text-align: center;
        }
        
        .gemini-info-section h3 {
             font-size: 0.875rem; font-weight: 700; color: var(--accent-primary);
             text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1rem;
             padding-bottom: 0.25rem; border-bottom: 2px solid var(--bg-accent);
        }
        .gemini-info-section p, .gemini-info-section li {
            font-size: 0.95rem; color: var(--text-secondary); line-height: 1.6;
        }
        .gemini-info-section ul { list-style-position: inside; padding-left: 0.5rem; }
        .gemini-info-section .sentence { margin-bottom: 0.75rem; }
        .gemini-info-section .sentence .jp { font-family: var(--font-jp); font-size: 1.2rem; color: var(--text-primary); }
        .gemini-info-section .sentence .reading { font-size: 0.85rem; color: var(--text-secondary); font-style: italic;}

        /* --- BOTÕES E INTERAÇÕES --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700;
            font-size: 0.875rem; transition: all 0.2s ease-in-out;
            border: 1px solid transparent; cursor: pointer;
        }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-primary { 
            background-color: var(--accent-primary); color: white;
        }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-dark); }
        .btn-secondary { 
            background-color: var(--bg-accent); color: var(--accent-primary);
            border: 1px solid var(--border-color);
         }
        .btn-secondary:hover:not(:disabled) { background-color: var(--border-color); }
        .btn-success { background-color: var(--success-light); color: var(--success); border-color: #A6F4C5; }
        .btn-success:hover { background-color: #D1FADF; }
        .btn-danger { background-color: var(--danger-light); color: var(--danger); border-color: #FECDCA; }
        .btn-danger:hover { background-color: #FEE4E2; }
        
        .sound-btn {
            position: absolute; top: 1.5rem; right: 1.5rem;
            background: none; border: none; cursor: pointer; color: var(--text-secondary);
            padding: 0.5rem; border-radius: 50%; z-index: 10;
        }
        .sound-btn:hover { color: var(--accent-primary); background-color: var(--bg-accent); }
        .sound-btn i { font-size: 1.5rem; vertical-align: middle; }

        /* --- TELAS DE JOGO --- */
        .game-board { display: grid; gap: 1rem; width: 100%; }
        .game-option {
            padding: 1rem; background-color: var(--bg-secondary);
            border: 2px solid var(--border-color); border-radius: 0.75rem; cursor: pointer;
            transition: all 0.2s; text-align: center;
            font-size: 1.25rem; font-weight: 500;
        }
        .game-option.kanji { font-family: var(--font-jp); font-size: 1.5rem; }
        .game-option:hover { border-color: var(--accent-primary-light); transform: scale(1.05); }
        .game-option.selected { background-color: var(--accent-primary-light); border-color: var(--accent-primary); color: white; }
        .game-option.correct { background-color: var(--success-light); color: var(--success); border-color: #6CE9A6; cursor: not-allowed; transform: scale(1); }
        .game-option.incorrect { background-color: var(--danger-light); color: var(--danger); border-color: #FDA29B; animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); }
        }
        
        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        .memory-card {
            background-color: var(--text-primary); /* CORREÇÃO: Cor de fundo para "preto pastel" */
            color: var(--bg-secondary); /* CORREÇÃO: Cor do texto para contraste */
            border: 2px solid var(--border-color);
            border-radius: 0.5rem; aspect-ratio: 1/1; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; transition: transform 0.3s; transform-style: preserve-3d;
            -webkit-tap-highlight-color: transparent;
        }
        .memory-card .card-content { display: none; }
        .memory-card .kanji { font-family: var(--font-jp); font-size: 2rem; }
        .memory-card.flipped {
            transform: rotateY(180deg);
            background-color: var(--bg-accent);
            color: var(--text-primary); /* CORREÇÃO: Resetar cor do texto no verso */
        }
        .memory-card.flipped .card-content { 
            display: block;
            transform: rotateY(180deg); /* CORREÇÃO: Inverte o conteúdo para que fique legível */
        }
        .memory-card.matched {
            background-color: var(--success-light);
            border-color: #6CE9A6;
            cursor: not-allowed;
            color: var(--success); /* CORREÇÃO: Cor do texto para o par combinado */
        }
        .memory-card.matched .card-content { color: var(--success); }

        /* --- OUTROS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(30, 27, 57, 0.5);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--bg-secondary); border-radius: 1.5rem;
            padding: 2rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }

        .input, .textarea, .select {
            padding: 0.75rem; border-radius: 0.75rem;
            background-color: var(--bg-primary);
            border: 2px solid var(--border-color);
            color: var(--text-primary); width: 100%;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .input:focus, .textarea:focus, .select:focus {
            outline: none; border-color: var(--accent-primary);
            background-color: var(--bg-secondary);
        }

        #loading-overlay { z-index: 1001; }
        .loader-icon {
            font-family: var(--font-jp); font-size: 4rem; color: var(--accent-primary);
            animation: bounce 1.5s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); } 60% { transform: translateY(-15px); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- CABEÇALHO -->
    <header class="w-full flex justify-center items-center p-4">
        <div class="w-full max-w-4xl flex justify-between items-center">
            <div class="font-black text-3xl" style="color: var(--accent-primary);">
                <a href="#" id="home-logo">語</a>
            </div>
            <nav class="hidden md:flex items-center space-x-2">
                <a href="#" class="nav-link active" id="nav-study">Estudar</a>
                <div class="dropdown">
                    <a href="#" class="nav-link" id="nav-games">Jogos</a>
                    <div class="dropdown-content">
                        <a href="#" id="game-match-kanji">Combine Kanji e Significado</a>
                        <a href="#" id="game-quiz-kanji">Quiz de Múltipla Escolha</a>
                        <a href="#" id="game-type-kanji">Digite a Leitura</a>
                        <a href="#" id="game-memory-kanji">Jogo da Memória</a>
                    </div>
                </div>
                <a href="#" class="nav-link" id="nav-manage">Gerenciar</a>
            </nav>
            <div id="userInfoContainer" class="relative">
                <div id="auth-links" style="display: none;">
                     <button id="login-nav-btn" class="btn btn-secondary text-sm">Entrar</button>
                </div>
                <div id="user-menu" class="relative" style="display: none;">
                    <button id="user-menu-btn" class="flex items-center space-x-2 text-sm font-medium text-gray-600 hover:text-accent-primary">
                        <span id="user-email-display" class="truncate max-w-[150px]"></span>
                        <i class="ph ph-caret-down"></i>
                    </button>
                    <div id="user-menu-dropdown" class="dropdown-content">
                        <a href="#" id="manage-account-btn">Gerenciar Conta</a>
                        <a href="#" id="logoutBtn">Sair</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- TELA DE CARREGAMENTO -->
    <div id="loading-overlay" class="modal-overlay visible">
        <div class="text-center">
            <div class="loader-icon">語</div>
            <p id="loading-text" class="mt-4 text-lg font-bold" style="color: var(--text-primary);">Carregando seu aprendizado...</p>
        </div>
    </div>
    
    <!-- MODAL DE AUTENTICAÇÃO -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content text-center">
             <h2 class="text-3xl font-bold mb-6" id="auth-modal-title">Entrar</h2>
            <div class="flex flex-col space-y-4">
                <input type="email" id="emailInput" placeholder="Email" class="input">
                <input type="password" id="passwordInput" placeholder="Senha" class="input">
                <input type="password" id="confirmPasswordInput" placeholder="Confirmar Senha" class="input" style="display: none;">
                <button id="authBtn" class="btn btn-primary w-full">Entrar</button>
                <p id="toggleAuthMode" class="text-sm cursor-pointer hover:underline text-gray-500">Ainda não tem uma conta? Crie uma.</p>
            </div>
            <p id="auth-status-message" class="mt-4 text-sm text-red-500"></p>
        </div>
    </div>
    
    <!-- CONTEÚDO PRINCIPAL (ESTUDO) -->
    <main class="main-container" style="display: none;">
        <div class="flex flex-col items-center">
            <div id="review-card-container" class="review-card-container w-full mb-6">
                <div id="review-card" class="review-card">
                    <div id="card-front" class="card-face card-face-front"></div>
                    <div id="card-back" class="card-face card-face-back"></div>
                </div>
            </div>

            <div class="w-full mt-2">
                <div class="h-2 rounded-full" style="background-color: var(--bg-accent);">
                    <div id="progress-bar" class="h-2 bg-green-500 rounded-full transition-all duration-300 ease-in-out" style="width: 0%; background-color: var(--accent-primary);"></div>
                </div>
                <p id="progress-text" class="text-right text-sm text-gray-500 mt-1 font-bold">0 / 0</p>
            </div>
            
            <div id="action-buttons" class="mt-6 flex flex-col space-y-4 items-center w-full max-w-md">
                <div id="feedback-buttons-container" class="grid grid-cols-2 gap-4 w-full"></div>
                <button id="studyMoreBtn" class="btn btn-secondary w-full">Estudar Mais</button>
            </div>
        </div>
        <p id="userIdDisplay" class="text-xs text-gray-400 text-center mt-8"></p>
    </main>
    
    <!-- CONTEÚDO DO JOGO -->
    <div id="game-container" class="game-container" style="display: none;">
        <!-- O conteúdo do jogo será renderizado aqui pelo JS -->
    </div>

    <!-- MODAL DE GERENCIAMENTO DE CARDS -->
    <div id="manage-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Gerenciar Cards</h2>
                <button id="close-manage-modal" class="text-2xl font-bold p-2 leading-none">&times;</button>
            </div>
            <button id="add-new-card-btn" class="btn btn-primary w-full mb-6">Adicionar Novo Card</button>
            <div id="card-list-container" class="space-y-3 max-h-[60vh] overflow-y-auto p-1">
                <!-- Lista de cards será inserida aqui -->
            </div>
        </div>
    </div>

    <!-- MODAL DE GERENCIAR CONTA -->
    <div id="user-manage-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold mb-6">Gerenciar Conta</h2>
            <form id="update-password-form" class="flex flex-col space-y-4">
                <h3 class="text-lg font-semibold">Alterar Senha</h3>
                <div>
                    <label for="new-password-input" class="font-bold text-sm">Nova Senha</label>
                    <input type="password" id="new-password-input" class="input mt-1" required>
                </div>
                 <div>
                    <label for="confirm-new-password-input" class="font-bold text-sm">Confirmar Nova Senha</label>
                    <input type="password" id="confirm-new-password-input" class="input mt-1" required>
                </div>
                <div class="flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancel-user-manage-btn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Atualizar Senha</button>
                </div>
                <p id="update-password-status" class="text-sm mt-2 h-4"></p>
            </form>
        </div>
    </div>

    <!-- MODAL DE ADICIONAR/EDITAR CARD -->
    <div id="add-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold mb-6" id="add-edit-modal-title">Adicionar Card</h2>
            <form id="add-edit-form" class="flex flex-col space-y-4">
                <input type="hidden" id="card-id-input">
                 <div class="flex items-end space-x-2">
                    <div class="flex-grow">
                        <label for="kanji-input" class="font-bold text-sm">Kanji</label>
                        <input type="text" id="kanji-input" class="input mt-1" required>
                    </div>
                    <button type="button" id="generate-ai-btn" class="btn btn-secondary flex-shrink-0">
                        <span id="ai-btn-text">Gerar com IA</span>
                         <svg id="ai-btn-spinner" class="animate-spin h-5 w-5 text-purple-500" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
                <div>
                    <label for="pronunciation-input" class="font-bold text-sm">Leitura (Romaji)</label>
                    <input type="text" id="pronunciation-input" class="input mt-1" required>
                </div>
                <div>
                    <label for="meaning-input" class="font-bold text-sm">Significado</label>
                    <input type="text" id="meaning-input" class="input mt-1" required>
                </div>
                <input type="hidden" id="gemini-data-input">
                <div class="flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" id="save-card-btn" class="btn btn-primary">
                        <span id="save-btn-text">Salvar</span>
                        <svg id="save-btn-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Configuração do Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyAl4OJcZJlkn809EPdv7VUchU0ObuhcwHs",
            authDomain: "kanjis-b38b4.firebaseapp.com",
            projectId: "kanjis-b38b4",
            storageBucket: "kanjis-b38b4.firebasestorage.app",
            messagingSenderId: "794836504781",
            appId: "1:794836504781:web:b83d4bfb5e3b44ebda5984",
            databaseURL: "https://kanjis-b38b4-default-rtdb.firebaseio.com"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Estado da aplicação
        let allCards = { kanji: [] };
        let dueCards = [];
        let currentCard = null;
        let userId = null;
        let unsubscribeCards;
        let isCardFlipped = false;
        let isStudyMoreSession = false; 
        let sessionInitialCount = 0; 

        // Elementos do DOM
        const dom = {
            mainContainer: document.querySelector('.main-container'),
            gameContainer: document.getElementById('game-container'),
            loadingOverlay: document.getElementById('loading-overlay'),
            authModal: document.getElementById('auth-modal'),
            reviewCard: document.getElementById('review-card'),
            cardFront: document.getElementById('card-front'),
            cardBack: document.getElementById('card-back'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            feedbackButtons: document.getElementById('feedback-buttons-container'),
            studyMoreBtn: document.getElementById('studyMoreBtn'),
            navStudy: document.getElementById('nav-study'),
            navGames: document.getElementById('nav-games'),
            navManage: document.getElementById('nav-manage'),
            homeLogo: document.getElementById('home-logo'),
            navGamesDropdown: document.querySelector('.dropdown-content'),
            gameMatchKanji: document.getElementById('game-match-kanji'),
            gameQuizKanji: document.getElementById('game-quiz-kanji'),
            gameTypeKanji: document.getElementById('game-type-kanji'),
            gameMemoryKanji: document.getElementById('game-memory-kanji'),
            manageModal: document.getElementById('manage-modal'),
            closeManageModalBtn: document.getElementById('close-manage-modal'),
            addNewCardBtn: document.getElementById('add-new-card-btn'),
            cardListContainer: document.getElementById('card-list-container'),
            addEditModal: document.getElementById('add-edit-modal'),
            addEditForm: document.getElementById('add-edit-form'),
            addEditModalTitle: document.getElementById('add-edit-modal-title'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            cardIdInput: document.getElementById('card-id-input'),
            kanjiInput: document.getElementById('kanji-input'),
            pronunciationInput: document.getElementById('pronunciation-input'),
            meaningInput: document.getElementById('meaning-input'),
            saveCardBtn: document.getElementById('save-card-btn'),
            // Auth UI
            authLinks: document.getElementById('auth-links'),
            loginNavBtn: document.getElementById('login-nav-btn'),
            userMenu: document.getElementById('user-menu'),
            userMenuBtn: document.getElementById('user-menu-btn'),
            userEmailDisplay: document.getElementById('user-email-display'),
            userMenuDropdown: document.getElementById('user-menu-dropdown'),
            logoutBtn: document.getElementById('logoutBtn'),
            manageAccountBtn: document.getElementById('manage-account-btn'),
            // User Manage Modal
            userManageModal: document.getElementById('user-manage-modal'),
            cancelUserManageBtn: document.getElementById('cancel-user-manage-btn'),
            updatePasswordForm: document.getElementById('update-password-form'),
            updatePasswordStatus: document.getElementById('update-password-status'),
            // AI Button
            generateAiBtn: document.getElementById('generate-ai-btn'),
            aiBtnText: document.getElementById('ai-btn-text'),
            aiBtnSpinner: document.getElementById('ai-btn-spinner'),
            geminiDataInput: document.getElementById('gemini-data-input'),
        };

        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                toggleUI(true, user.email);
                setupRealtimeCardListener();
            } else {
                userId = null;
                if(unsubscribeCards) unsubscribeCards();
                allCards.kanji = [];
                toggleUI(false);
            }
        });

        function toggleUI(isAuthenticated, userEmail = '') {
            dom.loadingOverlay.classList.add('visible');
            if(isAuthenticated) {
                showView('srs');
                dom.authModal.classList.remove('visible');
                dom.authLinks.style.display = 'none';
                dom.userMenu.style.display = 'block';
                dom.userEmailDisplay.textContent = userEmail;
                dom.userEmailDisplay.title = userEmail;
            } else {
                dom.mainContainer.style.display = 'none';
                dom.gameContainer.style.display = 'none';
                dom.authLinks.style.display = 'block';
                dom.userMenu.style.display = 'none';
                dom.authModal.classList.add('visible');
            }
            setTimeout(() => dom.loadingOverlay.classList.remove('visible'), 500);
        }
        
        function setupRealtimeCardListener() {
            if (unsubscribeCards) unsubscribeCards();
            if (!userId) return;

            const cardsRef = ref(db, `artifacts/${appId}/users/${userId}/kanjiCards`);
            
            unsubscribeCards = onValue(cardsRef, (snapshot) => {
                const data = snapshot.val();
                allCards.kanji = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                filterCardsDueToday();
                if (dom.manageModal.classList.contains('visible')) {
                    renderManageView();
                }
            }, (error) => {
                console.error("Erro ao ouvir cards:", error);
            });
        }

        // --- NAVEGAÇÃO E UI GERAL ---
        dom.loginNavBtn.addEventListener('click', () => dom.authModal.classList.add('visible'));
        dom.userMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            dom.userMenuDropdown.classList.toggle('visible');
        });
        window.addEventListener('click', () => {
             if (dom.userMenuDropdown.classList.contains('visible')) {
                dom.userMenuDropdown.classList.remove('visible');
            }
            if (dom.navGamesDropdown.classList.contains('visible')) {
                dom.navGamesDropdown.classList.remove('visible');
            }
        });

        function showView(viewName) {
            dom.mainContainer.style.display = 'none';
            dom.gameContainer.style.display = 'none';
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

            if (viewName === 'srs') {
                dom.mainContainer.style.display = 'flex';
                dom.navStudy.classList.add('active');
            } else if (viewName.startsWith('game-')) {
                dom.gameContainer.style.display = 'flex';
                dom.navGames.classList.add('active');
            } else if (viewName === 'manage') {
                 dom.mainContainer.style.display = 'flex';
                 dom.navManage.classList.add('active');
                 dom.manageModal.classList.add('visible');
                 renderManageView();
            }
        }
        dom.navStudy.addEventListener('click', (e) => { e.preventDefault(); showView('srs'); filterCardsDueToday(); });
        dom.homeLogo.addEventListener('click', (e) => { e.preventDefault(); showView('srs'); filterCardsDueToday(); });
        dom.navGames.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); dom.navGamesDropdown.classList.toggle('visible'); });
        dom.gameMatchKanji.addEventListener('click', (e) => { e.preventDefault(); startMatchingGame(); });
        dom.gameQuizKanji.addEventListener('click', (e) => { e.preventDefault(); startQuizGame(); });
        dom.gameTypeKanji.addEventListener('click', (e) => { e.preventDefault(); startTypingGame(); });
        dom.gameMemoryKanji.addEventListener('click', (e) => { e.preventDefault(); startMemoryGame(); });


        // --- FUNÇÃO DE ÁUDIO (TEXT-TO-SPEECH) ---
        function speak(text, lang = 'ja-JP') {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                const voices = window.speechSynthesis.getVoices();
                utterance.voice = voices.find(voice => voice.lang === lang) || voices.find(voice => voice.lang.startsWith('ja')) || null;
                utterance.rate = 0.9;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            }
        }
        window.speechSynthesis.getVoices();
        
        // --- LÓGICA DO SRS ---
        function filterCardsDueToday() { isStudyMoreSession = false; const now = new Date(); now.setHours(0, 0, 0, 0); dueCards = allCards.kanji.filter(card => { if (!card.lastReview || card.srsLevel === 0) return true; const lastReviewDate = new Date(card.lastReview); lastReviewDate.setHours(0,0,0,0); const interval = [0, 1, 2, 4, 7, 15, 30, 90][card.srsLevel] || 0; lastReviewDate.setDate(lastReviewDate.getDate() + interval); return now >= lastReviewDate; }); dueCards.sort(() => Math.random() - 0.5); sessionInitialCount = dueCards.length; updateProgress(); nextCard(); }
        function nextCard() { isCardFlipped = false; dom.reviewCard.classList.remove('is-flipped'); if (dueCards.length === 0) { currentCard = null; displayCompletion(); return; } currentCard = dueCards[0]; displayCard(); }
        function displayCard() { dom.cardFront.innerHTML = `<button class="sound-btn" onclick="window.speak('${currentCard.kanji}')"><i class="ph-speaker-high"></i></button><p class="question-text">${currentCard.kanji}</p><p class="question-hint">${currentCard.meaning}</p>`; dom.cardBack.innerHTML = renderAnswerContent(currentCard); renderCheckButton('Mostrar Resposta', () => { isCardFlipped = true; dom.reviewCard.classList.add('is-flipped'); setTimeout(setupBackButtonListener, 50); }); }
        
        function renderAnswerContent(card) {
            const textToSpeak = card.kanji;
            let geminiContent = '';
            if (card.geminiInfo) {
                const info = card.geminiInfo;
                geminiContent += `<div class="w-full text-left mt-4 gemini-info-section">`;

                if (info.sentences && info.sentences.length > 0) {
                    geminiContent += `<h3>Frases de Exemplo</h3><ul>`;
                    info.sentences.forEach(s => {
                        geminiContent += `<li class="sentence"><p class="jp">${s.japanese}</p><p class="reading">${s.reading}</p><p>${s.portuguese}</p></li>`;
                    });
                    geminiContent += `</ul>`;
                }
                if (info.curiosities) {
                    geminiContent += `<h3>Curiosidades</h3><p>${info.curiosities}</p>`;
                }
                if (info.grammar) {
                    geminiContent += `<h3>Dica Gramatical</h3><p>${info.grammar}</p>`;
                }
                geminiContent += `</div>`;
            }

            return `<button class="sound-btn" onclick="window.speak('${textToSpeak}')"><i class="ph-speaker-high"></i></button>
                    <div class="flex-grow w-full flex flex-col items-center justify-start text-center">
                        <p style="font-size: 3rem; font-family: var(--font-jp);">${card.kanji}</p>
                        <p class="text-xl mt-2">${card.pronunciation}</p>
                        <p class="text-2xl mt-4 font-bold">${card.meaning}</p>
                        ${geminiContent}
                    </div>
                    <div id="back-card-buttons" class="w-full mt-auto pt-4 flex-shrink-0"></div>`;
        }
        
        function setupBackButtonListener() { const backButtonsContainer = document.getElementById('back-card-buttons'); if (backButtonsContainer) { backButtonsContainer.innerHTML = `<div class="grid grid-cols-2 gap-4 w-full"><button class="btn btn-danger" id="hard-btn-back">Difícil</button><button class="btn btn-success" id="easy-btn-back">Fácil</button></div>`; document.getElementById('hard-btn-back').addEventListener('click', () => handleFeedback(false)); document.getElementById('easy-btn-back').addEventListener('click', () => handleFeedback(true)); } }
        function renderCheckButton(text, onClick) { dom.feedbackButtons.innerHTML = `<button id="check-btn" class="btn btn-primary col-span-2">${text}</button>`; document.getElementById('check-btn').addEventListener('click', onClick); }
        function displayCompletion() { const message = isStudyMoreSession ? "Sessão de estudo extra finalizada!" : "Nenhuma revisão restante para hoje."; dom.cardFront.innerHTML = `<div class="text-center"><p class="text-3xl">🎉</p><p class="text-2xl font-bold mt-4" style="color: var(--success);">Parabéns!</p><p class="text-lg mt-2">${message}</p></div>`; dom.cardBack.innerHTML = ''; dom.feedbackButtons.innerHTML = ''; }
        function startStudyMoreSession() { if (!allCards.kanji || allCards.kanji.length === 0) return; const shuffled = [...allCards.kanji].sort(() => 0.5 - Math.random()); dueCards = shuffled.slice(0, 10); sessionInitialCount = dueCards.length; isStudyMoreSession = true; updateProgress(); nextCard(); }
        dom.studyMoreBtn.addEventListener('click', startStudyMoreSession);
        function updateProgress() { const reviewed = sessionInitialCount - dueCards.length; const total = sessionInitialCount; const percentage = total > 0 ? (reviewed / total) * 100 : 0; dom.progressBar.style.width = `${percentage}%`; dom.progressText.textContent = `${reviewed} / ${total}`; }
        
        async function handleFeedback(isCorrect) {
            if (!currentCard) return;
            const cardToUpdate = { ...currentCard };
            dueCards.shift();
            
            if (!isStudyMoreSession) {
                let newSrsLevel = cardToUpdate.srsLevel || 0;
                newSrsLevel = isCorrect ? Math.min(newSrsLevel + 1, 7) : Math.max(0, newSrsLevel - 1);
                
                if (!isCorrect) dueCards.push(cardToUpdate); 
                
                const cardRef = ref(db, `artifacts/${appId}/users/${userId}/kanjiCards/${cardToUpdate.id}`);
                const updatedData = { ...cardToUpdate, srsLevel: newSrsLevel, lastReview: new Date().toISOString() };
                delete updatedData.id;
                await set(cardRef, updatedData);
            } else if (!isCorrect) {
                dueCards.push(cardToUpdate);
            }
            
            updateProgress();
            nextCard();
        }
        window.speak = speak;
        
        // --- JOGOS ---
        function renderGameUI(title, description, content) { dom.gameContainer.innerHTML = `<div class="text-center mb-8"><h2 class="text-3xl font-bold">${title}</h2><p class="text-gray-500 mt-2">${description}</p></div><div id="game-content">${content}</div>`; }
        function renderGameCompletion(playAgainFunction) { dom.gameContainer.innerHTML = `<div class="text-center"><h2 class="text-3xl font-bold" style="color: var(--success)">Parabéns!</h2><p class="mt-2">Você completou o desafio.</p><button id="play-again-btn" class="btn btn-primary mt-6">Jogar Novamente</button></div>`; document.getElementById('play-again-btn').addEventListener('click', playAgainFunction); }
        function getGameCards(count = 5) { if (allCards.kanji.length < count) { dom.gameContainer.innerHTML = `<div class="text-center"><h2 class="text-2xl font-bold">Cards Insuficientes</h2><p>Você precisa de pelo menos ${count} cards para jogar este modo.</p></div>`; return null; } return [...allCards.kanji].sort(() => 0.5 - Math.random()).slice(0, count); }
        function startMatchingGame() { showView('game-match'); const gameCards = getGameCards(5); if (!gameCards) return; const kanjis = gameCards.map(c => ({ id: c.id, text: c.kanji })).sort(() => 0.5 - Math.random()); const meanings = gameCards.map(c => ({ id: c.id, text: c.meaning })).sort(() => 0.5 - Math.random()); const content = `<div class="game-board" style="grid-template-columns: 1fr 1fr;"><div id="kanji-column">${kanjis.map(k => `<div class="game-option kanji" data-id="${k.id}">${k.text}</div>`).join('')}</div><div id="meaning-column">${meanings.map(m => `<div class="game-option" data-id="${m.id}">${m.text}</div>`).join('')}</div></div>`; renderGameUI('Combine o Kanji', 'Clique em um kanji e no seu significado correspondente.', content); let selectedKanji = null, selectedMeaning = null, correctPairs = 0; const kanjiItems = document.querySelectorAll('#kanji-column .game-option'); const meaningItems = document.querySelectorAll('#meaning-column .game-option'); function handleSelection(items, selectedItem, currentSelection) { if (currentSelection === selectedItem) { selectedItem.classList.remove('selected'); return null; } items.forEach(i => i.classList.remove('selected')); selectedItem.classList.add('selected'); return selectedItem; } function checkMatch() { if (!selectedKanji || !selectedMeaning) return; if (selectedKanji.dataset.id === selectedMeaning.dataset.id) { selectedKanji.classList.add('correct'); selectedMeaning.classList.add('correct'); selectedKanji = null; selectedMeaning = null; correctPairs++; if (correctPairs === gameCards.length) { setTimeout(() => renderGameCompletion(startMatchingGame), 500); } } else { selectedKanji.classList.add('incorrect'); selectedMeaning.classList.add('incorrect'); setTimeout(() => { selectedKanji?.classList.remove('incorrect', 'selected'); selectedMeaning?.classList.remove('incorrect', 'selected'); selectedKanji = null; selectedMeaning = null; }, 500); } } kanjiItems.forEach(item => item.addEventListener('click', () => { if (item.classList.contains('correct')) return; selectedKanji = handleSelection(kanjiItems, item, selectedKanji); checkMatch(); })); meaningItems.forEach(item => item.addEventListener('click', () => { if (item.classList.contains('correct')) return; selectedMeaning = handleSelection(meaningItems, item, selectedMeaning); checkMatch(); })); }
        function startQuizGame() { showView('game-quiz'); const gameCards = getGameCards(10); if (!gameCards || gameCards.length < 4) { return; } let currentQuestionIndex = 0; function displayQuestion() { const card = gameCards[currentQuestionIndex]; const incorrectAnswers = allCards.kanji.filter(c => c.id !== card.id).sort(() => 0.5 - Math.random()).slice(0, 3).map(c => c.meaning); const options = [card.meaning, ...incorrectAnswers].sort(() => 0.5 - Math.random()); const content = `<div class="text-center text-7xl font-bold font-['Noto_Sans_JP'] mb-8">${card.kanji}</div><div class="game-board" style="grid-template-columns: repeat(2, 1fr);">${options.map(opt => `<div class="game-option" data-correct="${opt === card.meaning}">${opt}</div>`).join('')}</div>`; renderGameUI('Quiz de Kanji', `Qual o significado deste kanji? (${currentQuestionIndex + 1}/${gameCards.length})`, content); document.querySelectorAll('.game-option').forEach(option => { option.addEventListener('click', () => { document.querySelectorAll('.game-option').forEach(btn => btn.style.pointerEvents = 'none'); const isCorrect = option.dataset.correct === 'true'; option.classList.add(isCorrect ? 'correct' : 'incorrect'); if (!isCorrect) { document.querySelector('.game-option[data-correct="true"]').classList.add('correct'); } setTimeout(() => { currentQuestionIndex++; if (currentQuestionIndex < gameCards.length) { displayQuestion(); } else { renderGameCompletion(startQuizGame); } }, 1500); }); }); } displayQuestion(); }
        function startTypingGame() { showView('game-type'); const gameCards = getGameCards(10); if (!gameCards) { return; } let currentQuestionIndex = 0; function displayQuestion() { const card = gameCards[currentQuestionIndex]; const content = `<div class="text-center"><div class="text-7xl font-bold font-['Noto_Sans_JP']">${card.kanji}</div><div class="text-2xl text-gray-500 mt-2">${card.meaning}</div><input type="text" id="typing-input" class="input mt-8 text-2xl text-center" placeholder="Digite a leitura (romaji)" autocomplete="off" autocorrect="off" spellcheck="false"><p id="typing-feedback" class="mt-4 h-6 font-bold"></p></div>`; renderGameUI('Digite a Leitura', `Escreva a pronúncia e pressione Enter (${currentQuestionIndex + 1}/${gameCards.length})`, content); const input = document.getElementById('typing-input'); input.focus(); input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const feedback = document.getElementById('typing-feedback'); if (input.value.toLowerCase().trim() === card.pronunciation.toLowerCase().trim()) { input.classList.add('correct'); feedback.textContent = 'Correto!'; feedback.style.color = 'var(--success)'; } else { input.classList.add('incorrect'); feedback.innerHTML = `Incorreto. A resposta era: <strong>${card.pronunciation}</strong>`; feedback.style.color = 'var(--danger)'; } input.disabled = true; setTimeout(() => { currentQuestionIndex++; if (currentQuestionIndex < gameCards.length) { displayQuestion(); } else { renderGameCompletion(startTypingGame); } }, 1500); } }); } displayQuestion(); }

        function startMemoryGame() {
            showView('game-memory');
            const gameCards = getGameCards(8);
            if (!gameCards) { return; }
            let items = [];
            gameCards.forEach(card => {
                items.push({ type: 'kanji', text: card.kanji, id: card.id });
                items.push({ type: 'meaning', text: card.meaning, id: card.id });
            });
            items.sort(() => 0.5 - Math.random());
            const content = `<div class="memory-grid">${items.map((item, index) => `
                <div class="memory-card" data-id="${item.id}" data-index="${index}">
                    <div class="card-content ${item.type === 'kanji' ? 'kanji' : ''}">${item.text}</div>
                </div>`).join('')}</div>`;
            renderGameUI('Jogo da Memória', 'Encontre os pares de kanji e significado.', content);
            let flippedCards = [];
            let matchedPairs = 0;
            const allMemoryCards = document.querySelectorAll('.memory-card');
            allMemoryCards.forEach(card => card.addEventListener('click', () => {
                if (flippedCards.length < 2 && !card.classList.contains('flipped') && !card.classList.contains('matched')) {
                    card.classList.add('flipped');
                    flippedCards.push(card);
                    if (flippedCards.length === 2) {
                        const [card1, card2] = flippedCards;
                        if (card1.dataset.id === card2.dataset.id) {
                            card1.classList.add('matched');
                            card2.classList.add('matched');
                            matchedPairs++;
                            flippedCards = [];
                            if (matchedPairs === gameCards.length) {
                                setTimeout(() => renderGameCompletion(startMemoryGame), 500);
                            }
                        } else {
                            setTimeout(() => {
                                card1.classList.remove('flipped');
                                card2.classList.remove('flipped');
                                flippedCards = [];
                            }, 1000);
                        }
                    }
                }
            }));
        }

        // --- LÓGICA DE GERENCIAMENTO ---
        dom.navManage.addEventListener('click', (e) => { e.preventDefault(); showView('manage'); });
        dom.closeManageModalBtn.addEventListener('click', () => dom.manageModal.classList.remove('visible'));
        dom.addNewCardBtn.addEventListener('click', () => openAddEditModal());
        dom.cancelEditBtn.addEventListener('click', () => dom.addEditModal.classList.remove('visible'));
        dom.manageAccountBtn.addEventListener('click', (e) => { e.preventDefault(); dom.userManageModal.classList.add('visible'); dom.userMenuDropdown.classList.remove('visible'); });
        dom.cancelUserManageBtn.addEventListener('click', () => dom.userManageModal.classList.remove('visible'));

        function renderManageView() {
            dom.cardListContainer.innerHTML = '';
            if (allCards.kanji.length === 0) {
                dom.cardListContainer.innerHTML = `<p class="text-center text-gray-500">Você ainda não tem cards.</p>`;
                return;
            }
            const sortedCards = [...allCards.kanji].sort((a, b) => a.kanji.localeCompare(b.kanji, 'ja'));
            sortedCards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'flex items-center justify-between p-4 rounded-lg bg-white border border-gray-200';
                cardElement.innerHTML = `
                    <div>
                        <p class="text-xl font-bold font-['Noto_Sans_JP']">${card.kanji}</p>
                        <p class="text-sm text-gray-600">${card.meaning}</p>
                    </div>
                    <div class="space-x-2">
                        <button class="edit-btn btn btn-secondary text-xs p-2"><i class="ph-pencil-simple"></i></button>
                        <button class="delete-btn btn btn-danger text-xs p-2"><i class="ph-trash"></i></button>
                    </div>`;
                cardElement.querySelector('.edit-btn').addEventListener('click', () => openAddEditModal(card));
                cardElement.querySelector('.delete-btn').addEventListener('click', () => deleteCard(card.id));
                dom.cardListContainer.appendChild(cardElement);
            });
        }
        
        function openAddEditModal(card = null) {
            dom.addEditForm.reset();
            if (card) {
                dom.addEditModalTitle.textContent = 'Editar Card';
                dom.cardIdInput.value = card.id;
                dom.kanjiInput.value = card.kanji;
                dom.pronunciationInput.value = card.pronunciation;
                dom.meaningInput.value = card.meaning;
                dom.geminiDataInput.value = card.geminiInfo ? JSON.stringify(card.geminiInfo) : '';
            } else {
                dom.addEditModalTitle.textContent = 'Adicionar Card';
                dom.cardIdInput.value = '';
                 dom.geminiDataInput.value = '';
            }
            dom.addEditModal.classList.add('visible');
        }
        
        async function deleteCard(cardId) {
            if (window.confirm('Tem certeza que deseja apagar este card?')) {
                try {
                    await remove(ref(db, `artifacts/${appId}/users/${userId}/kanjiCards/${cardId}`));
                } catch(error) {
                    console.error("Erro ao apagar card:", error);
                }
            }
        }
        
        // --- GEMINI API E FORMULÁRIO DE CARD ---
        dom.generateAiBtn.addEventListener('click', async () => {
            const kanji = dom.kanjiInput.value;
            if (!kanji.trim()) {
                alert("Por favor, insira um kanji.");
                return;
            }
            
            dom.generateAiBtn.disabled = true;
            dom.aiBtnText.style.display = 'none';
            dom.aiBtnSpinner.style.display = 'block';

            try {
                const geminiData = await fetchGeminiDataForFields(kanji);
                 if (geminiData) {
                    dom.pronunciationInput.value = geminiData.pronunciation || '';
                    dom.meaningInput.value = geminiData.meaning || '';
                    dom.geminiDataInput.value = JSON.stringify(geminiData);
                } else {
                    alert("Não foi possível gerar informações com a IA. Tente novamente.");
                }
            } catch (error) {
                console.error("Erro na geração com IA:", error);
                alert("Ocorreu um erro ao contatar a IA.");
            } finally {
                dom.generateAiBtn.disabled = false;
                dom.aiBtnText.style.display = 'inline';
                dom.aiBtnSpinner.style.display = 'none';
            }
        });

        async function fetchGeminiDataForFields(kanji) {
             const apiKey = "AIzaSyCpNSwWWEbyWhklPL96AAweF2qhjeLrWlM";
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
             
             const systemPrompt = `Você é um professor de japonês para falantes de português. Forneça informações concisas e úteis sobre um kanji. Responda em JSON.`;
             const userQuery = `Analise o kanji "${kanji}". Quero informações para um flashcard de aprendizado de japonês para um falante de português. Forneça o seguinte em formato JSON:
1. "pronunciation": A leitura (pronúncia) mais comum do kanji em romaji.
2. "meaning": O significado principal em português, de forma concisa.
3. "sentences": Uma lista com duas frases de exemplo. Cada frase deve usar o kanji em um contexto prático, ser simples, e conter apenas o kanji principal com o resto em hiragana/katakana. Inclua "japanese" (a frase em japonês), "reading" (a leitura da frase em hiragana ou romaji), e "portuguese" (a tradução).
4. "curiosities": Um parágrafo curto com uma curiosidade interessante sobre a origem, composição ou uso do kanji. Algo que ajude na memorização.
5. "grammar": Um parágrafo curto com uma dica gramatical sobre como usar o kanji ou palavras comuns que o utilizam.`;
             
             const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "pronunciation": { "type": "STRING", "description": "Leitura principal do kanji em romaji." },
                            "meaning": { "type": "STRING", "description": "Significado principal do kanji em português." },
                            "sentences": { type: "ARRAY", items: { type: "OBJECT", properties: { "japanese": { "type": "STRING" }, "reading": { "type": "STRING" }, "portuguese": { "type": "STRING" } }, required: ["japanese", "reading", "portuguese"]}},
                            "curiosities": { "type": "STRING", "description": "Curiosidade ou mnemônico." },
                            "grammar": { "type": "STRING", "description": "Dica de gramática." }
                        },
                         required: ["pronunciation", "meaning", "sentences", "curiosities", "grammar"]
                    }
                }
             };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(jsonText);
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                return null;
            }
        }

        dom.addEditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const cardData = {
                kanji: dom.kanjiInput.value,
                pronunciation: dom.pronunciationInput.value,
                meaning: dom.meaningInput.value,
                srsLevel: 0,
                lastReview: new Date().toISOString(),
                geminiInfo: dom.geminiDataInput.value ? JSON.parse(dom.geminiDataInput.value) : null
            };
            const cardId = dom.cardIdInput.value;
            
            try {
                const cardsRef = ref(db, `artifacts/${appId}/users/${userId}/kanjiCards`);
                if (cardId) { 
                    await set(ref(db, `artifacts/${appId}/users/${userId}/kanjiCards/${cardId}`), cardData);
                } else { 
                    await push(cardsRef, cardData);
                }
                dom.addEditModal.classList.remove('visible');
            } catch(error) {
                console.error("Erro ao salvar card:", error);
            }
        });


        // --- LÓGICA DE AUTENTICAÇÃO E CONTA ---
        dom.logoutBtn.addEventListener('click', () => signOut(auth));
        
        let isSignInMode = true;
        const authElements = {
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            confirmPasswordInput: document.getElementById('confirmPasswordInput'),
            authBtn: document.getElementById('authBtn'),
            toggleAuthMode: document.getElementById('toggleAuthMode'),
            authModalTitle: document.getElementById('auth-modal-title'),
            authStatusMessage: document.getElementById('auth-status-message')
        };

        authElements.toggleAuthMode.addEventListener('click', () => {
            isSignInMode = !isSignInMode;
            authElements.authModalTitle.textContent = isSignInMode ? 'Entrar' : 'Criar Conta';
            authElements.authBtn.textContent = isSignInMode ? 'Entrar' : 'Criar Conta';
            authElements.toggleAuthMode.textContent = isSignInMode ? 'Ainda não tem uma conta? Crie uma.' : 'Já tem uma conta? Entrar.';
            authElements.confirmPasswordInput.style.display = isSignInMode ? 'none' : 'block';
            authElements.authStatusMessage.textContent = '';
        });

        authElements.authBtn.addEventListener('click', async () => {
            const email = authElements.emailInput.value;
            const password = authElements.passwordInput.value;
            authElements.authStatusMessage.textContent = 'Processando...';
            try {
                if (isSignInMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const confirmPassword = authElements.confirmPasswordInput.value;
                    if (password !== confirmPassword) {
                        authElements.authStatusMessage.textContent = 'As senhas não coincidem.'; return;
                    }
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                authElements.authStatusMessage.textContent = "Falha na autenticação: " + error.message;
            }
        });
        
        dom.updatePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password-input').value;
            const confirmPassword = document.getElementById('confirm-new-password-input').value;
            const statusEl = dom.updatePasswordStatus;

            if (newPassword !== confirmPassword) {
                statusEl.textContent = 'As senhas não coincidem.';
                statusEl.style.color = 'var(--danger)';
                return;
            }
            if(newPassword.length < 6) {
                 statusEl.textContent = 'A senha deve ter no mínimo 6 caracteres.';
                 statusEl.style.color = 'var(--danger)';
                 return;
            }

            statusEl.textContent = 'Atualizando...';
            statusEl.style.color = 'var(--text-secondary)';

            try {
                const user = auth.currentUser;
                await updatePassword(user, newPassword);
                statusEl.textContent = 'Senha atualizada com sucesso!';
                statusEl.style.color = 'var(--success)';
                setTimeout(() => {
                    dom.userManageModal.classList.remove('visible');
                    statusEl.textContent = '';
                    dom.updatePasswordForm.reset();
                }, 2000);
            } catch (error) {
                console.error("Erro ao atualizar senha:", error);
                statusEl.textContent = 'Erro ao atualizar. Tente novamente.';
                statusEl.style.color = 'var(--danger)';
            }
        });

    </script>
</body>
</html>

