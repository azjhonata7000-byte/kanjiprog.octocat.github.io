<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRS Japanese Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&amp;display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
        }
        .container {
            max-width: 640px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .card {
            background-color: #1f2937;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .question-text {
            font-size: 3rem;
            font-weight: bold;
            line-height: 1.2;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: #e2e8f0;
        }
        .kana-character {
            font-size: 8rem;
            line-height: 1;
        }
        .sentence-text {
            font-size: 1.5rem;
            margin-top: 1rem;
            color: #d1d5db;
        }
        .button {
            padding: 0.75rem 1.75rem;
            border-radius: 9999px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .button:hover {
            transform: translateY(-2px);
        }
        .reveal-button {
            background-color: #4b5563;
        }
        .reveal-button:hover {
            background-color: #6b7280;
        }
        .easy-button {
            background-color: #10b981;
        }
        .easy-button:hover {
            background-color: #059669;
        }
        .hard-button {
            background-color: #ef4444;
        }
        .hard-button:hover {
            background-color: #dc2626;
        }
        .audio-button {
            background-color: #3b82f6;
        }
        .audio-button:hover {
            background-color: #2563eb;
        }
        .word-explanation-list {
            margin-top: 1.5rem;
            padding-left: 1.5rem;
            color: #d1d5db;
        }
        #audio-loading-text {
            display: none;
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }
        #loading-overlay, #add-card-modal, #card-list-modal, #auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #1f2937;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            overflow-y: auto;
        }
        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #374151;
        }
        .card-item:last-child {
            border-bottom: none;
        }
        .highlight-kanji {
            color: #60a5fa;
            font-weight: bold;
        }
        .srs-level-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
            color: white;
        }
        .srs-level-0 { background-color: #f87171; }
        .srs-level-1 { background-color: #facc15; }
        .srs-level-2 { background-color: #a3e635; } /* Level 2 - light green */
        .srs-level-3 { background-color: #22c55e; } /* Level 3 - green */
        .srs-level-4 { background-color: #16a34a; } /* Level 4 - deep green */
        .srs-level-5 { background-color: #0d9488; } /* Level 5 - teal */
        .srs-level-6 { background-color: #4f46e5; } /* Level 6 - blue */
        .input, .textarea, .select {
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #374151;
            border: 1px solid #4b5563;
            color: #e5e7eb;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input:focus, .textarea:focus, .select:focus {
            outline: none;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center">

    <!-- User Info & Logout Button -->
    <header class="w-full flex justify-between p-4 items-center">
        <div class="flex items-center space-x-2">
            <label for="mode-select" class="text-gray-300 text-sm">Modo de Estudo:</label>
            <select id="mode-select" class="select text-sm p-1">
                <option value="kanji">Kanji</option>
                <option value="hiragana">Hiragana</option>
                <option value="katakana">Katakana</option>
            </select>
        </div>
        <div id="userInfo" class="flex items-center space-x-2">
            <span id="userEmailDisplay" class="text-gray-300 text-sm"></span>
            <button id="logoutBtn" class="button bg-gray-600 hover:bg-gray-700 text-xs px-3 py-1" style="display:none;">Sair</button>
        </div>
    </header>

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-white text-lg">Carregando dados...</p>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal">
        <div class="modal-content text-center">
            <h2 class="text-3xl font-bold mb-6" id="auth-modal-title">Entrar</h2>
            <div class="flex flex-col space-y-4">
                <input type="email" id="emailInput" placeholder="Email" class="input">
                <input type="password" id="passwordInput" placeholder="Senha" class="input">
                <input type="password" id="confirmPasswordInput" placeholder="Confirmar Senha" class="input" style="display: none;">
                <button id="authBtn" class="button bg-blue-500 hover:bg-blue-600">Entrar</button>
                <p id="toggleAuthMode" class="text-sm cursor-pointer hover:underline text-gray-400">Ainda não tem uma conta? Crie uma.</p>
            </div>
            <p id="auth-status-message" class="mt-4 text-sm text-gray-400"></p>
        </div>
    </div>

    <div id="add-card-modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-3xl font-bold mb-6">Adicionar Novo Card</h2>
            <!-- Kanban Inputs -->
            <div id="kanji-inputs" class="flex flex-col space-y-4" style="display: none;">
                <input type="text" id="kanjiInput" placeholder="Kanji" class="input">
                <input type="text" id="kanjiPronunciationInput" placeholder="Pronúncia (em Hiragana)" class="input">
                <input type="text" id="kanjiMeaningInput" placeholder="Significado (em Português)" class="input">
                <textarea id="kanjiSentenceInput" placeholder="Frase de Exemplo (em Japonês)" class="textarea h-24 resize-none"></textarea>
                <div class="flex space-x-2">
                    <button id="kanjiSaveCardBtn" class="button bg-blue-500 hover:bg-blue-600 flex-1">Salvar Card</button>
                    <button id="kanjiGenerateBtn" class="button bg-green-500 hover:bg-green-600 flex-1">Gerar Frase com IA</button>
                </div>
            </div>
            <!-- Kana Inputs -->
            <div id="kana-inputs" class="flex flex-col space-y-4" style="display: none;">
                <input type="text" id="characterInput" placeholder="Caractere (あ, ア)" class="input">
                <input type="text" id="romajiInput" placeholder="Romanji (a)" class="input">
                <div class="flex space-x-2">
                    <button id="kanaSaveCardBtn" class="button bg-blue-500 hover:bg-blue-600 flex-1">Salvar Card</button>
                </div>
            </div>

            <button id="closeModalBtn" class="button bg-red-500 hover:bg-red-600 mt-4 w-full">Cancelar</button>
            <p id="statusMessage" class="mt-4 text-sm text-gray-400"></p>
        </div>
    </div>

    <div id="card-list-modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-3xl font-bold mb-6">Gerenciar Cards</h2>
            <div id="cardsList" class="flex flex-col space-y-3">
                <!-- Cards will be populated here -->
            </div>
            <button id="addNewCardBtn" class="button bg-indigo-500 hover:bg-indigo-600 mt-6 w-full">Adicionar Novo Card</button>
            <button id="closeListModalBtn" class="button bg-gray-500 hover:bg-gray-600 mt-2 w-full">Fechar</button>
        </div>
    </div>

    <div class="container" style="display: none;">
        <!-- User ID display -->
        <p id="userIdDisplay" class="text-xs text-gray-500 text-center mb-4"></p>
        
        <div class="flex flex-col items-center">
            <div id="card" class="card text-center relative w-full">
                <p id="question-text" class="question-text" style="opacity: 0;">.</p>
                <input type="text" id="userInput" placeholder="Sua resposta" class="input text-center mt-4" style="display: none;">
                <div id="answer-container" class="mt-6" style="display: none;">
                    <p id="sentence-text" class="sentence-text">
                        <span class="highlight-kanji"></span>
                    </p>
                    <p id="meaning-text" class="text-sm italic mt-3 text-gray-400"></p>
                    <p id="pronunciation-text" class="mt-2 text-sm text-gray-400"></p>
                    <p id="romaji-text" class="mt-2 text-sm text-gray-400"></p>

                    <!-- New section for word explanations -->
                    <div id="word-explanation-container" class="mt-6" style="display: none;">
                        <h3 class="text-xl font-bold text-gray-200">Palavras-chave:</h3>
                        <p id="explanation-loading-text" class="mt-2 text-sm text-gray-400" style="display: none;">Gerando explicações...</p>
                        <ul id="word-explanation-list" class="list-disc list-inside text-left word-explanation-list">
                            <!-- Explanations will be populated here -->
                        </ul>
                    </div>

                    <button id="listenBtn" class="audio-button mt-6" style="display: none;">Ouvir</button>
                    <p id="audio-loading-text">Carregando áudio...</p>
                </div>
            </div>
            <!-- Progress Bar -->
            <div class="w-full mt-6">
                <div class="h-2 bg-gray-700 rounded-full">
                    <div id="progress-bar" class="h-2 bg-green-500 rounded-full transition-all duration-300 ease-in-out" style="width: 0%;"></div>
                </div>
                <p id="progress-text" class="text-right text-xs text-gray-400 mt-1">0 / 0</p>
            </div>
            <div class="mt-8 flex flex-col space-y-4 items-center w-full">
                <div id="feedback-buttons-container" class="flex space-x-4 w-full justify-center">
                    <button id="showAnswerBtn" class="button reveal-button flex-1 max-w-[200px]">Mostrar Resposta</button>
                    <button id="checkAnswerBtn" class="button bg-blue-500 hover:bg-blue-600 flex-1 max-w-[200px]" style="display: none;">Verificar Resposta</button>
                    <button id="easyBtn" class="button easy-button flex-1 max-w-[200px]" style="display: none;">Fácil</button>
                    <button id="hardBtn" class="button hard-button flex-1 max-w-[200px]" style="display: none;">Difícil</button>
                </div>
                <!-- New buttons for hard choice -->
                <div id="hard-choice-buttons" class="flex space-x-4 w-full justify-center" style="display: none;">
                    <button id="reviewAgainBtn" class="button bg-yellow-500 hover:bg-yellow-600 flex-1 max-w-[200px]">Revisar de novo hoje</button>
                    <button id="reviewTomorrowBtn" class="button hard-button flex-1 max-w-[200px]">Revisar amanhã</button>
                </div>
                <!-- New button to manage all cards -->
                <button id="manageCardsBtn" class="button bg-indigo-500 hover:bg-indigo-600 w-full max-w-[400px]">Gerenciar Cards</button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        
        // Firebase configuration from user's prompt
        const firebaseConfig = {
            apiKey: "AIzaSyAl4OJcZJlkn809EPdv7VUchU0ObuhcwHs",
            authDomain: "kanjis-b38b4.firebaseapp.com",
            projectId: "kanjis-b38b4",
            storageBucket: "kanjis-b38b4.firebasestorage.app",
            messagingSenderId: "794836504781",
            appId: "1:794836504781:web:b83d4bfb5e3b44ebda5984",
            databaseURL: "https://kanjis-b38b4-default-rtdb.firebaseio.com"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // Global variables for game state
        let kanjiCards = [];
        let kanjiCardsDueToday = [];
        let kanaCards = [];
        let kanaCardsDueToday = [];
        let currentCardIndex = 0;
        let userId = null;
        let isEditing = false;
        let editingIndex = -1;
        let currentMode = 'kanji';
        
        // SRS Intervals in days
        const srsIntervals = [0, 1, 2, 4, 7, 15, 30];
        
        // DOM elements
        const modeSelect = document.getElementById('mode-select');
        const questionText = document.getElementById('question-text');
        const userInput = document.getElementById('userInput');
        const sentenceText = document.getElementById('sentence-text');
        const meaningText = document.getElementById('meaning-text');
        const pronunciationText = document.getElementById('pronunciation-text');
        const romajiText = document.getElementById('romaji-text');
        const showAnswerBtn = document.getElementById('showAnswerBtn');
        const checkAnswerBtn = document.getElementById('checkAnswerBtn');
        const easyBtn = document.getElementById('easyBtn');
        const hardBtn = document.getElementById('hardBtn');
        const listenBtn = document.getElementById('listenBtn');
        const answerContainer = document.getElementById('answer-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const audioLoadingText = document.getElementById('audio-loading-text');
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContainer = document.querySelector('.container');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const manageCardsBtn = document.getElementById('manageCardsBtn');
        const addCardModal = document.getElementById('add-card-modal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cardListModal = document.getElementById('card-list-modal');
        const cardsList = document.getElementById('cardsList');
        const closeListModalBtn = document.getElementById('closeListModalBtn');
        const addNewCardBtn = document.getElementById('addNewCardBtn');
        const explanationLoadingText = document.getElementById('explanation-loading-text');
        const wordExplanationContainer = document.getElementById('word-explanation-container');
        const wordExplanationList = document.getElementById('word-explanation-list');
        const feedbackButtonsContainer = document.getElementById('feedback-buttons-container');
        const hardChoiceButtons = document.getElementById('hard-choice-buttons');
        const reviewAgainBtn = document.getElementById('reviewAgainBtn');
        const reviewTomorrowBtn = document.getElementById('reviewTomorrowBtn');

        // New DOM elements for auth modal
        const authModal = document.getElementById('auth-modal');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const confirmPasswordInput = document.getElementById('confirmPasswordInput');
        const authBtn = document.getElementById('authBtn');
        const toggleAuthMode = document.getElementById('toggleAuthMode');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authStatusMessage = document.getElementById('auth-status-message');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Modal inputs
        const kanjiInputs = document.getElementById('kanji-inputs');
        const kanjiInput = document.getElementById('kanjiInput');
        const kanjiPronunciationInput = document.getElementById('kanjiPronunciationInput');
        const kanjiMeaningInput = document.getElementById('kanjiMeaningInput');
        const kanjiSentenceInput = document.getElementById('kanjiSentenceInput');
        const kanjiSaveCardBtn = document.getElementById('kanjiSaveCardBtn');
        const kanjiGenerateBtn = document.getElementById('kanjiGenerateBtn');

        const kanaInputs = document.getElementById('kana-inputs');
        const characterInput = document.getElementById('characterInput');
        const romajiInput = document.getElementById('romajiInput');
        const kanaSaveCardBtn = document.getElementById('kanaSaveCardBtn');
        
        const statusMessage = document.getElementById('statusMessage');

        let isSignInMode = true;

        // Functions for Firebase
        const saveCards = async () => {
            if (userId) {
                const kanjiCardsRef = ref(db, `users/${userId}/kanjiCards`);
                const kanaCardsRef = ref(db, `users/${userId}/kanaCards`);
                await Promise.all([set(kanjiCardsRef, kanjiCards), set(kanaCardsRef, kanaCards)]);
            }
        };

        const loadCards = async () => {
            if (userId) {
                const kanjiCardsRef = ref(db, `users/${userId}/kanjiCards`);
                const kanaCardsRef = ref(db, `users/${userId}/kanaCards`);
                
                const [kanjiSnapshot, kanaSnapshot] = await Promise.all([get(kanjiCardsRef), get(kanaCardsRef)]);

                kanjiCards = kanjiSnapshot.exists() ? kanjiSnapshot.val() : [];
                kanaCards = kanaSnapshot.exists() ? kanaSnapshot.val() : [];

                // Ensure all kanji cards have required SRS properties
                kanjiCards.forEach(card => {
                    if (typeof card.srsLevel !== 'number') card.srsLevel = 0;
                    if (typeof card.lastReview !== 'number') card.lastReview = 0;
                    if (typeof card.incorrectAttempts !== 'number') card.incorrectAttempts = 0;
                });
                // Ensure all kana cards have required SRS properties
                kanaCards.forEach(card => {
                    if (typeof card.srsLevel !== 'number') card.srsLevel = 0;
                    if (typeof card.lastReview !== 'number') card.lastReview = 0;
                    if (typeof card.incorrectAttempts !== 'number') card.incorrectAttempts = 0;
                });
            } else {
                kanjiCards = [];
                kanaCards = [];
            }
            filterCardsDueToday();
        };

        const filterCardsDueToday = () => {
            const now = Date.now();
            if (currentMode === 'kanji') {
                kanjiCardsDueToday = kanjiCards.filter(card => {
                    const dueTimestamp = card.lastReview + (srsIntervals[card.srsLevel] || 0) * 24 * 60 * 60 * 1000;
                    return now >= dueTimestamp;
                });
                kanjiCardsDueToday.sort(() => Math.random() - 0.5);
            } else {
                kanaCardsDueToday = kanaCards.filter(card => {
                    const dueTimestamp = card.lastReview + (srsIntervals[card.srsLevel] || 0) * 24 * 60 * 60 * 1000;
                    return now >= dueTimestamp;
                });
                kanaCardsDueToday.sort(() => Math.random() - 0.5);
            }
            selectCardForReview();
            updateProgress();
            loadingOverlay.style.display = 'none';
            mainContainer.style.display = 'flex';
        };

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            loadingOverlay.style.display = 'none'; // Hide loading overlay when auth state is determined
            if (user) {
                // User is signed in, proceed to main app
                userId = user.uid;
                userIdDisplay.textContent = `User ID: ${userId}`;
                userEmailDisplay.textContent = user.email;
                logoutBtn.style.display = 'inline-block';
                authModal.style.display = 'none';
                mainContainer.style.display = 'flex';
                loadCards();
            } else {
                // No user is signed in, show the auth modal
                userId = null;
                userEmailDisplay.textContent = '';
                logoutBtn.style.display = 'none';
                authModal.style.display = 'flex';
                mainContainer.style.display = 'none';
            }
        });

        function updateProgress() {
            let totalCount = 0;
            let reviewedCount = 0;
            if (currentMode === 'kanji') {
                totalCount = kanjiCards.length;
                reviewedCount = kanjiCards.length - kanjiCardsDueToday.length;
            } else {
                totalCount = kanaCards.length;
                reviewedCount = kanaCards.length - kanaCardsDueToday.length;
            }
            const percentage = (reviewedCount / totalCount) * 100 || 0;
            progressBar.style.width = percentage + '%';
            progressText.textContent = `${reviewedCount} / ${totalCount}`;
        }

        function selectCardForReview() {
            let cardsToReview;
            if (currentMode === 'kanji') {
                cardsToReview = kanjiCardsDueToday;
            } else {
                cardsToReview = kanaCardsDueToday;
            }

            if (cardsToReview.length === 0) {
                 questionText.textContent = 'Parabéns! Nenhuma revisão restante para hoje.';
                 questionText.style.opacity = '1';
                 userInput.style.display = 'none';
                 answerContainer.style.display = 'none';
                 feedbackButtonsContainer.style.display = 'none';
                 hardChoiceButtons.style.display = 'none';
                 return;
            }
            
            currentCardIndex = 0; // Always start with the first card in the filtered list
            displayCard();
        }

        function displayCard() {
            let card;
            if (currentMode === 'kanji') {
                card = kanjiCardsDueToday[currentCardIndex];
            } else {
                card = kanaCardsDueToday[currentCardIndex];
            }

            if (!card) {
                selectCardForReview();
                return;
            }

            userInput.value = '';
            userInput.style.display = 'block';
            answerContainer.style.display = 'none';
            feedbackButtonsContainer.style.display = 'flex';
            hardChoiceButtons.style.display = 'none';
            showAnswerBtn.style.display = 'block';
            checkAnswerBtn.style.display = 'none';
            easyBtn.style.display = 'none';
            hardBtn.style.display = 'none';

            // Clear previous explanations and hide relevant containers
            wordExplanationList.innerHTML = '';
            explanationLoadingText.style.display = 'none';
            wordExplanationContainer.style.display = 'none';
            listenBtn.style.display = 'none';

            if (currentMode === 'kanji') {
                questionText.textContent = card.kanji || 'N/A';
                questionText.style.fontSize = '3rem';
                showAnswerBtn.style.display = 'block';
                checkAnswerBtn.style.display = 'none';
                userInput.placeholder = "Sua resposta em Kana";
            } else {
                questionText.textContent = card.character || 'N/A';
                questionText.style.fontSize = '8rem';
                showAnswerBtn.style.display = 'none';
                checkAnswerBtn.style.display = 'block';
                userInput.placeholder = "Sua resposta em Romanji";
            }
            questionText.style.opacity = '1';
        }

        function showAnswer() {
            let card;
            if (currentMode === 'kanji') {
                card = kanjiCardsDueToday[currentCardIndex];
                const highlightedSentence = card.sentence.replace(new RegExp(card.kanji, 'g'), `<span class="highlight-kanji">${card.kanji}</span>`);
                sentenceText.innerHTML = highlightedSentence;
                meaningText.textContent = card.meaning || 'N/A';
                pronunciationText.textContent = card.pronunciation || 'N/A';
                romajiText.textContent = '';
                wordExplanationContainer.style.display = 'block';
                listenBtn.style.display = 'inline-block';
                generateWordExplanations(card.sentence, card.kanji);
            } else {
                card = kanaCardsDueToday[currentCardIndex];
                sentenceText.textContent = '';
                meaningText.textContent = '';
                pronunciationText.textContent = '';
                romajiText.textContent = `Romanji: ${card.romaji || 'N/A'}`;
                wordExplanationContainer.style.display = 'none';
                listenBtn.style.display = 'none';
            }
            answerContainer.style.display = 'block';
            userInput.style.display = 'none';
            showAnswerBtn.style.display = 'none';
            checkAnswerBtn.style.display = 'none';
            easyBtn.style.display = 'inline-block';
            hardBtn.style.display = 'inline-block';
        }

        function checkKanaAnswer() {
            const card = kanaCardsDueToday[currentCardIndex];
            const userAnswer = userInput.value.trim().toLowerCase();
            const correctAnswer = card.romaji.trim().toLowerCase();

            if (userAnswer === correctAnswer) {
                handleFeedback(true);
            } else {
                showAnswer();
            }
        }

        async function generateWordExplanations(sentence, kanji) {
            explanationLoadingText.style.display = 'block';
            wordExplanationList.innerHTML = '';
            
            const systemPrompt = `Você é um tutor de japonês. Analise a seguinte frase em japonês e forneça o significado e a leitura em hiragana/katakana das palavras-chave. Inclua o kanji principal ("${kanji}") e as outras palavras importantes. Forneça a resposta em formato JSON como um array de objetos. Cada objeto deve ter os campos "word", "pronunciation" e "meaning".`
            const userQuery = `Frase: ${sentence}`;

            const payload = {
                contents: [{
                    parts: [{ text: userQuery }]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "word": { "type": "STRING" },
                                "pronunciation": { "type": "STRING" },
                                "meaning": { "type": "STRING" }
                            },
                            "propertyOrdering": ["word", "pronunciation", "meaning"]
                        }
                    }
                }
            };
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=AIzaSyCpNSwWWEbyWhklPL96AAweF2qhjeLrWlM`;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const contentText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!contentText) {
                    throw new Error("Resposta da API vazia ou inválida.");
                }

                const explanations = JSON.parse(contentText);

                explanations.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.word} (${item.pronunciation}): ${item.meaning}`;
                    wordExplanationList.appendChild(li);
                });

            } catch (error) {
                console.error("Erro ao gerar explicações:", error);
                const li = document.createElement('li');
                li.textContent = `Erro ao carregar explicações.`;
                wordExplanationList.appendChild(li);
            } finally {
                explanationLoadingText.style.display = 'none';
            }
        }

        async function handleFeedback(isEasy) {
            let card, cardsArray, cardsDueArray;
            if (currentMode === 'kanji') {
                card = kanjiCardsDueToday[currentCardIndex];
                cardsArray = kanjiCards;
                cardsDueArray = kanjiCardsDueToday;
            } else {
                card = kanaCardsDueToday[currentCardIndex];
                cardsArray = kanaCards;
                cardsDueArray = kanaCardsDueToday;
            }
            
            const originalCardIndex = cardsArray.findIndex(c => c.id === card.id);
            if (originalCardIndex === -1) return;
            
            if (isEasy) {
                cardsArray[originalCardIndex].srsLevel = Math.min(cardsArray[originalCardIndex].srsLevel + 1, srsIntervals.length - 1);
                cardsArray[originalCardIndex].lastReview = Date.now();
                cardsArray[originalCardIndex].incorrectAttempts = 0;
            } else {
                cardsArray[originalCardIndex].incorrectAttempts++;
                if (cardsArray[originalCardIndex].incorrectAttempts >= 3) {
                    questionText.textContent = 'Você errou esta frase 3 vezes. Deseja revisá-la de novo hoje ou amanhã?';
                    answerContainer.style.display = 'none';
                    userInput.style.display = 'none';
                    feedbackButtonsContainer.style.display = 'none';
                    hardChoiceButtons.style.display = 'flex';
                    return;
                }
            }
            
            cardsDueArray.splice(currentCardIndex, 1);
            await saveCards();
            updateProgress();
            selectCardForReview();
        }

        listenBtn.addEventListener('click', () => {
            const card = kanjiCardsDueToday[currentCardIndex];
            if ('speechSynthesis' in window && card.sentence) {
                const utterance = new SpeechSynthesisUtterance(card.sentence);
                utterance.lang = 'ja-JP';
                window.speechSynthesis.speak(utterance);
            } else {
                 statusMessage.textContent = 'Áudio e frase indisponíveis para este card.';
            }
        });

        // Event listeners
        showAnswerBtn.addEventListener('click', showAnswer);
        checkAnswerBtn.addEventListener('click', checkKanaAnswer);
        easyBtn.addEventListener('click', () => handleFeedback(true));
        hardBtn.addEventListener('click', () => handleFeedback(false));
        reviewAgainBtn.addEventListener('click', () => {
             displayCard();
        });
        reviewTomorrowBtn.addEventListener('click', async () => {
             let card, cardsArray, cardsDueArray;
             if (currentMode === 'kanji') {
                 card = kanjiCardsDueToday[currentCardIndex];
                 cardsArray = kanjiCards;
                 cardsDueArray = kanjiCardsDueToday;
             } else {
                 card = kanaCardsDueToday[currentCardIndex];
                 cardsArray = kanaCards;
                 cardsDueArray = kanaCardsDueToday;
             }

             const originalCardIndex = cardsArray.findIndex(c => c.id === card.id);
             if (originalCardIndex === -1) return;

             cardsArray[originalCardIndex].srsLevel = Math.min(cardsArray[originalCardIndex].srsLevel + 1, srsIntervals.length - 1);
             cardsArray[originalCardIndex].lastReview = Date.now();
             cardsArray[originalCardIndex].incorrectAttempts = 0;
             cardsDueArray.splice(currentCardIndex, 1);
             await saveCards();
             updateProgress();
             selectCardForReview();
        });
        
        // Modal functionality
        function showAddModal(cardIndex = -1, mode = currentMode) {
            isEditing = cardIndex !== -1;
            editingIndex = cardIndex;
            addCardModal.style.display = 'flex';
            statusMessage.textContent = '';
            
            if (mode === 'kanji') {
                kanjiInputs.style.display = 'flex';
                kanaInputs.style.display = 'none';
                document.querySelector('#add-card-modal h2').textContent = isEditing ? 'Editar Card de Kanji' : 'Adicionar Novo Card de Kanji';
                if (isEditing) {
                    const card = kanjiCards[editingIndex];
                    kanjiInput.value = card.kanji || '';
                    kanjiPronunciationInput.value = card.pronunciation || '';
                    kanjiMeaningInput.value = card.meaning || '';
                    kanjiSentenceInput.value = card.sentence || '';
                } else {
                    kanjiInput.value = '';
                    kanjiPronunciationInput.value = '';
                    kanjiMeaningInput.value = '';
                    kanjiSentenceInput.value = '';
                }
            } else {
                kanjiInputs.style.display = 'none';
                kanaInputs.style.display = 'flex';
                document.querySelector('#add-card-modal h2').textContent = `Adicionar Novo Card de ${mode === 'hiragana' ? 'Hiragana' : 'Katakana'}`;
                if (isEditing) {
                    const card = kanaCards[editingIndex];
                    characterInput.value = card.character || '';
                    romajiInput.value = card.romaji || '';
                } else {
                    characterInput.value = '';
                    romajiInput.value = '';
                }
            }
        }

        function hideModal() {
            addCardModal.style.display = 'none';
        }

        async function saveKanjiCard() {
            const kanji = kanjiInput.value.trim();
            const pronunciation = kanjiPronunciationInput.value.trim();
            const meaning = kanjiMeaningInput.value.trim();
            const sentence = kanjiSentenceInput.value.trim();

            if (!kanji || !pronunciation || !meaning || !sentence) {
                statusMessage.textContent = "Por favor, preencha todos os campos.";
                return;
            }
            if (!sentence.includes(kanji)) {
                statusMessage.textContent = "A frase deve conter o kanji que você inseriu.";
                return;
            }

            const newCard = {
                id: Date.now(),
                kanji: kanji,
                pronunciation: pronunciation,
                meaning: meaning,
                sentence: sentence,
                srsLevel: 0,
                lastReview: Date.now(),
                incorrectAttempts: 0,
            };

            if (isEditing) {
                kanjiCards[editingIndex] = { ...kanjiCards[editingIndex], ...newCard };
            } else {
                kanjiCards.push(newCard);
            }
            
            await saveCards();
            loadCards();
            hideModal();
            renderCardsList();
        }

        async function saveKanaCard() {
            const character = characterInput.value.trim();
            const romaji = romajiInput.value.trim();

            if (!character || !romaji) {
                statusMessage.textContent = "Por favor, preencha todos os campos.";
                return;
            }
            if (character.length !== 1) {
                statusMessage.textContent = "Por favor, insira um único caractere.";
                return;
            }
            
            const newCard = {
                id: Date.now(),
                character: character,
                romaji: romaji,
                srsLevel: 0,
                lastReview: Date.now(),
                incorrectAttempts: 0,
                type: currentMode // 'hiragana' or 'katakana'
            };

            if (isEditing) {
                kanaCards[editingIndex] = { ...kanaCards[editingIndex], ...newCard };
            } else {
                kanaCards.push(newCard);
            }
            
            await saveCards();
            loadCards();
            hideModal();
            renderCardsList();
        }
        
        async function generateSentence() {
            const kanji = kanjiInput.value.trim();
            
            const kanjiRegex = /[\u4e00-\u9faf]/;

            if (!kanji || !kanjiRegex.test(kanji) || kanji.length !== 1) {
                statusMessage.textContent = "Por favor, insira um único kanji válido para gerar a frase.";
                return;
            }

            kanjiGenerateBtn.disabled = true;
            statusMessage.textContent = "Gerando frase com IA...";
            
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=AIzaSyCpNSwWWEbyWhklPL96AAweF2qhjeLrWlM`;

            const prompt = `Crie uma frase em japonês usando o kanji "${kanji}". A frase deve ter um contexto significativo e incluir um verbo. Use apenas o kanji fornecido, com o resto da frase em hiragana e katakana. Forneça a resposta em formato JSON com três campos: "sentence" (a frase em japonês), "pronunciation" (a pronúncia da frase inteira em hiragana ou katakana) e "meaning" (o significado da frase em português).`;

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const contentText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!contentText) {
                    throw new Error("Resposta da API vazia ou inválida.");
                }
                
                const jsonMatch = contentText.match(/```json\s*([\s\S]*?)\s*```/);
                const jsonString = jsonMatch ? jsonMatch[1] : contentText;

                const generatedData = JSON.parse(jsonString);

                kanjiPronunciationInput.value = generatedData.pronunciation || '';
                kanjiMeaningInput.value = generatedData.meaning || '';
                kanjiSentenceInput.value = generatedData.sentence || '';

                statusMessage.textContent = `Frase gerada com sucesso! Você pode editar os campos ou salvar.`;

            } catch (error) {
                console.error("Erro ao gerar a frase:", error);
                statusMessage.textContent = `Erro: ${error.message}`;
            } finally {
                kanjiGenerateBtn.disabled = false;
            }
        }

        // Functions for the card list modal
        function showManageCardsModal() {
            cardListModal.style.display = 'flex';
            renderCardsList();
        }

        function hideListModal() {
            cardListModal.style.display = 'none';
        }

        function getSrsLevelText(level) {
            switch(level) {
                case 0: return 'Novo';
                case 1: return 'Rev. 1D';
                case 2: return 'Rev. 2D';
                case 3: return 'Rev. 4D';
                case 4: return 'Rev. 7D';
                case 5: return 'Rev. 15D';
                case 6: return 'Aprendido';
                default: return 'Desconhecido';
            }
        }

        function getSrsLevelClass(level) {
            return `srs-level-${Math.min(level, 6)}`;
        }

        function renderCardsList() {
            cardsList.innerHTML = '';
            let cardsToRender = [];
            if (currentMode === 'kanji') {
                cardsToRender = kanjiCards;
            } else {
                cardsToRender = kanaCards;
            }

            if (cardsToRender.length === 0) {
                cardsList.innerHTML = '<p class="text-center text-gray-400">Nenhum card adicionado ainda.</p>';
                return;
            }

            cardsToRender.forEach((card, index) => {
                const cardItem = document.createElement('div');
                cardItem.className = 'card-item';
                
                const srsBadge = `<span class="srs-level-badge ${getSrsLevelClass(card.srsLevel)}">${getSrsLevelText(card.srsLevel)}</span>`;
                
                const cardInfo = document.createElement('span');
                if (currentMode === 'kanji') {
                    cardInfo.innerHTML = `${card.kanji || 'N/A'} - ${card.meaning || 'N/A'} ${srsBadge}`;
                } else {
                    cardInfo.innerHTML = `${card.character || 'N/A'} - ${card.romaji || 'N/A'} ${srsBadge}`;
                }
                
                const actionsDiv = document.createElement('div');
                
                const editButton = document.createElement('button');
                editButton.textContent = 'Editar';
                editButton.className = 'button bg-yellow-500 hover:bg-yellow-600 text-sm px-2 py-1 mr-2';
                editButton.addEventListener('click', () => {
                    hideListModal();
                    showAddModal(index, currentMode);
                });

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Deletar';
                deleteButton.className = 'button bg-red-500 hover:bg-red-600 text-sm px-2 py-1';
                deleteButton.addEventListener('click', () => {
                    deleteCard(index);
                });

                actionsDiv.appendChild(editButton);
                actionsDiv.appendChild(deleteButton);
                cardItem.appendChild(cardInfo);
                cardItem.appendChild(actionsDiv);
                cardsList.appendChild(cardItem);
            });
        }

        async function deleteCard(index) {
            if (currentMode === 'kanji') {
                kanjiCards.splice(index, 1);
            } else {
                kanaCards.splice(index, 1);
            }
            await saveCards();
            loadCards();
            renderCardsList();
        }

        // Event listeners for modal
        kanjiSaveCardBtn.addEventListener('click', saveKanjiCard);
        kanaSaveCardBtn.addEventListener('click', saveKanaCard);
        kanjiGenerateBtn.addEventListener('click', generateSentence);
        manageCardsBtn.addEventListener('click', showManageCardsModal);
        closeModalBtn.addEventListener('click', hideModal);
        closeListModalBtn.addEventListener('click', hideListModal);
        addNewCardBtn.addEventListener('click', () => {
            hideListModal();
            showAddModal(-1, currentMode);
        });

        // Event listeners for auth modal
        authBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            authStatusMessage.textContent = '';
            
            if (isSignInMode) {
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    authStatusMessage.textContent = 'Login bem-sucedido!';
                } catch (error) {
                    authStatusMessage.textContent = `Erro ao entrar: ${error.message}`;
                    console.error("Erro ao fazer login:", error);
                }
            } else {
                const confirmPassword = confirmPasswordInput.value;
                if (password !== confirmPassword) {
                    authStatusMessage.textContent = "As senhas não coincidem.";
                    return;
                }
                if (password.length < 6) {
                    authStatusMessage.textContent = "A senha deve ter pelo menos 6 caracteres.";
                    return;
                }
                
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    authStatusMessage.textContent = 'Conta criada com sucesso!';
                } catch (error) {
                    authStatusMessage.textContent = `Erro ao criar conta: ${error.message}`;
                    console.error("Erro ao criar conta:", error);
                }
            }
        });

        toggleAuthMode.addEventListener('click', () => {
            isSignInMode = !isSignInMode;
            if (isSignInMode) {
                authModalTitle.textContent = 'Entrar';
                authBtn.textContent = 'Entrar';
                toggleAuthMode.textContent = 'Ainda não tem uma conta? Crie uma.';
                confirmPasswordInput.style.display = 'none';
            } else {
                authModalTitle.textContent = 'Criar Conta';
                authBtn.textContent = 'Criar Conta';
                toggleAuthMode.textContent = 'Já tem uma conta? Entrar.';
                confirmPasswordInput.style.display = 'block';
            }
            authStatusMessage.textContent = '';
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Erro ao sair:", error);
            }
        });

        // Event listener for mode change
        modeSelect.addEventListener('change', () => {
            currentMode = modeSelect.value;
            loadingOverlay.style.display = 'flex';
            filterCardsDueToday();
        });
    </script>
</body>
</html>
